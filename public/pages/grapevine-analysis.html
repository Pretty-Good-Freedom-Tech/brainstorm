<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brainstorm</title>
    <link rel="stylesheet" href="/control/css/grapevine-analysis.css">
    <link rel="stylesheet" href="/control/css/profiles.css">
    <script src="./components/header/header.js"></script>
    <link rel="shortcut icon" href="/control/img/brainstorm010.svg">
    <script src="./components/footer/footer.js"></script>
</head>
<body>
    <!-- Include the header component -->
    <div id="headerContainer"></div>

    <!-- Main content wrapper -->
    <div class="page-content">
        <div class="container">
            <h1>Grapevine Analysis</h1>
            <div class="results-row" style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 6px;">
                <div id="resultsIndicator" style="margin: 10px 0 10px 0; font-weight: bold;"></div>
                <div class="column-panel-controls" style="display: flex; align-items: center; gap: 6px;">
                    <span style="font-weight: 600; font-size: 1.03em; letter-spacing: 0.01em;">Columns</span>
                    <button id="columnSettingsButton" class="secondary" title="Toggle column visibility" style="font-size: 1.06em; padding: 4px 4px; min-width: 32px;">+</button>
                </div>
            </div>
            <div id="columnSettingsPanel" class="panel" style="display: none; margin-bottom: 10px;">
                <h3>Column Visibility</h3>
                <div id="columnToggles"></div>
                <button id="resetColumnDefaultsBtn" class="secondary" style="margin-top: 10px;">Reset Defaults</button>
            </div>
            <div id="tableContainer">
                <div id="loadingIndicator" class="loading"></div>
                <table id="grapevineProfilesTable" style="display: none;">
                    <thead>
                        <tr class="header-row"></tr>
                        <tr class="filter-row"></tr>
                    </thead>
                    <tbody id="grapevineProfilesTableBody"></tbody>
                </table>
                <div id="paginationContainer" class="pagination" style="display: none;"></div>
            </div>
        </div>
    </div>
    
    <!-- Footer container -->
    <div id="footerContainer"></div>
    <script>
    // --- Column Definitions ---
    const grapevineColumns = [
        { id: 'pic', label: 'Pic', visible: true },
        { id: 'pubkey', label: 'Pubkey', visible: true },
        { id: 'hops', label: 'Hops', visible: true },
        { id: 'influence', label: 'Influence', visible: true }
    ];
    let columnVisibility = {};
    function loadColumnVisibility() {
        const saved = localStorage.getItem('grapevineColumnVisibility');
        if (saved) {
            columnVisibility = JSON.parse(saved);
        } else {
            grapevineColumns.forEach(col => { columnVisibility[col.id] = col.visible; });
        }
    }
    function saveColumnVisibility() {
        localStorage.setItem('grapevineColumnVisibility', JSON.stringify(columnVisibility));
    }
    function initColumnToggles() {
        const togglesDiv = document.getElementById('columnToggles');
        togglesDiv.innerHTML = '';
        grapevineColumns.forEach((col, idx) => {
            const label = document.createElement('label');
            label.style.display = 'block';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = columnVisibility[col.id];
            checkbox.addEventListener('change', function() {
                columnVisibility[col.id] = this.checked;
                saveColumnVisibility();
                renderTable();
            });
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(' ' + col.label));
            togglesDiv.appendChild(label);
        });
    }
    function toggleColumnSettingsPanel() {
        const panel = document.getElementById('columnSettingsPanel');
        panel.style.display = (panel.style.display === 'none') ? 'block' : 'none';
    }
    document.getElementById('columnSettingsButton').onclick = toggleColumnSettingsPanel;
    document.getElementById('resetColumnDefaultsBtn').onclick = function() {
        grapevineColumns.forEach(col => { columnVisibility[col.id] = col.visible; });
        saveColumnVisibility();
        renderTable();
    };
    // --- Sorting ---
    let sortBy = 'influence';
    let sortOrder = 'desc';
    function sortData(data) {
        return [...data].sort((a, b) => {
            let valA = a[sortBy], valB = b[sortBy];
            if (typeof valA === 'string') return sortOrder === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
            if (typeof valA === 'number') return sortOrder === 'asc' ? valA - valB : valB - valA;
            return 0;
        });
    }
    // --- Filtering ---
    let filters = { pubkey: '', hops: '', influence: '' };
    function filterData(data) {
        return data.filter(row => {
            return (!filters.pubkey || row.pubkey.includes(filters.pubkey)) &&
                   (!filters.hops || String(row.hops).includes(filters.hops)) &&
                   (!filters.influence || String(row.influence).includes(filters.influence));
        });
    }
    // --- Pagination ---
    const DEFAULT_PAGE_SIZE = 50;
    const PAGE_SIZE_OPTIONS = [25, 50, 100, 200];
    let page = 1;
    let pageSize = DEFAULT_PAGE_SIZE;
    function renderPagination(total, pages) {
        const container = document.getElementById('paginationContainer');
        if (pages <= 1) {
            container.style.display = 'none';
            container.innerHTML = '';
            return;
        }
        container.style.display = '';
        let html = '';
        html += `<span style='margin-right:8px;'>Page</span>`;
        for (let i = 1; i <= pages; i++) {
            html += `<button class='page-btn' data-page='${i}' style='margin-right:2px;${i===page?"font-weight:bold;background:#eee;":''}'>${i}</button>`;
        }
        html += `<span style='margin-left:16px;'>Page Size:</span>`;
        html += `<select id='pageSizeSelect' style='margin-left:4px;'>`;
        PAGE_SIZE_OPTIONS.forEach(opt => {
            html += `<option value='${opt}'${opt===pageSize?' selected':''}>${opt}</option>`;
        });
        html += `</select>`;
        container.innerHTML = html;
        // Add listeners
        Array.from(container.querySelectorAll('.page-btn')).forEach(btn => {
            btn.onclick = function() {
                page = parseInt(this.getAttribute('data-page'));
                renderTable();
            };
        });
        container.querySelector('#pageSizeSelect').onchange = function() {
            pageSize = parseInt(this.value);
            page = 1;
            renderTable();
        };
    }
    // --- Profile Picture Cache (shared pattern) ---
    const profileCache = {};
    function loadProfilePicture(pubkey, imgElement) {
        if (profileCache[pubkey]) {
            imgElement.src = profileCache[pubkey];
            return;
        }
        // Try to fetch kind0 profile (nip05, etc.), fallback to default avatar
        fetch(`/control/api/get-kind0?pubkey=${encodeURIComponent(pubkey)}`)
            .then(r => r.json())
            .then(data => {
                if (data && data.picture) {
                    imgElement.src = data.picture;
                    profileCache[pubkey] = data.picture;
                } else {
                    imgElement.src = '/control/img/default-avatar.svg';
                    profileCache[pubkey] = '/control/img/default-avatar.svg';
                }
            })
            .catch(() => {
                imgElement.src = '/control/img/default-avatar.svg';
                profileCache[pubkey] = '/control/img/default-avatar.svg';
            });
    }
    // --- Table Rendering (with Pagination) ---
    let allProfiles = [];
    function renderTable() {
        const table = document.getElementById('grapevineProfilesTable');
        const headerRow = table.querySelector('.header-row');
        const filterRow = table.querySelector('.filter-row');
        const tbody = document.getElementById('grapevineProfilesTableBody');
        // Build headers
        headerRow.innerHTML = '';
        grapevineColumns.forEach(col => {
            if (!columnVisibility[col.id]) return;
            const th = document.createElement('th');
            th.textContent = col.label;
            if (col.id === 'pic') th.style.width = '44px';
            th.style.cursor = 'pointer';
            th.onclick = function() {
                if (sortBy === col.id) sortOrder = (sortOrder === 'asc' ? 'desc' : 'asc');
                else { sortBy = col.id; sortOrder = 'desc'; }
                renderTable();
            };
            if (sortBy === col.id) th.classList.add('sorted-' + sortOrder);
            headerRow.appendChild(th);
        });
        // Build filter row
        filterRow.innerHTML = '';
        grapevineColumns.forEach(col => {
            if (!columnVisibility[col.id]) return;
            const th = document.createElement('th');
            if (col.id === 'pic') {
                filterRow.appendChild(th); // no filter for pic
                return;
            }
            const input = document.createElement('input');
            input.type = 'text';
            input.value = filters[col.id] || '';
            input.placeholder = 'Filter...';
            input.oninput = function() {
                filters[col.id] = this.value;
                page = 1;
                renderTable();
            };
            th.appendChild(input);
            filterRow.appendChild(th);
        });
        // Sort & filter data
        let rows = filterData(sortData(allProfiles));
        // Pagination
        const total = rows.length;
        const pages = Math.max(1, Math.ceil(total / pageSize));
        if (page > pages) page = pages;
        const start = (page - 1) * pageSize;
        const end = Math.min(start + pageSize, total);
        const pagedRows = rows.slice(start, end);
        // Render body
        tbody.innerHTML = '';
        pagedRows.forEach(row => {
            const tr = document.createElement('tr');
            grapevineColumns.forEach(col => {
                if (!columnVisibility[col.id]) return;
                const td = document.createElement('td');
                if (col.id === 'pic') {
                    const img = document.createElement('img');
                    img.alt = 'profile';
                    img.width = 36; img.height = 36;
                    img.style = 'border-radius:50%;object-fit:cover;background:#eee;';
                    loadProfilePicture(row.pubkey, img);
                    td.appendChild(img);
                } else {
                    td.textContent = row[col.id];
                }
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
        // Show/hide table
        table.style.display = rows.length ? '' : 'none';
        // Update results indicator
        document.getElementById('resultsIndicator').textContent = `Showing ${end-start>0?start+1:0}-${end} of ${total} profiles`;
        document.getElementById('loadingIndicator').style.display = 'none';
        renderPagination(total, pages);
    }
    // --- API Fetch and Initialization ---
    function getQueryParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
    }
    const observer = getQueryParam('observer');
    const observee = getQueryParam('observee');
    const interactionType = getQueryParam('interactionType');
    function isValidPubkey(pubkey) {
        return typeof pubkey === 'string' && pubkey.length >= 32;
    }
    function isValidInteractionType(type) {
        return typeof type === 'string' && type.length > 0;
    }
    function showError(msg) {
        document.getElementById('loadingIndicator').style.display = 'none';
        document.getElementById('resultsIndicator').textContent = msg;
    }
    loadColumnVisibility();
    initColumnToggles();
    document.getElementById('loadingIndicator').style.display = '';
    if (!isValidPubkey(observer) || !isValidPubkey(observee) || !isValidInteractionType(interactionType)) {
        showError('Invalid or missing parameters. Please check the link.');
    } else {
        fetch(`/api/get-grapevine-interaction?observer=${encodeURIComponent(observer)}&observee=${encodeURIComponent(observee)}&interactionType=${encodeURIComponent(interactionType)}`)
            .then(resp => resp.json())
            .then(data => {
                if (data.success && Array.isArray(data.data)) {
                    allProfiles = data.data;
                    renderTable();
                } else {
                    showError('API error: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(err => {
                showError('Network/API error: ' + err);
            });
    }
    </script>
</body>
</html>