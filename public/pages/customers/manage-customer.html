<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Customer - Brainstorm</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="shortcut icon" href="/img/brainstorm010.svg">
    <script src="./components/header/header.js"></script>
    <script src="./components/footer/footer.js"></script>
</head>
<body>
    <!-- Include the header component -->
    <div id="headerContainer"></div>

    <!-- Main content wrapper -->
    <div class="page-content">
        <div class="container">
            <!-- Loading state -->
            <div id="loadingState" class="loading-container">
                <div class="spinner"></div>
                <p>Loading customer data...</p>
            </div>
            
            <!-- Not authorized message -->
            <div id="notAuthorized" class="error-container" style="display: none;">
                <div class="error-icon">üö´</div>
                <h2>Access Denied</h2>
                <p>You are not authorized to view this page. Only the owner can manage customers.</p>
                <a href="/home.html" class="btn btn-primary">Return to Home</a>
            </div>
            
            <!-- Customer not found message -->
            <div id="customerNotFound" class="error-container" style="display: none;">
                <div class="error-icon">üîç</div>
                <h2>Customer Not Found</h2>
                <p>The specified customer could not be found or no pubkey was provided.</p>
                <a href="/manage-customers.html" class="btn btn-primary">Back to Manage Customers</a>
            </div>
            
            <!-- Main content -->
            <div id="mainContent" style="display: none;">
                <!-- Page header with navigation -->
                <div class="page-header">
                    <div class="header-nav">
                        <a href="/manage-customers.html" class="back-link">‚Üê Back to All Customers</a>
                    </div>
                </div>
                
                <!-- Customer profile section -->
                <div class="customer-profile-section">
                    <div class="profile-card">
                        <div class="profile-header">
                            <img id="customerAvatar" src="/img/default-avatar.png" alt="Customer Avatar" class="profile-avatar">
                            <div class="profile-info">
                                <h2 id="customerName" class="customer-name">Loading...</h2>
                                <div id="customerStatus" class="customer-status">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Brainstorm Customer Data Section -->
                <div class="brainstorm-data-section">
                    <h2>Brainstorm Customer Data</h2>
                    
                    <!-- Customer Details -->
                    <div class="data-card">
                        <h3>Customer Details</h3>
                        <div class="data-grid">
                            <div class="data-row">
                                <span class="data-label">Customer ID:</span>
                                <span id="customerId" class="data-value">-</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">Status:</span>
                                <span id="customerStatusDetail" class="data-value">-</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">Directory:</span>
                                <span id="customerDirectory" class="data-value">-</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">Public Key:</span>
                                <span id="customerPubkey" class="data-value pubkey">-</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">Signed Up:</span>
                                <span id="signupDate" class="data-value">Loading...</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">Service Tier:</span>
                                <span id="serviceTier" class="data-value">Loading...</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">Update Interval:</span>
                                <span id="updateInterval" class="data-value">Loading...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Customer Relay Information -->
                    <div class="data-card">
                        <h3>Customer Relay Information</h3>
                        <div class="data-grid">
                            <div class="data-row">
                                <span class="data-label">Relay Status:</span>
                                <span id="relayStatus" class="data-value status-indicator">Loading...</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">Relay Pubkey:</span>
                                <span id="relayPubkey" class="data-value monospace">Loading...</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">Relay Npub:</span>
                                <span id="relayNpub" class="data-value monospace">Loading...</span>
                            </div>
                            <div class="data-row secure-key-row">
                                <span class="data-label">Relay Nsec:</span>
                                <div class="secure-key-container">
                                    <span id="relayNsec" class="data-value monospace secure-key hidden">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                                    <button id="revealNsecBtn" class="btn btn-sm btn-secondary reveal-btn" onclick="toggleSecureKey('nsec')">üëÅÔ∏è Reveal</button>
                                </div>
                            </div>
                            <div class="data-row secure-key-row">
                                <span class="data-label">Relay Privkey:</span>
                                <div class="secure-key-container">
                                    <span id="relayPrivkey" class="data-value monospace secure-key hidden">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                                    <button id="revealPrivkeyBtn" class="btn btn-sm btn-secondary reveal-btn" onclick="toggleSecureKey('privkey')">üëÅÔ∏è Reveal</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- NIP-85 Status -->
                    <div class="data-card">
                        <h3>NIP-85 Status</h3>
                        <div class="data-grid">
                            <div class="data-row">
                                <span class="data-label">Kind 10040 Signed:</span>
                                <span id="kind10040Status" class="data-value status-indicator">Loading...</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">Relay Key Match:</span>
                                <span id="relayKeyMatch" class="data-value status-indicator">Loading...</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">Kind 30382 Count:</span>
                                <span id="kind30382Count" class="data-value">Loading...</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">Last 30382 Published:</span>
                                <span id="lastPublication" class="data-value">Loading...</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">30382 Author Match:</span>
                                <span id="kind30382AuthorMatch" class="data-value status-indicator">Loading...</span>
                            </div>
                        </div>
                        
                        <!-- Raw Kind 10040 Note Viewer (hidden by default) -->
                        <div id="rawNoteSection" class="raw-note-section" style="display: none;">
                            <div class="raw-note-header">
                                <button id="toggleRawNoteBtn" class="toggle-btn" onclick="toggleRawNote()">
                                    <span class="toggle-icon">üëÅÔ∏è</span>
                                    <span class="toggle-text">Show Raw Kind 10040 Note</span>
                                </button>
                            </div>
                            <div id="rawNoteContent" class="raw-note-content" style="display: none;">
                                <pre id="rawNoteData" class="raw-note-data"></pre>
                            </div>
                        </div>
                        
                        <!-- Raw Kind 30382 Note Viewer (hidden by default) -->
                        <div id="raw30382Section" class="raw-note-section" style="display: none;">
                            <div class="raw-note-header">
                                <button id="toggleRaw30382Btn" class="toggle-btn" onclick="toggleRaw30382Note()">
                                    <span class="toggle-icon">üìä</span>
                                    <span class="toggle-text">Show Raw Kind 30382 Note</span>
                                </button>
                            </div>
                            <div id="raw30382Content" class="raw-note-content" style="display: none;">
                                <pre id="raw30382Data" class="raw-note-data"></pre>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Trust Metrics Configuration -->
                    <div class="data-card">
                        <h3>üéõÔ∏è Trust Metrics Configuration</h3>
                        
                        <!-- GrapeRank Preset Configuration -->
                        <div class="config-section">
                            <h4>GrapeRank Algorithm Preset</h4>
                            <div class="preset-status-container">
                                <div class="preset-info">
                                    <div class="data-row">
                                        <span class="data-label">Current Preset:</span>
                                        <span id="graperankPreset" class="preset-badge loading">Loading...</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Configuration File:</span>
                                        <span id="graperankConfigPath" class="config-path">Loading...</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Parameters:</span>
                                        <span id="graperankParameterCount" class="data-value">Loading...</span>
                                    </div>
                                </div>
                                
                                <div class="preset-refresh">
                                    <button id="refreshGraperankBtn" class="btn btn-sm btn-outline">üîÑ Refresh</button>
                                </div>
                            </div>
                            
                            <!-- Preset Update Controls (Owner Only) -->
                            <div id="graperankUpdateControls" class="preset-update-section" style="display: none;">
                                <h5>Update Preset</h5>
                                <div class="preset-options">
                                    <div class="preset-option">
                                        <input type="radio" id="graperankPermissive" name="graperankPreset" value="permissive">
                                        <label for="graperankPermissive">
                                            <strong>Permissive</strong> - Lower thresholds, more inclusive
                                        </label>
                                    </div>
                                    <div class="preset-option">
                                        <input type="radio" id="graperankDefault" name="graperankPreset" value="default">
                                        <label for="graperankDefault">
                                            <strong>Default</strong> - Balanced settings (recommended)
                                        </label>
                                    </div>
                                    <div class="preset-option">
                                        <input type="radio" id="graperankRestrictive" name="graperankPreset" value="restrictive">
                                        <label for="graperankRestrictive">
                                            <strong>Restrictive</strong> - Higher thresholds, more selective
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="preset-update-actions">
                                    <button id="updateGraperankBtn" class="btn btn-primary" disabled>üíæ Update Preset</button>
                                    <button id="cancelGraperankUpdateBtn" class="btn btn-secondary">‚ùå Cancel</button>
                                </div>
                                
                                <div class="preset-warning">
                                    <p><strong>‚ö†Ô∏è Warning:</strong> Changing the preset will update the GrapeRank configuration file and may affect trust metric calculations.</p>
                                </div>
                            </div>
                            
                            <!-- Show/Hide Update Controls Button -->
                            <div class="preset-toggle-section">
                                <button id="toggleGraperankUpdateBtn" class="btn btn-sm btn-outline" style="display: none;">‚öôÔ∏è Update Preset</button>
                            </div>
                        </div>
                        
                        <!-- Whitelist Configuration -->
                        <div class="config-section">
                            <h4>Whitelist Algorithm Preset</h4>
                            <div class="preset-status-container">
                                <div class="preset-info">
                                    <div class="data-row">
                                        <span class="data-label">Current Preset:</span>
                                        <span id="whitelistPreset" class="preset-badge loading">Loading...</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Configuration File:</span>
                                        <span id="whitelistConfigPath" class="config-path">Loading...</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Parameters:</span>
                                        <span id="whitelistParameterCount" class="data-value">Loading...</span>
                                    </div>
                                </div>
                                
                                <div class="preset-refresh">
                                    <button id="refreshWhitelistBtn" class="btn btn-sm btn-outline">üîÑ Refresh</button>
                                </div>
                            </div>
                            
                            <!-- Preset Update Controls (Owner Only) -->
                            <div id="whitelistUpdateControls" class="preset-update-section" style="display: none;">
                                <h5>Update Preset</h5>
                                <div class="preset-options">
                                    <div class="preset-option">
                                        <input type="radio" id="whitelistPermissive" name="whitelistPreset" value="permissive">
                                        <label for="whitelistPermissive">
                                            <strong>Permissive</strong> - More inclusive whitelist criteria
                                        </label>
                                    </div>
                                    <div class="preset-option">
                                        <input type="radio" id="whitelistDefault" name="whitelistPreset" value="default">
                                        <label for="whitelistDefault">
                                            <strong>Default</strong> - Balanced whitelist settings
                                        </label>
                                    </div>
                                    <div class="preset-option">
                                        <input type="radio" id="whitelistRestrictive" name="whitelistPreset" value="restrictive">
                                        <label for="whitelistRestrictive">
                                            <strong>Restrictive</strong> - Stricter whitelist criteria
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="preset-update-actions">
                                    <button id="updateWhitelistBtn" class="btn btn-primary" disabled>üíæ Update Preset</button>
                                    <button id="cancelWhitelistUpdateBtn" class="btn btn-secondary">‚ùå Cancel</button>
                                </div>
                                
                                <div class="preset-warning">
                                    <p><strong>‚ö†Ô∏è Warning:</strong> Changing the preset will update the whitelist configuration file and may affect trust metric calculations.</p>
                                </div>
                            </div>
                            
                            <!-- Show/Hide Update Controls Button -->
                            <div class="preset-toggle-section">
                                <button id="toggleWhitelistUpdateBtn" class="btn btn-sm btn-outline" style="display: none;">‚öôÔ∏è Update Preset</button>
                            </div>
                        </div>
                        
                        <!-- Blacklist Configuration -->
                        <div class="config-section">
                            <h4>Blacklist Algorithm Preset</h4>
                            <div class="preset-status-container">
                                <div class="preset-info">
                                    <div class="data-row">
                                        <span class="data-label">Current Preset:</span>
                                        <span id="blacklistPreset" class="preset-badge loading">Loading...</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Configuration File:</span>
                                        <span id="blacklistConfigPath" class="config-path">Loading...</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Parameters:</span>
                                        <span id="blacklistParameterCount" class="data-value">Loading...</span>
                                    </div>
                                </div>
                                
                                <div class="preset-refresh">
                                    <button id="refreshBlacklistBtn" class="btn btn-sm btn-outline">üîÑ Refresh</button>
                                </div>
                            </div>
                            
                            <!-- Preset Update Controls (Owner Only) -->
                            <div id="blacklistUpdateControls" class="preset-update-section" style="display: none;">
                                <h5>Update Preset</h5>
                                <div class="preset-options">
                                    <div class="preset-option">
                                        <input type="radio" id="blacklistPermissive" name="blacklistPreset" value="permissive">
                                        <label for="blacklistPermissive">
                                            <strong>Permissive</strong> - More lenient blacklist criteria
                                        </label>
                                    </div>
                                    <div class="preset-option">
                                        <input type="radio" id="blacklistDefault" name="blacklistPreset" value="default">
                                        <label for="blacklistDefault">
                                            <strong>Default</strong> - Balanced blacklist settings
                                        </label>
                                    </div>
                                    <div class="preset-option">
                                        <input type="radio" id="blacklistRestrictive" name="blacklistPreset" value="restrictive">
                                        <label for="blacklistRestrictive">
                                            <strong>Restrictive</strong> - Stricter blacklist criteria
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="preset-update-actions">
                                    <button id="updateBlacklistBtn" class="btn btn-primary" disabled>üíæ Update Preset</button>
                                    <button id="cancelBlacklistUpdateBtn" class="btn btn-secondary">‚ùå Cancel</button>
                                </div>
                                
                                <div class="preset-warning">
                                    <p><strong>‚ö†Ô∏è Warning:</strong> Changing the preset will update the blacklist configuration file and may affect trust metric calculations.</p>
                                </div>
                            </div>
                            
                            <!-- Show/Hide Update Controls Button -->
                            <div class="preset-toggle-section">
                                <button id="toggleBlacklistUpdateBtn" class="btn btn-sm btn-outline" style="display: none;">‚öôÔ∏è Update Preset</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Trust Metrics Status -->
                    <div class="data-card">
                        <h3>Trust Metrics Calculation Status</h3>
                        
                        <!-- Process All Trust Metrics Status -->
                        <div class="calculation-status-section">
                            <div class="calculation-header">
                                <h4>üöÄ Process All Trust Metrics</h4>
                                <div class="calculation-actions">
                                    <button id="refreshProcessAllTrustMetricsBtn" class="btn btn-sm btn-outline">üîÑ Refresh</button>
                                    <button id="triggerProcessAllTrustMetricsBtn" class="btn btn-sm btn-primary" disabled>‚ñ∂Ô∏è Trigger</button>
                                </div>
                            </div>
                            <div class="calculation-details">
                                <div class="status-row">
                                    <span class="status-label">Status:</span>
                                    <span id="processAllTrustMetricsStatus" class="status-badge status-unknown">Loading...</span>
                                </div>
                                <div class="status-row">
                                    <span class="status-label">Last Run:</span>
                                    <span id="processAllTrustMetricsLastRun" class="status-value">Loading...</span>
                                </div>
                                <div id="processAllTrustMetricsDurationRow" class="status-row" style="display: none;">
                                    <span class="status-label">Duration:</span>
                                    <span id="processAllTrustMetricsDuration" class="status-value">-</span>
                                </div>
                                <div id="processAllTrustMetricsInactivityRow" class="status-row" style="display: none;">
                                    <span class="status-label">Last Activity:</span>
                                    <span id="processAllTrustMetricsInactivity" class="status-value">-</span>
                                </div>
                                <div class="status-row">
                                    <span class="status-label">Log File:</span>
                                    <span id="processAllTrustMetricsLogFile" class="status-value log-path">Loading...</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hops Calculation Status -->
                        <div class="calculation-status-section">
                            <h4>üîó Hops Calculation</h4>
                            <div class="calculation-details">
                                <div class="status-row">
                                    <span class="status-label">Status:</span>
                                    <span id="hopsStatus" class="status-badge loading">Loading...</span>
                                </div>
                                <div class="status-row">
                                    <span class="status-label">Last Run:</span>
                                    <span id="hopsLastRun" class="status-value">Loading...</span>
                                </div>
                                <div class="status-row" id="hopsDurationRow" style="display: none;">
                                    <span class="status-label">Duration:</span>
                                    <span id="hopsDuration" class="status-value">-</span>
                                </div>
                                <div class="status-row" id="hopsInactivityRow" style="display: none;">
                                    <span class="status-label">Last Activity:</span>
                                    <span id="hopsInactivity" class="status-value">-</span>
                                </div>
                                <div class="status-row">
                                    <span class="status-label">Log File:</span>
                                    <span id="hopsLogFile" class="status-value log-path">-</span>
                                </div>
                            </div>
                            <div class="calculation-actions">
                                <button id="refreshHopsBtn" class="btn btn-sm btn-outline">üîÑ Refresh</button>
                                <button id="triggerHopsBtn" class="btn btn-sm btn-primary" disabled>‚ñ∂Ô∏è Trigger Calculation</button>
                            </div>
                        </div>
                        
                        <!-- PersonalizedPageRank Calculation Status -->
                        <div class="calculation-status-section">
                            <h4>üìä PersonalizedPageRank Calculation</h4>
                            <div class="calculation-details">
                                <div class="status-row">
                                    <span class="status-label">Status:</span>
                                    <span id="pageRankStatus" class="status-badge loading">Loading...</span>
                                </div>
                                <div class="status-row">
                                    <span class="status-label">Last Run:</span>
                                    <span id="pageRankLastRun" class="status-value">Loading...</span>
                                </div>
                                <div class="status-row" id="pageRankDurationRow" style="display: none;">
                                    <span class="status-label">Duration:</span>
                                    <span id="pageRankDuration" class="status-value">-</span>
                                </div>
                                <div class="status-row" id="pageRankInactivityRow" style="display: none;">
                                    <span class="status-label">Last Activity:</span>
                                    <span id="pageRankInactivity" class="status-value">-</span>
                                </div>
                                <div class="status-row">
                                    <span class="status-label">Log File:</span>
                                    <span id="pageRankLogFile" class="status-value log-path">-</span>
                                </div>
                            </div>
                            <div class="calculation-actions">
                                <button id="refreshPageRankBtn" class="btn btn-sm btn-outline">üîÑ Refresh</button>
                                <button id="triggerPageRankBtn" class="btn btn-sm btn-primary" disabled>‚ñ∂Ô∏è Trigger Calculation</button>
                            </div>
                        </div>
                        
                        <!-- PersonalizedGrapeRank Calculation Status -->
                        <div class="calculation-status-section">
                            <h4>üçá PersonalizedGrapeRank Calculation</h4>
                            <div class="calculation-details">
                                <div class="status-row">
                                    <span class="status-label">Status:</span>
                                    <span id="grapeRankStatus" class="status-badge loading">Loading...</span>
                                </div>
                                <div class="status-row">
                                    <span class="status-label">Last Run:</span>
                                    <span id="grapeRankLastRun" class="status-value">Loading...</span>
                                </div>
                                <div class="status-row" id="grapeRankDurationRow" style="display: none;">
                                    <span class="status-label">Duration:</span>
                                    <span id="grapeRankDuration" class="status-value">-</span>
                                </div>
                                <div class="status-row" id="grapeRankInactivityRow" style="display: none;">
                                    <span class="status-label">Last Activity:</span>
                                    <span id="grapeRankInactivity" class="status-value">-</span>
                                </div>
                                <div class="status-row">
                                    <span class="status-label">Log File:</span>
                                    <span id="grapeRankLogFile" class="status-value log-path">-</span>
                                </div>
                            </div>
                            <div class="calculation-actions">
                                <button id="refreshGrapeRankBtn" class="btn btn-sm btn-outline">üîÑ Refresh</button>
                                <button id="triggerGrapeRankBtn" class="btn btn-sm btn-primary" disabled>‚ñ∂Ô∏è Trigger Calculation</button>
                            </div>
                        </div>
                        
                        <!-- Analyze Follows, Mutes, and Reports Status -->
                        <div class="calculation-status-section">
                            <div class="calculation-header">
                                <h4>üîç Analyze Follows, Mutes, and Reports</h4>
                                <div class="calculation-actions">
                                    <button id="refreshAnalyzeFollowsMutesReportsBtn" class="btn btn-sm btn-outline">üîÑ Refresh</button>
                                    <button id="triggerAnalyzeFollowsMutesReportsBtn" class="btn btn-sm btn-primary" disabled>‚ñ∂Ô∏è Trigger</button>
                                </div>
                            </div>
                            <div class="calculation-details">
                                <div class="status-row">
                                    <span class="status-label">Status:</span>
                                    <span id="analyzeFollowsMutesReportsStatus" class="status-badge status-unknown">Loading...</span>
                                </div>
                                <div class="status-row">
                                    <span class="status-label">Last Run:</span>
                                    <span id="analyzeFollowsMutesReportsLastRun" class="status-value">Loading...</span>
                                </div>
                                <div id="analyzeFollowsMutesReportsDurationRow" class="status-row" style="display: none;">
                                    <span class="status-label">Duration:</span>
                                    <span id="analyzeFollowsMutesReportsDuration" class="status-value">-</span>
                                </div>
                                <div id="analyzeFollowsMutesReportsInactivityRow" class="status-row" style="display: none;">
                                    <span class="status-label">Last Activity:</span>
                                    <span id="analyzeFollowsMutesReportsInactivity" class="status-value">-</span>
                                </div>
                                <div class="status-row">
                                    <span class="status-label">Log File:</span>
                                    <span id="analyzeFollowsMutesReportsLogFile" class="status-value log-path">Loading...</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Kind 30382 Export Calculation Status -->
                        <div class="calculation-status-section">
                            <div class="calculation-header">
                                <h4>üì§ Kind 30382 Export</h4>
                                <div class="calculation-actions">
                                    <button id="refreshKind30382ExportBtn" class="btn btn-sm btn-outline">üîÑ Refresh</button>
                                    <button id="triggerKind30382ExportBtn" class="btn btn-sm btn-primary" disabled>‚ñ∂Ô∏è Trigger</button>
                                </div>
                            </div>
                            <div class="calculation-details">
                                <div class="status-row">
                                    <span class="status-label">Status:</span>
                                    <span id="kind30382ExportStatus" class="status-badge status-unknown">Loading...</span>
                                </div>
                                <div class="status-row">
                                    <span class="status-label">Last Run:</span>
                                    <span id="kind30382ExportLastRun" class="status-value">Loading...</span>
                                </div>
                                <div id="kind30382ExportDurationRow" class="status-row" style="display: none;">
                                    <span class="status-label">Duration:</span>
                                    <span id="kind30382ExportDuration" class="status-value">-</span>
                                </div>
                                <div id="kind30382ExportInactivityRow" class="status-row" style="display: none;">
                                    <span class="status-label">Last Activity:</span>
                                    <span id="kind30382ExportInactivity" class="status-value">-</span>
                                </div>
                                <div class="status-row">
                                    <span class="status-label">Log File:</span>
                                    <span id="kind30382ExportLogFile" class="status-value log-path">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Management Actions Section -->
                <div class="management-actions-section">
                    <h2>Management Actions</h2>
                    
                    <!-- Status Management -->
                    <div class="action-card">
                        <h3>Customer Status</h3>
                        <div class="action-content">
                            <p>Current status: <span id="currentStatusDisplay" class="status-badge">Loading...</span></p>
                            <div class="action-buttons">
                                <button id="activateBtn" class="btn btn-success" onclick="changeCustomerStatus('active')">
                                    ‚úÖ Activate Customer
                                </button>
                                <button id="deactivateBtn" class="btn btn-warning" onclick="changeCustomerStatus('inactive')">
                                    ‚è∏Ô∏è Deactivate Customer
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Trust Metrics Actions -->
                    <div class="action-card">
                        <h3>Trust Metrics Recalculation</h3>
                        <div class="action-content">
                            <p>Trigger recalculation of trust metrics for this customer.</p>
                            <div class="action-buttons">
                                <button class="btn btn-primary" onclick="recalculateMetric('hops')">
                                    üîÑ Recalculate Hops
                                </button>
                                <button class="btn btn-primary" onclick="recalculateMetric('pagerank')">
                                    üîÑ Recalculate PageRank
                                </button>
                                <button class="btn btn-primary" onclick="recalculateMetric('graperank')">
                                    üîÑ Recalculate GrapeRank
                                </button>
                                <button class="btn btn-info" onclick="exportKind30382()">
                                    üì§ Export Kind 30382
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Communication Actions -->
                    <div class="action-card">
                        <h3>Customer Communication</h3>
                        <div class="action-content">
                            <p>Send automated messages to the customer via their relay.</p>
                            <div class="action-buttons">
                                <button class="btn btn-info" onclick="sendKind10040Reminder()">
                                    üì® Send Kind 10040 Reminder
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Danger Zone -->
                    <div class="action-card danger-zone">
                        <h3>‚ö†Ô∏è Danger Zone</h3>
                        <div class="action-content">
                            <p class="danger-warning">These actions are irreversible. Proceed with extreme caution.</p>
                            <div class="action-buttons">
                                <button class="btn btn-danger" onclick="deleteCustomer()">
                                    üóëÔ∏è DELETE Customer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Include the footer component -->
    <div id="footerContainer"></div>
    
    <script>
        let customerPubkey = '';
        let customerData = null;
        let userClassification = null;
        let profileData = null;
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            // Extract pubkey from URL
            const urlParams = new URLSearchParams(window.location.search);
            customerPubkey = urlParams.get('pubkey');
            
            if (!customerPubkey) {
                showCustomerNotFound();
                return;
            }
            
            await checkAuthAndLoadCustomer();
        });
        
        async function checkAuthAndLoadCustomer() {
            try {
                // Check if user is owner
                const classificationResponse = await fetch('/api/auth/user-classification');
                const classificationData = await classificationResponse.json();
                
                // Store user classification globally
                if (classificationData.success) {
                    userClassification = classificationData.classification;
                }
                
                if (!classificationData.success || classificationData.classification !== 'owner') {
                    showNotAuthorized();
                    return;
                }
                
                // User is owner, load customer
                await loadCustomerData();
                
            } catch (error) {
                console.error('Error checking authorization:', error);
                showNotAuthorized();
            }
        }
        
        function showNotAuthorized() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('notAuthorized').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
        }
        
        function showCustomerNotFound() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('customerNotFound').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
        }
        
        async function loadCustomerData() {
            try {
                // Load customer data and profile data in parallel
                const [customerResponse, profileResponse] = await Promise.all([
                    fetch(`/api/get-customer?pubkey=${customerPubkey}`),
                    fetch(`/api/get-kind0?pubkey=${customerPubkey}`)
                ]);
                
                // Process customer data from new endpoint
                const customerResponseData = await customerResponse.json();
                if (customerResponseData.success && customerResponseData.customer) {
                    customerData = customerResponseData.customer;
                }
                
                // Process profile data
                const profileResponseData = await profileResponse.json();
                if (profileResponseData.success && profileResponseData.data && profileResponseData.data.content) {
                    try {
                        profileData = JSON.parse(profileResponseData.data.content);
                    } catch (e) {
                        console.error('Error parsing profile data:', e);
                        profileData = null;
                    }
                }
                
                if (!customerData) {
                    showCustomerNotFound();
                    return;
                }
                
                // Show main content and populate data
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                
                populateCustomerData();
                
            } catch (error) {
                console.error('Error loading customer data:', error);
                showError('Failed to load customer data: ' + error.message);
            }
        }
        
        function populateCustomerData() {
            // Update page title
            const displayName = profileData?.name || customerData.name || 'Unknown Customer';
            
            // Populate profile header
            const avatar = profileData?.picture || '/img/default-avatar.png';
            document.getElementById('customerAvatar').src = avatar;
            document.getElementById('customerAvatar').onerror = function() { this.src = '/img/default-avatar.png'; };
            
            document.getElementById('customerName').textContent = displayName;
            
            const statusElement = document.getElementById('customerStatus');
            statusElement.textContent = customerData.status.toUpperCase();
            statusElement.className = `customer-status status-${customerData.status}`;
            
            // Populate customer details
            document.getElementById('customerId').textContent = customerData.id || '-';
            document.getElementById('customerStatusDetail').textContent = customerData.status || '-';
            document.getElementById('customerDirectory').textContent = customerData.directory || '-';
            document.getElementById('customerPubkey').textContent = customerData.pubkey || '-';
            
            // Populate Brainstorm-specific data (placeholders for now)
            populateBrainstormData();
        }
        
        /**
         * Format Unix timestamp to human readable date
         * @param {number} timestamp - Unix timestamp in seconds
         * @returns {string} Formatted date string
         */
        function formatSignupDate(timestamp) {
            if (!timestamp || timestamp === 0) {
                return 'Unknown';
            }
            
            const date = new Date(timestamp * 1000); // Convert to milliseconds
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        /**
         * Format update interval in seconds to human readable format
         * @param {number} seconds - Update interval in seconds
         * @returns {string} Human readable interval
         */
        function formatUpdateInterval(seconds) {
            if (!seconds || seconds === 0) {
                return 'Unknown';
            }
            
            const intervals = [
                { label: 'month', value: 30 * 24 * 60 * 60 },
                { label: 'week', value: 7 * 24 * 60 * 60 },
                { label: 'day', value: 24 * 60 * 60 },
                { label: 'hour', value: 60 * 60 },
                { label: 'minute', value: 60 }
            ];
            
            for (const interval of intervals) {
                const count = Math.floor(seconds / interval.value);
                if (count >= 1) {
                    return `${count} ${interval.label}${count > 1 ? 's' : ''}`;
                }
            }
            
            return `${seconds} second${seconds > 1 ? 's' : ''}`;
        }
        
        /**
         * Format service tier for display
         * @param {string} tier - Service tier
         * @returns {string} Formatted tier
         */
        function formatServiceTier(tier) {
            if (!tier) {
                return 'Unknown';
            }
            
            // Capitalize first letter
            return tier.charAt(0).toUpperCase() + tier.slice(1);
        }
        
        function populateBrainstormData() {
            // Load Customer Relay Information
            loadCustomerRelayKeys();
            
            // Populate subscription information if available
            if (customerData && customerData.subscription) {
                const subscription = customerData.subscription;
                
                // Format and display signup date
                const signupDate = formatSignupDate(subscription.when_signed_up);
                document.getElementById('signupDate').textContent = signupDate;
                
                // Format and display service tier
                const serviceTier = formatServiceTier(subscription.service_tier);
                document.getElementById('serviceTier').textContent = serviceTier;
                
                // Format and display update interval
                const updateInterval = formatUpdateInterval(subscription.update_interval);
                document.getElementById('updateInterval').textContent = updateInterval;
            } else {
                // Fallback if subscription data is not available
                document.getElementById('signupDate').textContent = 'Unknown';
                document.getElementById('serviceTier').textContent = 'Unknown';
                document.getElementById('updateInterval').textContent = 'Unknown';
            }
            
            // Load real NIP-85 Status data
            loadKind10040Status();
            loadKind30382Status();
            
            // Trust Metrics Configuration will be loaded by generalized system
            
            // Load Trust Metrics Calculation Status
            loadProcessAllTrustMetricsCalculationStatus();
            loadHopsCalculationStatus();
            loadPageRankCalculationStatus();
            loadGrapeRankCalculationStatus();
            loadAnalyzeFollowsMutesReportsCalculationStatus();
            loadKind30382ExportCalculationStatus();
            
            // Load Trust Metrics Configuration
            loadGrapeRankPresetConfig();
            
            // Load whitelist and blacklist configuration presets
            loadConfigPreset('whitelist');
            loadConfigPreset('blacklist');
            
            // Update status display in management section
            const statusDisplay = document.getElementById('currentStatusDisplay');
            statusDisplay.textContent = customerData.status.toUpperCase();
            statusDisplay.className = `status-badge status-${customerData.status}`;
            
            // Update action buttons based on current status
            updateActionButtons();
        }
        
        /**
         * Load Kind 10040 status from API and update UI
         */
        async function loadKind10040Status() {
            try {
                // Set loading state
                document.getElementById('kind10040Status').innerHTML = '<span class="status-loading">‚è≥ Loading...</span>';
                document.getElementById('relayKeyMatch').innerHTML = '<span class="status-loading">‚è≥ Loading...</span>';
                
                // Make API call to get Kind 10040 info
                const response = await fetch(`/api/get-kind10040-info?pubkey=${customerPubkey}`);
                const result = await response.json();
                
                if (result.success) {
                    // Update Kind 10040 status
                    updateKind10040Display(result);
                } else {
                    // Handle API error
                    document.getElementById('kind10040Status').innerHTML = '<span class="status-error">‚ùå Error loading</span>';
                    document.getElementById('relayKeyMatch').innerHTML = '<span class="status-error">‚ùå Error loading</span>';
                    console.error('Kind 10040 API error:', result.message);
                }
                
            } catch (error) {
                // Handle network error
                document.getElementById('kind10040Status').innerHTML = '<span class="status-error">‚ùå Network error</span>';
                document.getElementById('relayKeyMatch').innerHTML = '<span class="status-error">‚ùå Network error</span>';
                console.error('Error loading Kind 10040 status:', error);
            }
        }
        
        /**
         * Load Kind 30382 status from API and update UI
         */
        async function loadKind30382Status() {
            try {
                // Set loading state
                document.getElementById('kind30382Count').innerHTML = '<span class="status-loading">‚è≥ Loading...</span>';
                document.getElementById('lastPublication').innerHTML = '<span class="status-loading">‚è≥ Loading...</span>';
                document.getElementById('kind30382AuthorMatch').innerHTML = '<span class="status-loading">‚è≥ Loading...</span>';
                
                // Make API call to get Kind 30382 info
                const response = await fetch(`/api/get-kind30382-info?pubkey=${customerPubkey}`);
                const result = await response.json();
                
                if (result.success) {
                    // Update Kind 30382 status
                    updateKind30382Display(result);
                } else {
                    // Handle API error
                    document.getElementById('kind30382Count').innerHTML = '<span class="status-error">‚ùå Error loading</span>';
                    document.getElementById('lastPublication').innerHTML = '<span class="status-error">‚ùå Error loading</span>';
                    document.getElementById('kind30382AuthorMatch').innerHTML = '<span class="status-error">‚ùå Error loading</span>';
                    console.error('Kind 30382 API error:', result.message);
                }
                
            } catch (error) {
                // Handle network error
                document.getElementById('kind30382Count').innerHTML = '<span class="status-error">‚ùå Network error</span>';
                document.getElementById('lastPublication').innerHTML = '<span class="status-error">‚ùå Network error</span>';
                document.getElementById('kind30382AuthorMatch').innerHTML = '<span class="status-error">‚ùå Network error</span>';
                console.error('Error loading Kind 30382 status:', error);
            }
        }
        
        /**
         * Update Kind 10040 display elements with API data
         */
        function updateKind10040Display(data) {
            // Update Kind 10040 status based on whether event exists
            const kind10040Element = document.getElementById('kind10040Status');
            const rawNoteSection = document.getElementById('rawNoteSection');
            
            if (data.latestEvent && data.eventId) {
                // Event exists - show success status with timestamp
                const timestamp = data.timestamp ? new Date(data.timestamp * 1000).toLocaleString() : 'Unknown';
                kind10040Element.innerHTML = `
                    <span class="status-success">‚úÖ Published</span>
                    <div class="status-details">
                        <small>Event ID: ${data.eventId.substring(0, 8)}...</small><br>
                        <small>Published: ${timestamp}</small>
                    </div>
                `;
                
                // Show raw note section and populate with event data
                rawNoteSection.style.display = 'block';
                populateRawNoteData(data.latestEvent);
            } else {
                // No event found
                kind10040Element.innerHTML = '<span class="status-warning">‚ö†Ô∏è Not published</span>';
                
                // Hide raw note section when no event exists
                rawNoteSection.style.display = 'none';
            }
            
            // Update relay key match status
            updateRelayKeyMatchStatus(data);
            
            console.log('Kind 10040 status updated:', data);
        }
        
        /**
         * Populate the raw note data viewer with formatted Kind 10040 event
         * @param {Object} eventData - The Kind 10040 event data
         */
        function populateRawNoteData(eventData) {
            const rawNoteDataElement = document.getElementById('rawNoteData');
            
            if (!eventData) {
                rawNoteDataElement.textContent = 'No event data available';
                return;
            }
            
            // Format the event data as pretty-printed JSON
            try {
                const formattedData = JSON.stringify(eventData, null, 2);
                rawNoteDataElement.textContent = formattedData;
            } catch (error) {
                console.error('Error formatting Kind 10040 event data:', error);
                rawNoteDataElement.textContent = 'Error formatting event data: ' + error.message;
            }
        }
        
        /**
         * Update Kind 30382 display elements with API data
         * @param {Object} data - Data from /api/get-kind30382-info
         */
        function updateKind30382Display(data) {
            const raw30382Section = document.getElementById('raw30382Section');
            
            // Update count
            const countElement = document.getElementById('kind30382Count');
            if (data.count !== undefined) {
                if (data.count === 0) {
                    countElement.innerHTML = '<span class="status-warning">‚ö†Ô∏è None published</span>';
                } else {
                    countElement.innerHTML = `<span class="status-success">‚úÖ ${data.count.toLocaleString()} events</span>`;
                }
            } else {
                countElement.innerHTML = '<span class="status-error">‚ùå Unknown</span>';
            }
            
            // Update last publication timestamp
            const lastPubElement = document.getElementById('lastPublication');
            if (data.timestamp && data.count > 0) {
                const timestamp = new Date(data.timestamp * 1000);
                const timeAgo = getTimeAgo(timestamp);
                lastPubElement.innerHTML = `
                    <span class="status-success">‚úÖ ${timeAgo}</span>
                    <div class="status-details">
                        <small>${timestamp.toLocaleString()}</small>
                    </div>
                `;
            } else if (data.count === 0) {
                lastPubElement.innerHTML = '<span class="status-na">‚ûñ N/A (none published)</span>';
            } else {
                lastPubElement.innerHTML = '<span class="status-error">‚ùå Unknown</span>';
            }
            
            // Update author match status and show/hide raw note section
            if (data.latestEvent && data.count > 0) {
                // Show raw note section and populate with event data
                raw30382Section.style.display = 'block';
                populateRaw30382Data(data.latestEvent);
                
                // Check author match
                updateKind30382AuthorMatch(data.latestEvent);
            } else {
                // Hide raw note section when no events exist
                raw30382Section.style.display = 'none';
                
                // Set author match to N/A
                const authorMatchElement = document.getElementById('kind30382AuthorMatch');
                authorMatchElement.innerHTML = '<span class="status-na">‚ûñ N/A (no events)</span>';
            }
            
            console.log('Kind 30382 status updated:', data);
        }
        
        /**
         * Populate the raw Kind 30382 data viewer with formatted event
         * @param {Object} eventData - The Kind 30382 event data
         */
        function populateRaw30382Data(eventData) {
            const raw30382DataElement = document.getElementById('raw30382Data');
            
            if (!eventData) {
                raw30382DataElement.textContent = 'No event data available';
                return;
            }
            
            // Format the event data as pretty-printed JSON
            try {
                const formattedData = JSON.stringify(eventData, null, 2);
                raw30382DataElement.textContent = formattedData;
            } catch (error) {
                console.error('Error formatting Kind 30382 event data:', error);
                raw30382DataElement.textContent = 'Error formatting event data: ' + error.message;
            }
        }
        
        /**
         * Update Kind 30382 author match status by comparing event author with customer relay pubkey
         * @param {Object} eventData - The Kind 30382 event data
         */
        function updateKind30382AuthorMatch(eventData) {
            const authorMatchElement = document.getElementById('kind30382AuthorMatch');
            
            // Check if we have customer relay keys data
            if (!relayKeysData || !relayKeysData.pubkey) {
                authorMatchElement.innerHTML = '<span class="status-warning">‚ö†Ô∏è No customer relay keys</span>';
                return;
            }
            
            // Check if we have event data with author
            if (!eventData || !eventData.pubkey) {
                authorMatchElement.innerHTML = '<span class="status-warning">‚ö†Ô∏è No event author</span>';
                return;
            }
            
            // Compare the pubkeys
            const customerRelayPubkey = relayKeysData.pubkey;
            const eventAuthorPubkey = eventData.pubkey;
            const isMatch = eventAuthorPubkey === customerRelayPubkey;
            
            if (isMatch) {
                authorMatchElement.innerHTML = `
                    <span class="status-success">‚úÖ Author Matches</span>
                    <div class="status-details">
                        <small>Pubkey: ${customerRelayPubkey.substring(0, 8)}...${customerRelayPubkey.substring(-8)}</small>
                    </div>
                `;
            } else {
                authorMatchElement.innerHTML = `
                    <span class="status-error">‚ùå Author Mismatch</span>
                    <div class="status-details">
                        <small>Customer: ${customerRelayPubkey.substring(0, 8)}...${customerRelayPubkey.substring(-8)}</small><br>
                        <small>Event Author: ${eventAuthorPubkey.substring(0, 8)}...${eventAuthorPubkey.substring(-8)}</small>
                    </div>
                `;
            }
            
            console.log('Kind 30382 author comparison:', {
                customerRelayPubkey,
                eventAuthorPubkey,
                isMatch
            });
        }
        
        /**
         * Get human-readable time ago string
         * @param {Date} date - The date to compare
         * @returns {string} Human-readable time ago
         */
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffSeconds = Math.floor(diffMs / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffSeconds < 60) {
                return `${diffSeconds} second${diffSeconds !== 1 ? 's' : ''} ago`;
            } else if (diffMinutes < 60) {
                return `${diffMinutes} minute${diffMinutes !== 1 ? 's' : ''} ago`;
            } else if (diffHours < 24) {
                return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
            } else if (diffDays < 30) {
                return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
            } else {
                const diffMonths = Math.floor(diffDays / 30);
                return `${diffMonths} month${diffMonths !== 1 ? 's' : ''} ago`;
            }
        }
        
        /**
         * Extract relay pubkey from Kind 10040 event tags
         * Looks for tag with "30382:rank" as first element and extracts pubkey as second element
         * @param {Object} eventData - The Kind 10040 event data
         * @returns {string|null} The relay pubkey or null if not found
         */
        function extractRelayPubkeyFromKind10040(eventData) {
            if (!eventData || !eventData.tags || !Array.isArray(eventData.tags)) {
                return null;
            }
            
            // Look for tag with "30382:rank" as first element
            const relayTag = eventData.tags.find(tag => 
                Array.isArray(tag) && 
                tag.length >= 2 && 
                tag[0] === '30382:rank'
            );
            
            if (relayTag && relayTag[1]) {
                return relayTag[1]; // Second element is the pubkey
            }
            
            return null;
        }
        
        /**
         * Update relay key match status by comparing Kind 10040 relay pubkey with customer relay pubkey
         * @param {Object} kind10040Data - Data from /api/get-kind10040-info
         */
        function updateRelayKeyMatchStatus(kind10040Data) {
            const relayKeyElement = document.getElementById('relayKeyMatch');
            
            // Check if we have Kind 10040 event data
            if (!kind10040Data || !kind10040Data.latestEvent) {
                relayKeyElement.innerHTML = '<span class="status-na">‚ûñ N/A (no Kind 10040 event)</span>';
                return;
            }
            
            // Check if we have customer relay keys data
            if (!relayKeysData || !relayKeysData.pubkey) {
                relayKeyElement.innerHTML = '<span class="status-warning">‚ö†Ô∏è No customer relay keys</span>';
                return;
            }
            
            // Extract relay pubkey from Kind 10040 event
            const kind10040RelayPubkey = extractRelayPubkeyFromKind10040(kind10040Data.latestEvent);
            
            if (!kind10040RelayPubkey) {
                relayKeyElement.innerHTML = '<span class="status-warning">‚ö†Ô∏è No relay pubkey in Kind 10040</span>';
                return;
            }
            
            // Compare the pubkeys
            const customerRelayPubkey = relayKeysData.pubkey;
            const isMatch = kind10040RelayPubkey === customerRelayPubkey;
            
            if (isMatch) {
                relayKeyElement.innerHTML = `
                    <span class="status-success">‚úÖ Keys Match</span>
                    <div class="status-details">
                        <small>Pubkey: ${customerRelayPubkey.substring(0, 8)}...${customerRelayPubkey.substring(-8)}</small>
                    </div>
                `;
            } else {
                relayKeyElement.innerHTML = `
                    <span class="status-error">‚ùå Keys Don't Match</span>
                    <div class="status-details">
                        <small>Customer: ${customerRelayPubkey.substring(0, 8)}...${customerRelayPubkey.substring(-8)}</small><br>
                        <small>Kind 10040: ${kind10040RelayPubkey.substring(0, 8)}...${kind10040RelayPubkey.substring(-8)}</small>
                    </div>
                `;
            }
            
            console.log('Relay key comparison:', {
                customerRelayPubkey,
                kind10040RelayPubkey,
                isMatch
            });
        }
        
        /**
         * Toggle the visibility of the raw Kind 10040 note viewer
         */
        function toggleRawNote() {
            const rawNoteContent = document.getElementById('rawNoteContent');
            const toggleBtn = document.getElementById('toggleRawNoteBtn');
            const toggleText = toggleBtn.querySelector('.toggle-text');
            const toggleIcon = toggleBtn.querySelector('.toggle-icon');
            
            const isCurrentlyVisible = rawNoteContent.style.display !== 'none';
            
            if (isCurrentlyVisible) {
                // Hide the raw note
                rawNoteContent.style.display = 'none';
                toggleText.textContent = 'Show Raw Kind 10040 Note';
                toggleIcon.textContent = 'üëÅÔ∏è';
                toggleBtn.classList.remove('expanded');
            } else {
                // Show the raw note
                rawNoteContent.style.display = 'block';
                toggleText.textContent = 'Hide Raw Kind 10040 Note';
                toggleIcon.textContent = 'üôà';
                toggleBtn.classList.add('expanded');
            }
        }
        
        /**
         * Toggle the visibility of the raw Kind 30382 note viewer
         */
        function toggleRaw30382Note() {
            const raw30382Content = document.getElementById('raw30382Content');
            const toggleBtn = document.getElementById('toggleRaw30382Btn');
            const toggleText = toggleBtn.querySelector('.toggle-text');
            const toggleIcon = toggleBtn.querySelector('.toggle-icon');
            
            const isCurrentlyVisible = raw30382Content.style.display !== 'none';
            
            if (isCurrentlyVisible) {
                // Hide the raw note
                raw30382Content.style.display = 'none';
                toggleText.textContent = 'Show Raw Kind 30382 Note';
                toggleIcon.textContent = 'üìä';
                toggleBtn.classList.remove('expanded');
            } else {
                // Show the raw note
                raw30382Content.style.display = 'block';
                toggleText.textContent = 'Hide Raw Kind 30382 Note';
                toggleIcon.textContent = 'üôà';
                toggleBtn.classList.add('expanded');
            }
        }
        
        function updateStatusDisplay() {
            // Update status display in header section
            const statusElement = document.getElementById('customerStatus');
            if (statusElement) {
                statusElement.textContent = customerData.status.toUpperCase();
                statusElement.className = `customer-status status-${customerData.status}`;
            }
            
            // Update status in customer details section
            const statusDetail = document.getElementById('customerStatusDetail');
            if (statusDetail) {
                statusDetail.textContent = customerData.status || '-';
            }
            
            // Update status display in management section
            const statusDisplay = document.getElementById('currentStatusDisplay');
            if (statusDisplay) {
                statusDisplay.textContent = customerData.status.toUpperCase();
                statusDisplay.className = `status-badge status-${customerData.status}`;
            }
        }
        
        function updateActionButtons() {
            const activateBtn = document.getElementById('activateBtn');
            const deactivateBtn = document.getElementById('deactivateBtn');
            
            if (customerData.status === 'active') {
                activateBtn.disabled = true;
                activateBtn.textContent = '‚úÖ Already Active';
                deactivateBtn.disabled = false;
            } else {
                activateBtn.disabled = false;
                deactivateBtn.disabled = true;
                deactivateBtn.textContent = '‚è∏Ô∏è Already Inactive';
            }
        }
        
        // Management Action Functions
        async function changeCustomerStatus(newStatus) {
            const displayName = profileData?.name || customerData.name || 'this customer';
            const currentStatus = customerData.status;
            
            // Check if status is already the same
            if (currentStatus === newStatus) {
                alert(`${displayName} is already ${newStatus}.`);
                return;
            }
            
            // Confirmation dialog
            if (!confirm(`Are you sure you want to change ${displayName}'s status to ${newStatus}?`)) {
                return;
            }
            
            // Show loading state
            const activateBtn = document.getElementById('activateBtn');
            const deactivateBtn = document.getElementById('deactivateBtn');
            const targetBtn = newStatus === 'active' ? activateBtn : deactivateBtn;
            
            const originalText = targetBtn.textContent;
            targetBtn.disabled = true;
            targetBtn.textContent = newStatus === 'active' ? '‚è≥ Activating...' : '‚è≥ Deactivating...';
            
            try {
                // Make API call to change customer status
                const response = await fetch('/api/change-customer-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pubkey: customerPubkey,
                        status: newStatus
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show success message
                    alert(`‚úÖ ${result.message}`);
                    
                    // Update the UI to reflect the new status
                    customerData.status = newStatus;
                    updateStatusDisplay();
                    
                    // Update button states
                    updateActionButtons();
                } else {
                    // Show error message
                    alert(`‚ùå Failed to change customer status: ${result.error}`);
                }
                
            } catch (error) {
                console.error('Error changing customer status:', error);
                alert(`‚ùå Network error occurred while changing customer status: ${error.message}`);
            } finally {
                // Restore button state
                targetBtn.disabled = false;
                targetBtn.textContent = originalText;
            }
        }
        
        function recalculateMetric(metric) {
            if (confirm(`Are you sure you want to recalculate ${metric} for this customer?`)) {
                alert(`Recalculate ${metric} - Not yet implemented. This will require CustomerManager API endpoint.`);
            }
        }
        
        function exportKind30382() {
            if (confirm('Are you sure you want to trigger Kind 30382 export for this customer?')) {
                alert('Kind 30382 export - Not yet implemented. This will require CustomerManager API endpoint.');
            }
        }
        
        function sendKind10040Reminder() {
            if (confirm('Are you sure you want to send a Kind 10040 reminder to this customer?')) {
                alert('Send Kind 10040 reminder - Not yet implemented. This will require CustomerManager API endpoint.');
            }
        }
        
        async function deleteCustomer() {
            const displayName = profileData?.name || customerData.name || 'this customer';
            
            // First confirmation dialog
            if (!confirm(`‚ö†Ô∏è WARNING: Are you absolutely sure you want to DELETE ${displayName}?\n\nThis action is IRREVERSIBLE and will:\n- Remove all customer data\n- Delete customer directory\n- Remove all associated trust metrics\n- Remove secure relay keys\n\nType 'DELETE' in the next prompt to confirm.`)) {
                return;
            }
            
            // Second confirmation with typing requirement
            const confirmation = prompt('Type DELETE to confirm customer deletion:');
            if (confirmation !== 'DELETE') {
                alert('Customer deletion cancelled.');
                return;
            }
            
            // Show loading state
            const deleteBtn = document.querySelector('.btn-danger');
            const originalText = deleteBtn.textContent;
            deleteBtn.disabled = true;
            deleteBtn.textContent = 'üóëÔ∏è Deleting...';
            
            try {
                // Make API call to delete customer
                const response = await fetch('/api/delete-customer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pubkey: customerPubkey
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show success message with details
                    const summary = result.data.deletionSummary;
                    let summaryText = 'Customer successfully deleted!';
                    
                    if (summary.backupCreated) summaryText += '\n‚úÖ Backup created';
                    if (summary.directoryRemoved) summaryText += '\n‚úÖ Directory removed';
                    if (summary.secureKeysRemoved) summaryText += '\n‚úÖ Secure keys removed';
                    if (summary.errors && summary.errors.length > 0) {
                        summaryText += '\n\n‚ö†Ô∏è Some non-critical errors occurred:\n' + summary.errors.join('\n');
                    }
                    
                    alert(summaryText);
                    
                    // Redirect to manage customers page
                    window.location.href = '/manage-customers.html';
                } else {
                    // Show error message
                    alert(`Customer deletion failed: ${result.error}`);
                }
                
            } catch (error) {
                console.error('Error deleting customer:', error);
                alert(`Network error occurred while deleting customer: ${error.message}`);
            } finally {
                // Restore button state
                deleteBtn.disabled = false;
                deleteBtn.textContent = originalText;
            }
        }
        
        // Global variable to store relay keys data
        let relayKeysData = null;
        
        /**
         * Load customer relay keys from the API
         */
        async function loadCustomerRelayKeys() {
            try {
                const response = await fetch(`/api/get-customer-relay-keys?pubkey=${encodeURIComponent(customerPubkey)}`);
                const result = await response.json();
                
                if (result.success && result.data.found) {
                    relayKeysData = result.data;
                    
                    // Update UI with relay key information
                    document.getElementById('relayStatus').innerHTML = '<span class="status-success">‚úÖ Keys Found</span>';
                    document.getElementById('relayPubkey').textContent = result.data.pubkey || '-';
                    document.getElementById('relayNpub').textContent = result.data.npub || '-';
                    
                    // Store secure keys but don't display them yet
                    document.getElementById('relayNsec').dataset.secureValue = result.data.nsec || '';
                    document.getElementById('relayPrivkey').dataset.secureValue = result.data.privkey || '';
                    
                    // Enable reveal buttons if keys exist
                    if (result.data.nsec) {
                        document.getElementById('revealNsecBtn').disabled = false;
                    }
                    if (result.data.privkey) {
                        document.getElementById('revealPrivkeyBtn').disabled = false;
                    }
                    
                } else {
                    // No relay keys found
                    document.getElementById('relayStatus').innerHTML = '<span class="status-error">‚ùå Keys Not Found</span>';
                    document.getElementById('relayPubkey').textContent = 'No keys found';
                    document.getElementById('relayNpub').textContent = 'No keys found';
                    
                    // Disable reveal buttons
                    document.getElementById('revealNsecBtn').disabled = true;
                    document.getElementById('revealPrivkeyBtn').disabled = true;
                }
                
            } catch (error) {
                console.error('Error loading customer relay keys:', error);
                document.getElementById('relayStatus').innerHTML = '<span class="status-error">‚ùå Error Loading</span>';
                document.getElementById('relayPubkey').textContent = 'Error loading keys';
                document.getElementById('relayNpub').textContent = 'Error loading keys';
                
                // Disable reveal buttons
                document.getElementById('revealNsecBtn').disabled = true;
                document.getElementById('revealPrivkeyBtn').disabled = true;
            }
        }
        
        /**
         * Toggle secure key visibility
         * @param {string} keyType - Either 'nsec' or 'privkey'
         */
        function toggleSecureKey(keyType) {
            const elementId = keyType === 'nsec' ? 'relayNsec' : 'relayPrivkey';
            const buttonId = keyType === 'nsec' ? 'revealNsecBtn' : 'revealPrivkeyBtn';
            
            const element = document.getElementById(elementId);
            const button = document.getElementById(buttonId);
            
            if (!element || !button) {
                console.error(`Elements not found for key type: ${keyType}`);
                return;
            }
            
            const secureValue = element.dataset.secureValue;
            const isHidden = element.classList.contains('hidden');
            
            if (isHidden) {
                // Reveal the key
                element.textContent = secureValue || 'No key available';
                element.classList.remove('hidden');
                element.classList.add('revealed');
                button.innerHTML = 'üôà Hide';
                button.classList.remove('btn-secondary');
                button.classList.add('btn-warning');
                
                // Auto-hide after 30 seconds for security
                setTimeout(() => {
                    if (element.classList.contains('revealed')) {
                        toggleSecureKey(keyType);
                    }
                }, 30000);
                
            } else {
                // Hide the key
                element.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                element.classList.add('hidden');
                element.classList.remove('revealed');
                button.innerHTML = 'üëÅÔ∏è Reveal';
                button.classList.remove('btn-warning');
                button.classList.add('btn-secondary');
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').innerHTML = `
                <div class="error-container">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <h2>Error Loading Customer</h2>
                    <p>${escapeHtml(message)}</p>
                    <button onclick="location.reload()" class="btn btn-primary">Retry</button>
                    <a href="/manage-customers.html" class="btn btn-secondary">Back to Customers</a>
                </div>
            `;
            document.getElementById('mainContent').style.display = 'block';
        }
        
        /**
         * Load hops calculation status from API
         */
        async function loadHopsCalculationStatus() {
            try {
                console.log('Loading hops calculation status...');
                
                const response = await fetch(`/api/calculation-history/hops?pubkey=${encodeURIComponent(customerPubkey)}`);
                const result = await response.json();
                
                if (result.success) {
                    updateHopsCalculationDisplay(result.data.calculation);
                } else {
                    console.error('Failed to load hops calculation status:', result.message);
                    updateHopsCalculationDisplay({
                        status: 'Error',
                        formattedTime: 'Failed to load',
                        logExists: false,
                        error: result.message
                    });
                }
                
            } catch (error) {
                console.error('Error loading hops calculation status:', error);
                updateHopsCalculationDisplay({
                    status: 'Error',
                    formattedTime: 'Network error',
                    logExists: false,
                    error: error.message
                });
            }
        }
        
        /**
         * Update hops calculation display with API data
         * @param {Object} data - Calculation status data from API
         */
        function updateHopsCalculationDisplay(data) {
            // Update status badge
            const statusElement = document.getElementById('hopsStatus');
            statusElement.textContent = data.status || 'Unknown';
            statusElement.className = `status-badge ${getStatusClass(data.status)}`;
            
            // Update last run time
            document.getElementById('hopsLastRun').textContent = data.formattedTime || 'Unknown';
            
            // Update duration if available
            const durationRow = document.getElementById('hopsDurationRow');
            if (data.duration && data.status === 'Completed') {
                document.getElementById('hopsDuration').textContent = data.duration;
                durationRow.style.display = 'flex';
            } else {
                durationRow.style.display = 'none';
            }
            
            // Update inactivity info if in progress
            const inactivityRow = document.getElementById('hopsInactivityRow');
            if (data.inProgress && data.inactivity) {
                document.getElementById('hopsInactivity').textContent = data.inactivity.inactivityDuration;
                inactivityRow.style.display = 'flex';
            } else {
                inactivityRow.style.display = 'none';
            }
            
            // Update log file path
            const logFileElement = document.getElementById('hopsLogFile');
            if (data.logFile) {
                logFileElement.textContent = data.logFile;
                logFileElement.title = data.logExists ? 'Log file exists' : 'Log file does not exist';
                logFileElement.className = `status-value log-path ${data.logExists ? 'log-exists' : 'log-missing'}`;
            } else {
                logFileElement.textContent = 'Not configured';
            }
            
            // Enable trigger button if not in progress
            const triggerBtn = document.getElementById('triggerHopsBtn');
            if (data.status !== 'In Progress' && data.status !== 'Stalled') {
                triggerBtn.disabled = false;
            } else {
                triggerBtn.disabled = true;
            }
        }
        
        /**
         * Load PageRank calculation status from API
         */
        async function loadPageRankCalculationStatus() {
            try {
                console.log('Loading PageRank calculation status...');
                
                const response = await fetch(`/api/calculation-history/personalizedPageRank?pubkey=${encodeURIComponent(customerPubkey)}`);
                const result = await response.json();
                
                if (result.success) {
                    updatePageRankCalculationDisplay(result.data.calculation);
                } else {
                    console.error('Failed to load PageRank calculation status:', result.message);
                    updatePageRankCalculationDisplay({
                        status: 'Error',
                        formattedTime: 'Failed to load',
                        logExists: false,
                        error: result.message
                    });
                }
                
            } catch (error) {
                console.error('Error loading PageRank calculation status:', error);
                updatePageRankCalculationDisplay({
                    status: 'Error',
                    formattedTime: 'Network error',
                    logExists: false,
                    error: error.message
                });
            }
        }
        
        /**
         * Update PageRank calculation display with API data
         * @param {Object} data - Calculation status data from API
         */
        function updatePageRankCalculationDisplay(data) {
            // Update status badge
            const statusElement = document.getElementById('pageRankStatus');
            statusElement.textContent = data.status || 'Unknown';
            statusElement.className = `status-badge ${getStatusClass(data.status)}`;
            
            // Update last run time
            document.getElementById('pageRankLastRun').textContent = data.formattedTime || 'Unknown';
            
            // Update duration if available
            const durationRow = document.getElementById('pageRankDurationRow');
            if (data.duration && data.status === 'Completed') {
                document.getElementById('pageRankDuration').textContent = data.duration;
                durationRow.style.display = 'flex';
            } else {
                durationRow.style.display = 'none';
            }
            
            // Update inactivity info if in progress
            const inactivityRow = document.getElementById('pageRankInactivityRow');
            if (data.inProgress && data.inactivity) {
                document.getElementById('pageRankInactivity').textContent = data.inactivity.inactivityDuration;
                inactivityRow.style.display = 'flex';
            } else {
                inactivityRow.style.display = 'none';
            }
            
            // Update log file path
            const logFileElement = document.getElementById('pageRankLogFile');
            if (data.logFile) {
                logFileElement.textContent = data.logFile;
                logFileElement.title = data.logExists ? 'Log file exists' : 'Log file does not exist';
                logFileElement.className = `status-value log-path ${data.logExists ? 'log-exists' : 'log-missing'}`;
            } else {
                logFileElement.textContent = 'Not configured';
            }
            
            // Enable trigger button if not in progress
            const triggerBtn = document.getElementById('triggerPageRankBtn');
            if (data.status !== 'In Progress' && data.status !== 'Stalled') {
                triggerBtn.disabled = false;
            } else {
                triggerBtn.disabled = true;
            }
        }
        
        /**
         * Load GrapeRank calculation status from API
         */
        async function loadGrapeRankCalculationStatus() {
            try {
                console.log('Loading GrapeRank calculation status...');
                
                const response = await fetch(`/api/calculation-history/personalizedGrapeRank?pubkey=${encodeURIComponent(customerPubkey)}`);
                const result = await response.json();
                
                if (result.success) {
                    updateGrapeRankCalculationDisplay(result.data.calculation);
                } else {
                    console.error('Failed to load GrapeRank calculation status:', result.message);
                    updateGrapeRankCalculationDisplay({
                        status: 'Error',
                        formattedTime: 'Failed to load',
                        logExists: false,
                        error: result.message
                    });
                }
                
            } catch (error) {
                console.error('Error loading GrapeRank calculation status:', error);
                updateGrapeRankCalculationDisplay({
                    status: 'Error',
                    formattedTime: 'Network error',
                    logExists: false,
                    error: error.message
                });
            }
        }
        
        /**
         * Update GrapeRank calculation display with API data
         * @param {Object} data - Calculation status data from API
         */
        function updateGrapeRankCalculationDisplay(data) {
            // Update status badge
            const statusElement = document.getElementById('grapeRankStatus');
            statusElement.textContent = data.status || 'Unknown';
            statusElement.className = `status-badge ${getStatusClass(data.status)}`;
            
            // Update last run time
            document.getElementById('grapeRankLastRun').textContent = data.formattedTime || 'Unknown';
            
            // Update duration if available
            const durationRow = document.getElementById('grapeRankDurationRow');
            if (data.duration && data.status === 'Completed') {
                document.getElementById('grapeRankDuration').textContent = data.duration;
                durationRow.style.display = 'flex';
            } else {
                durationRow.style.display = 'none';
            }
            
            // Update inactivity info if in progress
            const inactivityRow = document.getElementById('grapeRankInactivityRow');
            if (data.inProgress && data.inactivity) {
                document.getElementById('grapeRankInactivity').textContent = data.inactivity.inactivityDuration;
                inactivityRow.style.display = 'flex';
            } else {
                inactivityRow.style.display = 'none';
            }
            
            // Update log file path
            const logFileElement = document.getElementById('grapeRankLogFile');
            if (data.logFile) {
                logFileElement.textContent = data.logFile;
                logFileElement.title = data.logExists ? 'Log file exists' : 'Log file does not exist';
                logFileElement.className = `status-value log-path ${data.logExists ? 'log-exists' : 'log-missing'}`;
            } else {
                logFileElement.textContent = 'Not configured';
            }
            
            // Enable trigger button if not in progress
            const triggerBtn = document.getElementById('triggerGrapeRankBtn');
            if (data.status !== 'In Progress' && data.status !== 'Stalled') {
                triggerBtn.disabled = false;
            } else {
                triggerBtn.disabled = true;
            }
        }
        
        /**
         * Load Kind 30382 Export calculation status from API
         */
        async function loadKind30382ExportCalculationStatus() {
            try {
                console.log('Loading Kind 30382 Export calculation status...');
                
                const response = await fetch(`/api/calculation-history/kind30382Export?pubkey=${encodeURIComponent(customerPubkey)}`);
                const result = await response.json();
                
                if (result.success) {
                    updateKind30382ExportCalculationDisplay(result.data.calculation);
                } else {
                    console.error('Failed to load Kind 30382 Export calculation status:', result.message);
                    updateKind30382ExportCalculationDisplay({
                        status: 'Error',
                        formattedTime: 'Failed to load',
                        logExists: false,
                        error: result.message
                    });
                }
                
            } catch (error) {
                console.error('Error loading Kind 30382 Export calculation status:', error);
                updateKind30382ExportCalculationDisplay({
                    status: 'Error',
                    formattedTime: 'Network error',
                    logExists: false,
                    error: error.message
                });
            }
        }
        
        /**
         * Update Kind 30382 Export calculation display with API data
         * @param {Object} data - Calculation status data from API
         */
        function updateKind30382ExportCalculationDisplay(data) {
            // Update status badge
            const statusElement = document.getElementById('kind30382ExportStatus');
            statusElement.textContent = data.status || 'Unknown';
            statusElement.className = `status-badge ${getStatusClass(data.status)}`;
            
            // Update last run time
            document.getElementById('kind30382ExportLastRun').textContent = data.formattedTime || 'Unknown';
            
            // Update duration if available
            const durationRow = document.getElementById('kind30382ExportDurationRow');
            if (data.duration && data.status === 'Completed') {
                document.getElementById('kind30382ExportDuration').textContent = data.duration;
                durationRow.style.display = 'flex';
            } else {
                durationRow.style.display = 'none';
            }
            
            // Update inactivity info if in progress
            const inactivityRow = document.getElementById('kind30382ExportInactivityRow');
            if (data.inProgress && data.inactivity) {
                document.getElementById('kind30382ExportInactivity').textContent = data.inactivity.inactivityDuration;
                inactivityRow.style.display = 'flex';
            } else {
                inactivityRow.style.display = 'none';
            }
            
            // Update log file path
            const logFileElement = document.getElementById('kind30382ExportLogFile');
            if (data.logFile) {
                logFileElement.textContent = data.logFile;
                logFileElement.title = data.logExists ? 'Log file exists' : 'Log file does not exist';
                logFileElement.className = `status-value log-path ${data.logExists ? 'log-exists' : 'log-missing'}`;
            } else {
                logFileElement.textContent = 'Not configured';
            }
            
            // Enable trigger button if not in progress
            const triggerBtn = document.getElementById('triggerKind30382ExportBtn');
            if (data.status !== 'In Progress' && data.status !== 'Stalled') {
                triggerBtn.disabled = false;
            } else {
                triggerBtn.disabled = true;
            }
        }
        
        /**
         * Load Process All Trust Metrics calculation status from API
         */
        async function loadProcessAllTrustMetricsCalculationStatus() {
            try {
                console.log('Loading Process All Trust Metrics calculation status...');
                
                const response = await fetch(`/api/calculation-history/processAllTrustMetrics?pubkey=${encodeURIComponent(customerPubkey)}`);
                const result = await response.json();
                
                if (result.success) {
                    updateProcessAllTrustMetricsCalculationDisplay(result.data.calculation);
                } else {
                    console.error('Failed to load Process All Trust Metrics calculation status:', result.message);
                    updateProcessAllTrustMetricsCalculationDisplay({
                        status: 'Error',
                        formattedTime: 'Failed to load',
                        logExists: false,
                        error: result.message
                    });
                }
                
            } catch (error) {
                console.error('Error loading Process All Trust Metrics calculation status:', error);
                updateProcessAllTrustMetricsCalculationDisplay({
                    status: 'Error',
                    formattedTime: 'Network error',
                    logExists: false,
                    error: error.message
                });
            }
        }
        
        /**
         * Update Process All Trust Metrics calculation display with API data
         * @param {Object} data - Calculation status data from API
         */
        function updateProcessAllTrustMetricsCalculationDisplay(data) {
            // Update status badge
            const statusElement = document.getElementById('processAllTrustMetricsStatus');
            statusElement.textContent = data.status || 'Unknown';
            statusElement.className = `status-badge ${getStatusClass(data.status)}`;
            
            // Update last run time
            document.getElementById('processAllTrustMetricsLastRun').textContent = data.formattedTime || 'Unknown';
            
            // Update duration if available
            const durationRow = document.getElementById('processAllTrustMetricsDurationRow');
            if (data.duration && data.status === 'Completed') {
                document.getElementById('processAllTrustMetricsDuration').textContent = data.duration;
                durationRow.style.display = 'flex';
            } else {
                durationRow.style.display = 'none';
            }
            
            // Update inactivity info if in progress
            const inactivityRow = document.getElementById('processAllTrustMetricsInactivityRow');
            if (data.inProgress && data.inactivity) {
                document.getElementById('processAllTrustMetricsInactivity').textContent = data.inactivity.inactivityDuration;
                inactivityRow.style.display = 'flex';
            } else {
                inactivityRow.style.display = 'none';
            }
            
            // Update log file path
            const logFileElement = document.getElementById('processAllTrustMetricsLogFile');
            if (data.logFile) {
                logFileElement.textContent = data.logFile;
                logFileElement.title = data.logExists ? 'Log file exists' : 'Log file does not exist';
                logFileElement.className = `status-value log-path ${data.logExists ? 'log-exists' : 'log-missing'}`;
            } else {
                logFileElement.textContent = 'Not configured';
            }
            
            // Enable trigger button if not in progress
            const triggerBtn = document.getElementById('triggerProcessAllTrustMetricsBtn');
            if (data.status !== 'In Progress' && data.status !== 'Stalled') {
                triggerBtn.disabled = false;
            } else {
                triggerBtn.disabled = true;
            }
        }
        
        /**
         * Load Analyze Follows, Mutes, and Reports calculation status from API
         */
        async function loadAnalyzeFollowsMutesReportsCalculationStatus() {
            try {
                console.log('Loading Analyze Follows, Mutes, and Reports calculation status...');
                
                const response = await fetch(`/api/calculation-history/analyzeFollowsMutesReports?pubkey=${encodeURIComponent(customerPubkey)}`);
                const result = await response.json();
                
                if (result.success) {
                    updateAnalyzeFollowsMutesReportsCalculationDisplay(result.data.calculation);
                } else {
                    console.error('Failed to load Analyze Follows, Mutes, and Reports calculation status:', result.message);
                    updateAnalyzeFollowsMutesReportsCalculationDisplay({
                        status: 'Error',
                        formattedTime: 'Failed to load',
                        logExists: false,
                        error: result.message
                    });
                }
                
            } catch (error) {
                console.error('Error loading Analyze Follows, Mutes, and Reports calculation status:', error);
                updateAnalyzeFollowsMutesReportsCalculationDisplay({
                    status: 'Error',
                    formattedTime: 'Network error',
                    logExists: false,
                    error: error.message
                });
            }
        }
        
        /**
         * Update Analyze Follows, Mutes, and Reports calculation display with API data
         * @param {Object} data - Calculation status data from API
         */
        function updateAnalyzeFollowsMutesReportsCalculationDisplay(data) {
            // Update status badge
            const statusElement = document.getElementById('analyzeFollowsMutesReportsStatus');
            statusElement.textContent = data.status || 'Unknown';
            statusElement.className = `status-badge ${getStatusClass(data.status)}`;
            
            // Update last run time
            document.getElementById('analyzeFollowsMutesReportsLastRun').textContent = data.formattedTime || 'Unknown';
            
            // Update duration if available
            const durationRow = document.getElementById('analyzeFollowsMutesReportsDurationRow');
            if (data.duration && data.status === 'Completed') {
                document.getElementById('analyzeFollowsMutesReportsDuration').textContent = data.duration;
                durationRow.style.display = 'flex';
            } else {
                durationRow.style.display = 'none';
            }
            
            // Update inactivity info if in progress
            const inactivityRow = document.getElementById('analyzeFollowsMutesReportsInactivityRow');
            if (data.inProgress && data.inactivity) {
                document.getElementById('analyzeFollowsMutesReportsInactivity').textContent = data.inactivity.inactivityDuration;
                inactivityRow.style.display = 'flex';
            } else {
                inactivityRow.style.display = 'none';
            }
            
            // Update log file path
            const logFileElement = document.getElementById('analyzeFollowsMutesReportsLogFile');
            if (data.logFile) {
                logFileElement.textContent = data.logFile;
                logFileElement.title = data.logExists ? 'Log file exists' : 'Log file does not exist';
                logFileElement.className = `status-value log-path ${data.logExists ? 'log-exists' : 'log-missing'}`;
            } else {
                logFileElement.textContent = 'Not configured';
            }
            
            // Enable trigger button if not in progress
            const triggerBtn = document.getElementById('triggerAnalyzeFollowsMutesReportsBtn');
            if (data.status !== 'In Progress' && data.status !== 'Stalled') {
                triggerBtn.disabled = false;
            } else {
                triggerBtn.disabled = true;
            }
        }
        
        /**
         * Get CSS class for status badge based on status
         * @param {string} status - Calculation status
         * @returns {string} CSS class name
         */
        function getStatusClass(status) {
            switch (status) {
                case 'Completed':
                    return 'status-completed';
                case 'In Progress':
                    return 'status-in-progress';
                case 'Stalled':
                    return 'status-stalled';
                case 'Never':
                    return 'status-never';
                case 'Error':
                    return 'status-error';
                default:
                    return 'status-unknown';
            }
        }
        
        /**
         * Load GrapeRank preset configuration using generalized system
         */
        async function loadGrapeRankPresetConfig() {
            await loadConfigPreset('graperank');
        }
        

        
        /**
         * Get CSS class for preset badge based on preset type
         * @param {string} preset - Preset type
         * @returns {string} CSS class name
         */
        function getPresetClass(preset) {
            switch (preset) {
                case 'Permissive':
                    return 'preset-permissive';
                case 'Default':
                    return 'preset-default';
                case 'Restrictive':
                    return 'preset-restrictive';
                case 'Custom':
                    return 'preset-custom';
                case 'Error':
                case 'Config File Not Found':
                case 'Customer Not Found':
                    return 'preset-error';
                default:
                    return 'preset-unknown';
            }
        }
        

        
        /**
         * Update GrapeRank preset using generalized system
         */
        async function updateGrapeRankPreset() {
            await updateConfigPreset('graperank', 'graperankPreset', 'updateGraperankBtn', 'graperankUpdateControls');
        }
        
        /**
         * GENERALIZED CONFIGURATION MANAGEMENT FUNCTIONS
         * These functions work with any config type (whitelist, blacklist, etc.)
         */
        
        /**
         * Load configuration preset for any config type
         * @param {string} configType - Configuration type (e.g., 'whitelist', 'blacklist')
         */
        async function loadConfigPreset(configType) {
            try {
                const response = await fetch(`/api/algos/config/get?pubkey=${customerPubkey}&configType=${configType}`);
                const result = await response.json();
                
                if (result.success) {
                    updateConfigDisplay(configType, result.data);
                } else {
                    console.error(`Error loading ${configType} preset:`, result.error);
                    updateConfigDisplay(configType, {
                        preset: 'Error',
                        error: result.error,
                        configType
                    });
                }
            } catch (error) {
                console.error(`Error loading ${configType} preset:`, error);
                updateConfigDisplay(configType, {
                    preset: 'Error',
                    error: error.message,
                    configType
                });
            }
        }
        
        /**
         * Update configuration display for any config type
         * @param {string} configType - Configuration type
         * @param {Object} data - Configuration data
         */
        function updateConfigDisplay(configType, data) {
            const presetElement = document.getElementById(`${configType}Preset`);
            const configPathElement = document.getElementById(`${configType}ConfigPath`);
            const parameterCountElement = document.getElementById(`${configType}ParameterCount`);
            
            if (presetElement) {
                presetElement.textContent = data.preset || 'Unknown';
                presetElement.className = `preset-badge ${getPresetClass(data.preset)}`;
            }
            
            if (configPathElement) {
                configPathElement.textContent = data.configPath || 'Not available';
            }
            
            if (parameterCountElement) {
                parameterCountElement.textContent = data.parameterCount ? `${data.parameterCount} parameters` : 'Unknown';
            }
            
            // Update controls visibility and radio selection
            updateConfigControlsVisibility(configType, data);
            updateConfigRadioSelection(configType, data.preset);
        }
        
        /**
         * Update config controls visibility based on user classification and data
         * @param {string} configType - Configuration type
         * @param {Object} data - Configuration data
         */
        function updateConfigControlsVisibility(configType, data) {
            const toggleBtn = document.getElementById(`toggle${configType.charAt(0).toUpperCase() + configType.slice(1)}UpdateBtn`);
            const updateControls = document.getElementById(`${configType}UpdateControls`);
            
            // Only show controls for owners and if preset data is valid
            if (userClassification === 'owner' && data.preset && data.preset !== 'Error' && data.preset !== 'Config File Not Found') {
                if (toggleBtn) toggleBtn.style.display = 'inline-block';
            } else {
                if (toggleBtn) toggleBtn.style.display = 'none';
                if (updateControls) updateControls.style.display = 'none';
            }
        }
        
        /**
         * Update radio button selection based on current preset
         * @param {string} configType - Configuration type
         * @param {string} currentPreset - Current preset type
         */
        function updateConfigRadioSelection(configType, currentPreset) {
            // Clear all radio selections first
            document.querySelectorAll(`input[name="${configType}Preset"]`).forEach(radio => {
                radio.checked = false;
            });
            
            // Select the appropriate radio button
            const presetMap = {
                'Permissive': `${configType}Permissive`,
                'Default': `${configType}Default`, 
                'Restrictive': `${configType}Restrictive`
            };
            
            const radioId = presetMap[currentPreset];
            if (radioId) {
                const radioElement = document.getElementById(radioId);
                if (radioElement) {
                    radioElement.checked = true;
                }
            }
        }
        
        /**
         * Setup event listeners for any config type
         * @param {string} configType - Configuration type
         */
        function setupConfigEventListeners(configType) {
            const capitalizedType = configType.charAt(0).toUpperCase() + configType.slice(1);
            
            // Refresh button
            const refreshBtn = document.getElementById(`refresh${capitalizedType}Btn`);
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    this.disabled = true;
                    this.textContent = 'üîÑ Refreshing...';
                    
                    loadConfigPreset(configType).finally(() => {
                        this.disabled = false;
                        this.textContent = 'üîÑ Refresh';
                    });
                });
            }
            
            // Toggle update controls button
            const toggleBtn = document.getElementById(`toggle${capitalizedType}UpdateBtn`);
            const updateControls = document.getElementById(`${configType}UpdateControls`);
            if (toggleBtn && updateControls) {
                toggleBtn.addEventListener('click', function() {
                    const isVisible = updateControls.style.display !== 'none';
                    updateControls.style.display = isVisible ? 'none' : 'block';
                    this.textContent = isVisible ? '‚öôÔ∏è Update Preset' : '‚ùå Hide Controls';
                });
            }
            
            // Radio button change handlers
            document.querySelectorAll(`input[name="${configType}Preset"]`).forEach(radio => {
                radio.addEventListener('change', function() {
                    const updateBtn = document.getElementById(`update${capitalizedType}Btn`);
                    if (updateBtn) {
                        updateBtn.disabled = false;
                    }
                });
            });
            
            // Update preset button
            const updateBtn = document.getElementById(`update${capitalizedType}Btn`);
            if (updateBtn) {
                updateBtn.addEventListener('click', async function() {
                    const selectedPreset = document.querySelector(`input[name="${configType}Preset"]:checked`);
                    if (!selectedPreset) {
                        alert('Please select a preset to apply.');
                        return;
                    }
                    
                    const confirmed = confirm(`Are you sure you want to change the ${configType} preset to ${selectedPreset.value}?\n\nThis will update the configuration file and may affect trust metric calculations.`);
                    if (!confirmed) return;
                    
                    this.disabled = true;
                    this.textContent = 'üíæ Updating...';
                    
                    try {
                        const response = await fetch(`/api/algos/config/update?pubkey=${customerPubkey}&configType=${configType}&setPreset=${selectedPreset.value}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            alert(`‚úÖ Successfully updated ${configType} preset to ${result.data.newPreset}!`);
                            // Reload the preset data
                            await loadConfigPreset(configType);
                            // Hide update controls
                            updateControls.style.display = 'none';
                            if (toggleBtn) toggleBtn.textContent = '‚öôÔ∏è Update Preset';
                        } else {
                            alert(`‚ùå Failed to update ${configType} preset: ${result.error}`);
                        }
                    } catch (error) {
                        console.error(`Error updating ${configType} preset:`, error);
                        alert(`‚ùå Error updating ${configType} preset: ${error.message}`);
                    } finally {
                        this.disabled = false;
                        this.textContent = 'üíæ Update Preset';
                    }
                });
            }
            
            // Cancel button
            const cancelBtn = document.getElementById(`cancel${capitalizedType}UpdateBtn`);
            if (cancelBtn && updateControls) {
                cancelBtn.addEventListener('click', function() {
                    updateControls.style.display = 'none';
                    if (toggleBtn) toggleBtn.textContent = '‚öôÔ∏è Update Preset';
                    
                    // Reset radio selections to current preset
                    const currentPreset = document.getElementById(`${configType}Preset`).textContent;
                    updateConfigRadioSelection(configType, currentPreset);
                    
                    // Disable update button
                    if (updateBtn) updateBtn.disabled = true;
                });
            }
        }
        
        // Event handlers for calculation actions
        document.addEventListener('DOMContentLoaded', function() {
            // Refresh hops calculation status
            document.getElementById('refreshHopsBtn')?.addEventListener('click', function() {
                this.disabled = true;
                this.textContent = 'üîÑ Refreshing...';
                
                loadHopsCalculationStatus().finally(() => {
                    this.disabled = false;
                    this.textContent = 'üîÑ Refresh';
                });
            });
            
            // Trigger hops calculation (placeholder)
            document.getElementById('triggerHopsBtn')?.addEventListener('click', function() {
                alert('Trigger calculation functionality will be implemented in a future update.');
            });
            
            // Refresh PageRank calculation status
            document.getElementById('refreshPageRankBtn')?.addEventListener('click', function() {
                this.disabled = true;
                this.textContent = 'üîÑ Refreshing...';
                
                loadPageRankCalculationStatus().finally(() => {
                    this.disabled = false;
                    this.textContent = 'üîÑ Refresh';
                });
            });
            
            // Trigger PageRank calculation (placeholder)
            document.getElementById('triggerPageRankBtn')?.addEventListener('click', function() {
                alert('Trigger calculation functionality will be implemented in a future update.');
            });
            
            // Refresh GrapeRank calculation status
            document.getElementById('refreshGrapeRankBtn')?.addEventListener('click', function() {
                this.disabled = true;
                this.textContent = 'üîÑ Refreshing...';
                
                loadGrapeRankCalculationStatus().finally(() => {
                    this.disabled = false;
                    this.textContent = 'üîÑ Refresh';
                });
            });
            
            // Trigger GrapeRank calculation (placeholder)
            document.getElementById('triggerGrapeRankBtn')?.addEventListener('click', function() {
                alert('Trigger calculation functionality will be implemented in a future update.');
            });
            
            // Refresh Kind 30382 Export calculation status
            document.getElementById('refreshKind30382ExportBtn')?.addEventListener('click', function() {
                this.disabled = true;
                this.textContent = 'üîÑ Refreshing...';
                
                loadKind30382ExportCalculationStatus().finally(() => {
                    this.disabled = false;
                    this.textContent = 'üîÑ Refresh';
                });
            });
            
            // Trigger Kind 30382 Export calculation (placeholder)
            document.getElementById('triggerKind30382ExportBtn')?.addEventListener('click', function() {
                alert('Trigger calculation functionality will be implemented in a future update.');
            });
            
            // Refresh Process All Trust Metrics calculation status
            document.getElementById('refreshProcessAllTrustMetricsBtn')?.addEventListener('click', function() {
                this.disabled = true;
                this.textContent = 'üîÑ Refreshing...';
                
                loadProcessAllTrustMetricsCalculationStatus().finally(() => {
                    this.disabled = false;
                    this.textContent = 'üîÑ Refresh';
                });
            });
            
            // Trigger Process All Trust Metrics calculation (placeholder)
            document.getElementById('triggerProcessAllTrustMetricsBtn')?.addEventListener('click', function() {
                alert('Trigger calculation functionality will be implemented in a future update.');
            });
            
            // Refresh Analyze Follows, Mutes, and Reports calculation status
            document.getElementById('refreshAnalyzeFollowsMutesReportsBtn')?.addEventListener('click', function() {
                this.disabled = true;
                this.textContent = 'üîÑ Refreshing...';
                
                loadAnalyzeFollowsMutesReportsCalculationStatus().finally(() => {
                    this.disabled = false;
                    this.textContent = 'üîÑ Refresh';
                });
            });
            
            // Trigger Analyze Follows, Mutes, and Reports calculation (placeholder)
            document.getElementById('triggerAnalyzeFollowsMutesReportsBtn')?.addEventListener('click', function() {
                alert('Trigger calculation functionality will be implemented in a future update.');
            });
            
            // Setup event listeners for all configuration types using generalized system
            setupConfigEventListeners('graperank');
            setupConfigEventListeners('whitelist');
            setupConfigEventListeners('blacklist');
        });
    </script>
    
    <style>
        .loading-container {
            text-align: center;
            padding: 3rem;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-container {
            text-align: center;
            padding: 3rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 2rem 0;
        }
        
        .error-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .page-header {
            margin-bottom: 2rem;
        }
        
        .header-nav {
            margin-bottom: 1rem;
        }
        
        .back-link {
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        .customer-profile-section {
            margin-bottom: 2rem;
        }
        
        .profile-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .profile-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid #e9ecef;
        }
        
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 2rem;
            border: 3px solid #e9ecef;
        }
        
        .profile-info {
            flex: 1;
        }
        
        .customer-name {
            margin: 0 0 1rem 0;
            font-size: 2rem;
            font-weight: 600;
            color: #212529;
        }
        
        .customer-status {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 1rem;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .customer-about {
            color: #6c757d;
            font-size: 1.1rem;
            line-height: 1.6;
            margin: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }
        
        .profile-details, .profile-nostr {
            margin-bottom: 2rem;
        }
        
        .profile-details h3, .profile-nostr h3 {
            color: #495057;
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .details-grid, .nostr-details {
            display: grid;
            gap: 1rem;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f8f9fa;
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            font-weight: 600;
            color: #495057;
            min-width: 140px;
        }
        
        .detail-value {
            color: #6c757d;
            flex: 1;
            text-align: right;
            word-break: break-all;
        }
        
        .detail-value.pubkey {
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .detail-value a {
            color: #007bff;
            text-decoration: none;
        }
        
        .detail-value a:hover {
            text-decoration: underline;
        }
        
        .management-actions {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
        }
        
        .management-actions h3 {
            color: #495057;
            margin-bottom: 1rem;
        }
        
        .brainstorm-data-section {
            margin-bottom: 3rem;
        }
        
        .brainstorm-data-section h2, .management-actions-section h2 {
            color: #212529;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 600;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 0.5rem;
        }
        
        .data-card, .action-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .data-card h3, .action-card h3 {
            color: #495057;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .data-grid {
            display: grid;
            gap: 0.75rem;
        }
        
        .data-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f8f9fa;
        }
        
        .data-row:last-child {
            border-bottom: none;
        }
        
        .data-label {
            font-weight: 600;
            color: #495057;
            min-width: 160px;
        }
        
        .data-value {
            color: #6c757d;
            flex: 1;
            text-align: right;
        }
        
        .data-value.monospace {
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .status-indicator .status-unknown {
            color: #856404;
        }
        
        .status-indicator .status-yes {
            color: #155724;
        }
        
        .status-indicator .status-no {
            color: #721c24;
        }
        
        /* Kind 10040 Status Styling */
        .status-loading {
            color: #007bff;
            font-weight: 500;
        }
        
        .status-success {
            color: #28a745;
            font-weight: 600;
        }
        
        .status-warning {
            color: #ffc107;
            font-weight: 600;
        }
        
        .status-error {
            color: #dc3545;
            font-weight: 600;
        }
        
        .status-na {
            color: #6c757d;
            font-style: italic;
        }
        
        .status-details {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #e9ecef;
        }
        
        .status-details small {
            color: #6c757d;
            font-size: 0.75rem;
            line-height: 1.4;
        }
        
        .preset-badge .preset-default {
            background: #e9ecef;
            color: #495057;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .preset-badge .preset-rigorous {
            background: #f8d7da;
            color: #721c24;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .preset-badge .preset-permissive {
            background: #d4edda;
            color: #155724;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .preset-badge .preset-custom {
            background: #d1ecf1;
            color: #0c5460;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .management-actions-section {
            margin-bottom: 2rem;
        }
        
        .action-content {
            margin-bottom: 1rem;
        }
        
        .action-content p {
            color: #6c757d;
            margin-bottom: 1rem;
        }
        
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .danger-zone {
            border-color: #dc3545;
            background: #fff5f5;
        }
        
        /* Secure Key Styles */
        .secure-key-row {
            background: #f8f9fa;
            border-left: 3px solid #ffc107;
            padding-left: 0.5rem;
        }
        
        .secure-key-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .secure-key {
            font-family: 'Courier New', monospace;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #34495e;
            min-width: 300px;
            word-break: break-all;
            transition: all 0.3s ease;
        }
        
        .secure-key.hidden {
            background: #95a5a6;
            color: #7f8c8d;
            user-select: none;
            cursor: not-allowed;
        }
        
        .secure-key.revealed {
            background: #e74c3c;
            color: #fff;
            border-color: #c0392b;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.3);
        }
        
        .reveal-btn {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            min-width: 80px;
            transition: all 0.2s ease;
        }
        
        .reveal-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .reveal-btn.btn-warning {
            animation: pulse-warning 2s infinite;
        }
        
        @keyframes pulse-warning {
            0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
        }
        
        .status-success {
            color: #28a745;
            font-weight: 600;
        }
        
        .status-error {
            color: #dc3545;
            font-weight: 600;
        }
        
        .danger-zone h3 {
            color: #dc3545;
        }
        
        .danger-warning {
            color: #721c24;
            font-weight: 600;
            background: #f8d7da;
            padding: 0.75rem;
            border-radius: 4px;
            border-left: 4px solid #dc3545;
        }
        
        /* Calculation Status Styles */
        .calculation-status-section {
            margin-bottom: 2rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1.5rem;
            background: #f8f9fa;
        }
        
        .calculation-status-section h4 {
            color: #495057;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 0.5rem;
        }
        
        .calculation-details {
            margin-bottom: 1rem;
        }
        
        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .status-row:last-child {
            border-bottom: none;
        }
        
        .status-label {
            font-weight: 600;
            color: #495057;
            min-width: 120px;
        }
        
        .status-value {
            color: #6c757d;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-badge.status-completed {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-badge.status-in-progress {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            animation: pulse-progress 2s infinite;
        }
        
        .status-badge.status-stalled {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            animation: pulse-warning 2s infinite;
        }
        
        .status-badge.status-never {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-badge.status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-badge.status-unknown {
            background: #e2e3e5;
            color: #383d41;
            border: 1px solid #d6d8db;
        }
        
        .status-badge.loading {
            background: #e9ecef;
            color: #6c757d;
            border: 1px solid #ced4da;
        }
        
        @keyframes pulse-progress {
            0% { box-shadow: 0 0 0 0 rgba(23, 162, 184, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(23, 162, 184, 0); }
            100% { box-shadow: 0 0 0 0 rgba(23, 162, 184, 0); }
        }
        
        .log-path {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            background: #f8f9fa;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }
        
        .log-path.log-exists {
            color: #28a745;
            border-color: #28a745;
        }
        
        .log-path.log-missing {
            color: #dc3545;
            border-color: #dc3545;
        }
        
        .calculation-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 0.25rem;
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid #6c757d;
            color: #6c757d;
        }
        
        .btn-outline:hover {
            background: #6c757d;
            color: white;
        }
        
        .btn-outline:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #218838;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover:not(:disabled) {
            background: #e0a800;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-info:hover:not(:disabled) {
            background: #138496;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            background: #c82333;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn {
            display: inline-block;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0.25rem;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        @media (max-width: 768px) {
            .profile-header {
                flex-direction: column;
                text-align: center;
            }
            
            .profile-avatar {
                margin: 0 auto 1.5rem auto;
            }
            
            .customer-name {
                font-size: 1.5rem;
            }
            
            .detail-row, .data-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .detail-value, .data-value {
                text-align: left;
            }
            
            .detail-label, .data-label {
                min-width: auto;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons .btn {
                width: 100%;
            }
        }
        
        /* GrapeRank Preset Configuration Styles */
        .config-section {
            margin-top: 1rem;
        }
        
        .config-section h4 {
            color: #495057;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .preset-status-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .preset-info {
            flex: 1;
        }
        
        .preset-actions {
            flex-shrink: 0;
        }
        
        .preset-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .preset-badge.loading {
            background: #e9ecef;
            color: #6c757d;
            animation: pulse 1.5s ease-in-out infinite alternate;
        }
        
        .preset-badge.preset-permissive {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .preset-badge.preset-default {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .preset-badge.preset-restrictive {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .preset-badge.preset-custom {
            background: #e2e3e5;
            color: #383d41;
            border: 1px solid #d6d8db;
        }
        
        .preset-badge.preset-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .preset-badge.preset-unknown {
            background: #e9ecef;
            color: #6c757d;
            border: 1px solid #dee2e6;
        }
        
        .config-path {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            background: #f8f9fa;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }
        
        .config-path.exists {
            color: #155724;
            background: #d4edda;
            border-color: #c3e6cb;
        }
        
        .config-path.missing {
            color: #721c24;
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .preset-update-section {
            margin-top: 1.5rem;
            padding: 1rem;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        
        .preset-update-section h5 {
            color: #495057;
            margin-bottom: 1rem;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .preset-options {
            margin-bottom: 1.5rem;
        }
        
        .preset-option {
            margin-bottom: 0.75rem;
        }
        
        .preset-option input[type="radio"] {
            margin-right: 0.5rem;
        }
        
        .preset-label {
            display: inline-block;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }
        
        .preset-label:hover {
            background: #e9ecef;
        }
        
        .preset-option input[type="radio"]:checked + .preset-label {
            background: #007bff;
            color: white;
        }
        
        .preset-name {
            font-weight: 600;
            display: block;
        }
        
        .preset-description {
            font-size: 0.875rem;
            opacity: 0.8;
            display: block;
            margin-top: 0.25rem;
        }
        
        .preset-update-actions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .preset-warning {
            padding: 0.75rem;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            color: #856404;
        }
        
        .preset-warning p {
            margin: 0;
            font-size: 0.875rem;
        }
        
        .preset-toggle-section {
            margin-top: 1rem;
            text-align: center;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            100% { opacity: 0.5; }
        }
        
        @media (max-width: 768px) {
            .preset-status-container {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .preset-update-actions {
                flex-direction: column;
            }
            
            .preset-label {
                padding: 0.75rem;
            }
        }
        
        /* Raw Kind 10040 Note Viewer Styles */
        .raw-note-section {
            margin-top: 1rem;
            border-top: 1px solid #e9ecef;
            padding-top: 1rem;
        }
        
        .raw-note-header {
            margin-bottom: 0.75rem;
        }
        
        .toggle-btn {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .toggle-btn:hover {
            background: linear-gradient(135deg, #5a6268, #3d4043);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .toggle-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .toggle-icon {
            font-size: 1rem;
            transition: transform 0.3s ease;
        }
        
        .toggle-btn.expanded .toggle-icon {
            transform: rotate(180deg);
        }
        
        .toggle-text {
            font-size: 0.875rem;
        }
        
        .raw-note-content {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            overflow: hidden;
            margin-top: 0.75rem;
            animation: slideDown 0.3s ease-out;
        }
        
        .raw-note-data {
            background: #2d3748;
            color: #e2e8f0;
            padding: 1rem;
            margin: 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.75rem;
            line-height: 1.5;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
            border: none;
        }
        
        .raw-note-data::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .raw-note-data::-webkit-scrollbar-track {
            background: #4a5568;
        }
        
        .raw-note-data::-webkit-scrollbar-thumb {
            background: #718096;
            border-radius: 4px;
        }
        
        .raw-note-data::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                max-height: 400px;
                transform: translateY(0);
            }
        }
        
        /* Responsive adjustments for raw note viewer */
        @media (max-width: 768px) {
            .raw-note-data {
                font-size: 0.7rem;
                padding: 0.75rem;
            }
            
            .toggle-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
        }
    </style>
</body>
</html>