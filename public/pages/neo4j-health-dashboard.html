<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neo4j Health Dashboard - Brainstorm</title>
    <link rel="stylesheet" href="../css/neo4j-health-dashboard.css">
    <link rel="shortcut icon" href="/control/img/brainstorm010.svg">
    <script src="./components/header/header.js"></script>
    <script src="./components/footer/footer.js"></script>
    <script src="/libs/chart.js/chart.min.js"></script>
    <script src="/libs/chartjs-adapter-date-fns/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>
<body>
    <!-- Include the header component -->
    <div id="headerContainer"></div>
    
    <!-- Main content wrapper -->
    <div class="page-content">
        <div class="container">
            <div class="dashboard-container">
            <header>
                <h1>üîç Neo4j Health Dashboard</h1>
                <p>Comprehensive Neo4j stability monitoring and crash pattern detection</p>
            </header>
            
            <div class="refresh-controls">
                <div class="auto-refresh">
                    <label>
                        <input type="checkbox" id="autoRefresh" checked> Auto-refresh (30s)
                    </label>
                    <button class="btn btn-primary" onclick="refreshDashboard()">üîÑ Refresh Now</button>
                </div>
                <div>
                    <span id="lastUpdated">Last updated: Never</span>
                </div>
            </div>
            
            <div class="dashboard-grid">
                <!-- Service Status Card -->
                <div class="health-card" id="serviceStatusCard">
                    <div class="card-header">
                        <h3 class="card-title">üöÄ Service Status</h3>
                        <span class="status-badge" id="serviceStatus">Loading...</span>
                    </div>
                    <div id="serviceMetrics">
                        <div class="metric-row">
                            <span class="metric-label">Process ID:</span>
                            <span class="metric-value" id="neo4jPid">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Memory Usage:</span>
                            <span class="metric-value" id="memoryUsage">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Connection Test:</span>
                            <span class="metric-value" id="connectionTest">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Response Time:</span>
                            <span class="metric-value" id="responseTime">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Heap Health Card -->
                <div class="health-card" id="heapHealthCard">
                    <div class="card-header">
                        <h3 class="card-title">üß† Heap Health</h3>
                        <span class="status-badge" id="heapStatus">Loading...</span>
                    </div>
                    <div id="heapMetrics">
                        <div class="metric-row">
                            <span class="metric-label">Heap Utilization:</span>
                            <span class="metric-value" id="heapUtilization">-</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="heapProgressBar" style="width: 0%"></div>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Used / Total:</span>
                            <span class="metric-value" id="heapUsedTotal">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">GC Overhead:</span>
                            <span class="metric-value" id="gcOverhead">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Full GC Count:</span>
                            <span class="metric-value" id="fullGcCount">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Index Health Card -->
                <div class="health-card" id="indexHealthCard">
                    <div class="card-header">
                        <h3 class="card-title">üìä Index Health</h3>
                        <span class="status-badge" id="indexStatus">Loading...</span>
                    </div>
                    <div id="indexMetrics">
                        <div class="metric-row">
                            <span class="metric-label">Total Indexes:</span>
                            <span class="metric-value" id="totalIndexes">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Failed Indexes:</span>
                            <span class="metric-value" id="failedIndexes">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Constraints:</span>
                            <span class="metric-value" id="totalConstraints">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Query Timeout:</span>
                            <span class="metric-value" id="queryTimeout">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Crash Patterns Card -->
                <div class="health-card" id="crashPatternsCard">
                    <div class="card-header">
                        <h3 class="card-title">‚ö†Ô∏è Crash Patterns</h3>
                        <span class="status-badge" id="crashPatternStatus">Loading...</span>
                    </div>
                    <div id="crashPatternMetrics">
                        <div class="metric-row">
                            <span class="metric-label">Heap Space OOM:</span>
                            <span class="metric-value" id="heapSpaceOom">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">GC Overhead OOM:</span>
                            <span class="metric-value" id="gcOverheadOom">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">APOC Stalling:</span>
                            <span class="metric-value" id="apocStalling">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Long Transactions:</span>
                            <span class="metric-value" id="longTransactions">-</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Alerts Section -->
            <div class="health-card">
                <div class="card-header">
                    <h3 class="card-title">üö® Recent Health Alerts</h3>
                    <button class="btn btn-secondary" onclick="clearAlerts()">Clear Alerts</button>
                </div>
                <div class="alert-list" id="alertsList">
                    <p>Loading alerts...</p>
                </div>
            </div>
            
            <!-- Heap Usage Time Series -->
            <div class="health-card">
                <div class="card-header">
                    <h3 class="card-title">üìà Heap Usage Over Time</h3>
                    <div class="chart-controls">
                        <select id="timeRangeSelect" onchange="updateTimeRange()">
                            <option value="6">Last 6 hours</option>
                            <option value="12">Last 12 hours</option>
                            <option value="24" selected>Last 24 hours</option>
                            <option value="48">Last 48 hours</option>
                            <option value="168">Last week</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container" style="height: 400px;">
                    <canvas id="heapChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval;
        let dashboardData = {};
        let heapChart = null;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            refreshDashboard();
            setupAutoRefresh();
            initializeHeapChart();
        });
        
        // Setup auto-refresh
        function setupAutoRefresh() {
            const autoRefreshCheckbox = document.getElementById('autoRefresh');
            
            if (autoRefreshCheckbox.checked) {
                autoRefreshInterval = setInterval(refreshDashboard, 30000);
            }
            
            autoRefreshCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    autoRefreshInterval = setInterval(refreshDashboard, 30000);
                } else {
                    clearInterval(autoRefreshInterval);
                }
            });
        }
        
        // Main refresh function
        async function refreshDashboard() {
            try {
                document.body.classList.add('loading');
                
                // Also update heap chart on refresh
                if (heapChart) {
                    await updateHeapChart();
                }
                
                // Fetch Neo4j health data
                const healthResponse = await fetch('/api/neo4j-health/complete');
                const healthData = await healthResponse.json();
                
                // Fetch recent alerts
                const alertsResponse = await fetch('/api/neo4j-health/alerts?component=neo4j&limit=20');
                const alertsData = await alertsResponse.json();
                
                // Update dashboard
                updateServiceStatus(healthData.service || {});
                updateHeapHealth(healthData.heap || {});
                updateIndexHealth(healthData.indexes || {});
                updateCrashPatterns(healthData.crashPatterns || {});
                updateAlerts(alertsData.alerts || []);
                
                // Update timestamp
                document.getElementById('lastUpdated').textContent = 
                    `Last updated: ${new Date().toLocaleTimeString()}`;
                
            } catch (error) {
                console.error('Failed to refresh dashboard:', error);
                showError('Failed to fetch Neo4j health data');
            } finally {
                document.body.classList.remove('loading');
            }
        }
        
        // Update service status card
        function updateServiceStatus(data) {
            const card = document.getElementById('serviceStatusCard');
            const statusBadge = document.getElementById('serviceStatus');
            
            if (data.status === 'running') {
                card.className = 'health-card success';
                statusBadge.className = 'status-badge status-running';
                statusBadge.textContent = 'Running';
            } else {
                card.className = 'health-card critical';
                statusBadge.className = 'status-badge status-critical';
                statusBadge.textContent = 'Down';
            }
            
            document.getElementById('neo4jPid').textContent = data.pid || 'N/A';
            document.getElementById('memoryUsage').textContent = data.memoryMB ? `${data.memoryMB} MB` : 'N/A';
            document.getElementById('connectionTest').textContent = data.connectionTest || 'Unknown';
            document.getElementById('responseTime').textContent = data.responseTime || 'N/A';
        }
        
        // Update heap health card
        function updateHeapHealth(data) {
            const card = document.getElementById('heapHealthCard');
            const statusBadge = document.getElementById('heapStatus');
            const progressBar = document.getElementById('heapProgressBar');
            
            const heapPercent = data.utilizationPercent || 0;
            
            if (heapPercent >= 95) {
                card.className = 'health-card critical';
                statusBadge.className = 'status-badge status-critical';
                statusBadge.textContent = 'Critical';
                progressBar.className = 'progress-fill progress-critical';
            } else if (heapPercent >= 80) {
                card.className = 'health-card warning';
                statusBadge.className = 'status-badge status-warning';
                statusBadge.textContent = 'Warning';
                progressBar.className = 'progress-fill progress-warning';
            } else {
                card.className = 'health-card success';
                statusBadge.className = 'status-badge status-running';
                statusBadge.textContent = 'Healthy';
                progressBar.className = 'progress-fill progress-normal';
            }
            
            progressBar.style.width = `${heapPercent}%`;
            
            document.getElementById('heapUtilization').textContent = `${heapPercent}%`;
            document.getElementById('heapUsedTotal').textContent = 
                data.usedMB && data.totalMB ? `${data.usedMB} / ${data.totalMB} MB` : 'N/A';
            document.getElementById('gcOverhead').textContent = data.gcOverheadPercent ? `${data.gcOverheadPercent}%` : 'N/A';
            document.getElementById('fullGcCount').textContent = data.fullGcCount || '0';
        }
        
        // Update index health card
        function updateIndexHealth(data) {
            const card = document.getElementById('indexHealthCard');
            const statusBadge = document.getElementById('indexStatus');
            
            const failedIndexes = data.failedIndexes || 0;
            const totalIndexes = data.totalIndexes || 0;
            
            if (failedIndexes > 0) {
                card.className = 'health-card critical';
                statusBadge.className = 'status-badge status-critical';
                statusBadge.textContent = 'Issues';
            } else if (totalIndexes < 5) {
                card.className = 'health-card warning';
                statusBadge.className = 'status-badge status-warning';
                statusBadge.textContent = 'Insufficient';
            } else {
                card.className = 'health-card success';
                statusBadge.className = 'status-badge status-running';
                statusBadge.textContent = 'Healthy';
            }
            
            document.getElementById('totalIndexes').textContent = totalIndexes;
            document.getElementById('failedIndexes').textContent = failedIndexes;
            document.getElementById('totalConstraints').textContent = data.totalConstraints || '0';
            document.getElementById('queryTimeout').textContent = data.queryTimeout ? 'Yes' : 'No';
        }
        
        // Update crash patterns card
        function updateCrashPatterns(data) {
            const card = document.getElementById('crashPatternsCard');
            const statusBadge = document.getElementById('crashPatternStatus');
            
            const totalIssues = (data.heapSpaceOom || 0) + (data.gcOverheadOom || 0) + 
                              (data.apocStalling || 0) + (data.longTransactions || 0);
            
            if (totalIssues > 0) {
                card.className = 'health-card warning';
                statusBadge.className = 'status-badge status-warning';
                statusBadge.textContent = `${totalIssues} Issues`;
            } else {
                card.className = 'health-card success';
                statusBadge.className = 'status-badge status-running';
                statusBadge.textContent = 'No Issues';
            }
            
            document.getElementById('heapSpaceOom').textContent = data.heapSpaceOom || '0';
            document.getElementById('gcOverheadOom').textContent = data.gcOverheadOom || '0';
            document.getElementById('apocStalling').textContent = data.apocStalling || '0';
            document.getElementById('longTransactions').textContent = data.longTransactions || '0';
        }
        
        // Update alerts list
        function updateAlerts(alerts) {
            const alertsList = document.getElementById('alertsList');
            
            if (!alerts || alerts.length === 0) {
                alertsList.innerHTML = '<p>No recent alerts</p>';
                return;
            }
            
            const alertsHtml = alerts.map(alert => {
                const alertClass = alert.severity === 'critical' ? 'alert-critical' : 'alert-warning';
                const timestamp = new Date(alert.timestamp).toLocaleString();
                
                return `
                    <div class="alert-item ${alertClass}">
                        <strong>${alert.alertType}</strong>: ${alert.message}
                        <div class="alert-timestamp">${timestamp}</div>
                        ${alert.recommendedAction ? `<div><em>Action: ${alert.recommendedAction}</em></div>` : ''}
                    </div>
                `;
            }).join('');
            
            alertsList.innerHTML = alertsHtml;
        }
        
        // Clear alerts
        async function clearAlerts() {
            try {
                await fetch('/api/health-alerts/clear', { method: 'POST' });
                document.getElementById('alertsList').innerHTML = '<p>No recent alerts</p>';
            } catch (error) {
                console.error('Failed to clear alerts:', error);
            }
        }
        
        // Initialize heap usage chart
        async function initializeHeapChart() {
            const ctx = document.getElementById('heapChart').getContext('2d');
            
            heapChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Heap Utilization %',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'GC Overhead %',
                        data: [],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time'
                            },
                            type: 'time',
                            time: {
                                displayFormats: {
                                    minute: 'HH:mm',
                                    hour: 'MMM dd HH:mm'
                                }
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Heap Utilization %'
                            },
                            min: 0,
                            max: 100,
                            grid: {
                                drawOnChartArea: true,
                            },
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'GC Overhead %'
                            },
                            min: 0,
                            max: 20,
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                afterBody: function(context) {
                                    const dataIndex = context[0].dataIndex;
                                    const data = heapChart.data.datasets[0].rawData;
                                    if (data && data[dataIndex]) {
                                        const point = data[dataIndex];
                                        return [
                                            `Heap Used: ${point.heapUsedMB} MB`,
                                            `Heap Total: ${point.heapTotalMB} MB`,
                                            `Young GC: ${point.youngGcCount}`,
                                            `Full GC: ${point.fullGcCount}`
                                        ];
                                    }
                                    return [];
                                }
                            }
                        }
                    }
                }
            });
            
            // Load initial data
            await updateHeapChart();
        }
        
        // Update heap chart with new data
        async function updateHeapChart() {
            try {
                const timeRange = document.getElementById('timeRangeSelect').value;
                const response = await fetch(`/api/neo4j-health/heap-metrics-history?hours=${timeRange}&maxPoints=100`);
                const result = await response.json();
                
                if (!result.success) {
                    console.error('Failed to fetch heap metrics:', result.error);
                    return;
                }
                
                const data = result.data;
                if (data.length === 0) {
                    heapChart.data.labels = [];
                    heapChart.data.datasets[0].data = [];
                    heapChart.data.datasets[1].data = [];
                    heapChart.update();
                    return;
                }
                
                // Prepare chart data
                const labels = data.map(point => new Date(point.timestamp));
                const heapUtilization = data.map(point => point.heapUtilizationPercent);
                const gcOverhead = data.map(point => point.gcOverheadPercent);
                
                // Store raw data for tooltips
                heapChart.data.datasets[0].rawData = data;
                
                // Update chart
                heapChart.data.labels = labels;
                heapChart.data.datasets[0].data = heapUtilization;
                heapChart.data.datasets[1].data = gcOverhead;
                heapChart.update();
                
                console.log(`Updated heap chart with ${data.length} data points`);
                
            } catch (error) {
                console.error('Error updating heap chart:', error);
            }
        }
        
        // Update time range
        async function updateTimeRange() {
            await updateHeapChart();
        }
        
        // Show error message
        function showError(message) {
            const alertsList = document.getElementById('alertsList');
            alertsList.innerHTML = `<div class="alert-item alert-critical">${message}</div>`;
        }
    </script>
    </div>
    
    <!-- Include the footer component -->
    <div id="footerContainer"></div>
</body>
</html>
