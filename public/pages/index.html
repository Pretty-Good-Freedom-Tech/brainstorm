<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hasenpfeffr</title>
    <link rel="stylesheet" href="/control/css/index.css">
    <script src="./components/header/header.js"></script>
</head>
<body>
    <!-- Include the header component -->
    <div id="headerContainer"></div>

    <div class="container">
        <div class="master-control">
            <h2>Hasenpfeffr Relay Setup Page</h2>
            <h3>Setup</h3>
            <div style="text-align: left;">
                <p>1. Change Neo4j password in the neo4j browser to the one you provided during installation.</p>
                <p>2. Turn on Databases, Streaming, and Routine Tasks toggle buttons.</p>
                <p>3. Wait for all Routine Tasks (below) to complete at least once.</p>
                <p>4. Turn on the Stream Filtered Content toggle button. This will start streaming filtered content to your relay!</p>
            </div>
            <h3>Use</h3>
            <div style="text-align: left;">
                <p>1. Stream filtered content.</p>
                <p>2. Find new follows (follows recs page: work in progress).</p>
                <p>3. Encourage your favorite client devs to incorporate your personalized WoT scores using NIP-85!</p>
            </div>
            <h3>Customize</h3>
            <div style="text-align: left;">
                <p>1. Modify whitelist parameters.</p>
                <p>2. Modify blacklist parameters.</p>
                <p>3. Modify GrapeRank parameters.</p>
                <p>4. More customization options coming soon!</p>
            </div>
        </div>
        <!-- New Service Toggle Section -->
        <div class="service-toggles-container">
            <h3>Service Controls <span style="position: relative; display: inline-block;"><span class="info-icon">i</span><span class="tooltip">Toggle individual components of the system. Each button controls multiple services.</span></span></h3>
            <div class="service-toggles">
                <div class="service-toggle-item">
                    <h4>Databases <span style="position: relative; display: inline-block;"><span class="info-icon">i</span><span class="tooltip">Controls Neo4j and strfry database services.</span></span></h4>
                    <div class="toggle-container">
                        <span class="toggle-label">Toggle strfry and neo4j on/off.</span>
                        <label class="switch">
                            <input type="checkbox" id="databasesToggle" onchange="toggleService('databases', this.checked)">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
                <div class="service-toggle-item">
                    <h4>Streaming <span style="position: relative; display: inline-block;"><span class="info-icon">i</span><span class="tooltip">Controls the ETL pipeline streaming services that process FOLLOWS, MUTES, and REPORTS relationships in real-time.</span></span></h4>
                    <div class="toggle-container">
                        <span class="toggle-label">Stream follows, mutes, and reports in real time.</span>
                        <label class="switch">
                            <input type="checkbox" id="streamingToggle" onchange="toggleService('streaming', this.checked)">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
                <div class="service-toggle-item">
                    <h4>Routine Tasks <span style="position: relative; display: inline-block;"><span class="info-icon">i</span><span class="tooltip">Controls the timer service that regularly: <li>negentropy sync</li><li>calculate scores</li><li>update blacklist, whitelist, and NIP-85</li></span></span></h4>
                    <div class="toggle-container">
                        <span class="toggle-label">Routine recalculation of GrapeRank and other scores.</span>
                        <label class="switch">
                            <input type="checkbox" id="scoresToggle" onchange="toggleService('scores', this.checked)">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
                <div class="service-toggle-item">
                    <h4>Stream Filtered Content <span style="position: relative; display: inline-block;"><span class="info-icon">i</span><span class="tooltip">Controls whether content events (kinds 1, 7, 30818, etc.) from whitelisted users are streamed through the relay.</span></span></h4>
                    <div class="toggle-container">
                        <span class="toggle-label">Stream content from whitelisted users only.</span>
                        <label class="switch">
                            <input type="checkbox" id="contentFilterToggle" onchange="toggleFilteredContent(this.checked)">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div id="contentFilterStatus" class="mini-status"></div>
                </div>
            </div>
        </div>

        <h3>Routine tasks <span style="position: relative; display: inline-block; text-align: left;"><span class="info-icon">i</span><span class="tooltip">These tasks are run automatically every 6 hours when the processAllTasks systemd service timer is turned on. Alternatively, you can run them one at a time using the buttons below.</span></span></h3>
        <div class="calculation-status">
            <h3>Negentropy: download events in batch to strfry</h3>
            <div class="calculation-grid">
                <div class="calculation-item">
                    <div class="calculation-item-content">
                        <h4>FOLLOWS, MUTES, & REPORTS <span class="info-icon">i</span><span class="tooltip">Use negentropy to download all available kinds 3, 1984, and 1000 events from wss://relay.hasenpfeffr.com</span></h4>
                        <p id="syncWoT-last-calculation-time" class="timestamp"></p>
                        <p id="syncWoT-last-calculation-duration" class="duration"></p>
                    </div>
                    <div class="calculation-actions">
                        <button class="action-btn">Run</button>
                        <div class="progress-container">
                            <div class="progress-bar"></div>
                        </div>
                        <span class="progress-text">0%</span>
                    </div>
                </div>
                <div class="calculation-item">
                    <div class="calculation-item-content">
                        <h4>Profiles <span class="info-icon">i</span><span class="tooltip">Use negentropy to download all available kind 0 events from wss://profiles.nostr1.com</span></h4>
                        <p id="syncProfiles-last-calculation-time" class="timestamp"></p>
                        <p id="syncProfiles-last-calculation-duration" class="duration"></p>
                    </div>
                    <div class="calculation-actions">
                        <button class="action-btn">Run</button>
                        <div class="progress-container">
                            <div class="progress-bar"></div>
                        </div>
                        <span class="progress-text">0%</span>
                    </div>
                </div>
                <div class="calculation-item">
                    <div class="calculation-item-content">
                        <h4>Personal <span class="info-icon">i</span><span class="tooltip">Use negentropy to download all available personal events from wss://relay.primal.net</span></h4>
                        <p id="syncPersonal-last-calculation-time" class="timestamp"></p>
                        <p id="syncPersonal-last-calculation-duration" class="duration"></p>
                    </div>
                    <div class="calculation-actions">
                        <button class="action-btn">Run</button>
                        <div class="progress-container">
                            <div class="progress-bar"></div>
                        </div>
                        <span class="progress-text">0%</span>
                    </div>
                </div>
            </div>
            <br/>
            <h3>Transfer from strfry to Neo4j</h3>
            <div class="calculation-grid">
                <div class="calculation-item">
                    <div class="calculation-item-content">
                        <h4>Batch Transfer <span class="info-icon">i</span><span class="tooltip">Batch transfer follows, mutes, reports and related pubkeys from strfry to Neo4j. This is typically performed ONLY ONCE when setting up your relay for the first time. Thereafter, the Reconciliation task takes over routine transfers.</span></h4>
                        <p id="batchTransfer-last-calculation-time" class="timestamp"></p>
                        <p id="batchTransfer-last-calculation-duration" class="duration"></p>
                    </div>
                    <div class="calculation-actions">
                        <button class="action-btn">Run</button>
                        <div class="progress-container">
                            <div class="progress-bar"></div>
                        </div>
                        <span class="progress-text">0%</span>
                    </div>
                </div>
                <div class="calculation-item">
                    <div class="calculation-item-content">
                        <h4>Reconciliation <span class="info-icon">i</span><span class="tooltip">Reconciles Neo4j database with strfry. This erases obsolete follows!</span></h4>
                        <p id="reconciliation-last-calculation-time" class="timestamp"></p>
                        <p id="reconciliation-last-calculation-duration" class="duration"></p>
                    </div>
                    <div class="calculation-actions">
                        <button class="action-btn">Run</button>
                        <div class="progress-container">
                            <div class="progress-bar"></div>
                        </div>
                        <span class="progress-text">0%</span>
                    </div>
                </div>
            </div>
            <br/>
            <h3>Webs of Trust Score Calculations</h3>
            <div class="calculation-grid">
                <div class="calculation-item">
                    <div class="calculation-item-content">
                        <h4>Hops <span class="info-icon">i</span><span class="tooltip">Calculates network distance (hops) between users in the Web of Trust based on FOLLOWS relationships in Neo4j</span></h4>
                        <p id="hops-last-calculation-time" class="timestamp"></p>
                        <p id="hops-last-calculation-duration" class="duration"></p>
                    </div>
                    <div class="calculation-actions">
                        <button class="action-btn">Run</button>
                        <div class="progress-container">
                            <div class="progress-bar"></div>
                        </div>
                        <span class="progress-text">0%</span>
                    </div>
                </div>
                <div class="calculation-item">
                    <div class="calculation-item-content">
                        <h4>PageRank <span class="info-icon">i</span><span class="tooltip">Calculates importance scores using the personalized PageRank algorithm on the FOLLOWS relationships in Neo4j</span></h4>
                        <p id="pageRank-last-calculation-time" class="timestamp"></p>
                        <p id="pageRank-last-calculation-duration" class="duration"></p>
                    </div>
                    <div class="calculation-actions">
                        <button class="action-btn">Run</button>
                        <div class="progress-container">
                            <div class="progress-bar"></div>
                        </div>
                        <span class="progress-text">0%</span>
                    </div>
                </div>
                <div class="calculation-item">
                    <div class="calculation-item-content">
                        <h4>GrapeRank <span class="info-icon">i</span><span class="tooltip">Personalized ranking algorithm that considers FOLLOWS (positive), MUTES (negative), and REPORTS (negative) relationships with configurable weights</span></h4>
                        <p id="grapeRank-last-calculation-time" class="timestamp"></p>
                        <p id="grapeRank-last-calculation-duration" class="duration"></p>
                    </div>
                    <div class="calculation-actions">
                        <button class="action-btn">Run</button>
                        <div class="progress-container">
                            <div class="progress-bar"></div>
                        </div>
                        <span class="progress-text">0%</span>
                    </div>
                </div>
            </div>
            <br/>
            <h3>Webs of Trust Score Export</h3>
            <div class="calculation-grid">
                <div class="calculation-item">
                    <div class="calculation-item-content">
                        <h4>Whitelist <span class="info-icon">i</span><span class="tooltip">Generates a whitelist of pubkeys based on GrapeRank scores for content filtering in the strfry relay</span></h4>
                        <p id="whitelist-last-calculation-time" class="timestamp"></p>
                        <p id="whitelist-last-calculation-duration" class="duration"></p>
                    </div>
                    <div class="calculation-actions">
                        <button class="action-btn">Run</button>
                        <div class="progress-container">
                            <div class="progress-bar"></div>
                        </div>
                        <span class="progress-text">0%</span>
                    </div>
                </div>
                <div class="calculation-item">
                    <div class="calculation-item-content">
                        <h4>Blacklist <span class="info-icon">i</span><span class="tooltip">Generates a blacklist of pubkeys based on negative ratings from MUTES and REPORTS relationships</span></h4>
                        <p id="blacklist-last-calculation-time" class="timestamp"></p>
                        <p id="blacklist-last-calculation-duration" class="duration"></p>
                    </div>
                    <div class="calculation-actions">
                        <button class="action-btn">Run</button>
                        <div class="progress-container">
                            <div class="progress-bar"></div>
                        </div>
                        <span class="progress-text">0%</span>
                    </div>
                </div>
                <div class="calculation-item">
                    <div class="calculation-item-content">
                        <h4>NIP-85 Export <span class="info-icon">i</span><span class="tooltip">Exports Web of Trust scores as Trusted Assertions following NIP-85 kind 30382 events that can be shared with other relays and clients. TODO: ALSO PUBLISH KIND 10040 EVENT.</span></h4>
                        <p id="nip85-last-calculation-time" class="timestamp"></p>
                        <p id="nip85-last-calculation-duration" class="duration"></p>
                    </div>
                    <div class="calculation-actions">
                        <button class="action-btn">Run</button>
                        <div class="progress-container">
                            <div class="progress-bar"></div>
                        </div>
                        <span class="progress-text">0%</span>
                    </div>
                </div>
            </div>
            <button class="refresh-btn" onclick="refreshCalculationTimes()">Refresh</button>
        </div>

        <div class="section">
            <h2>Hasenpfeffr Systemd Services</h2>
            <div class="card">
                <h3>Service Status and Control</h3>
                <p>Manage and monitor Hasenpfeffr systemd services.</p>
                <button id="refreshServicesBtn" class="refresh-btn">Refresh Status</button>
                <div id="servicesStatus" class="status" style="display: none;"></div>
                <div id="servicesContainer" style="margin-top: 15px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="text-align: left; padding: 8px; border-bottom: 2px solid #3498db;">Service</th>
                                <th style="text-align: center; padding: 8px; border-bottom: 2px solid #3498db;">Status</th>
                                <th style="text-align: right; padding: 8px; border-bottom: 2px solid #3498db;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="servicesTableBody">
                            <!-- Service rows will be added here dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Load the header component
        fetch('./components/header/header.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('headerContainer').innerHTML = html;
                // Re-initialize the header after loading
                initializeHeader();
            })
            .catch(error => {
                console.error('Error loading header component:', error);
            });

        // Check services status on page load
        document.addEventListener('DOMContentLoaded', function() {
            refreshCalculationTimes();
            checkServicesStatus();
            loadServicesStatus();
            initializeActionButtons();
            
            // Check status of individual service groups
            checkServiceGroupStatus('databases');
            checkServiceGroupStatus('streaming');
            checkServiceGroupStatus('scores');
            
            // Check content filter status
            checkFilteredContentStatus();
            
            // Set up periodic refresh
            setInterval(function() {
                refreshCalculationTimes();
                checkServicesStatus();
                loadServicesStatus();
                
                // Refresh service group status
                checkServiceGroupStatus('databases');
                checkServiceGroupStatus('streaming');
                checkServiceGroupStatus('scores');
                
                // Also refresh content filter status
                checkFilteredContentStatus();
            }, 60000); // Refresh every minute
        });

        // Define service groups and their member services
        const serviceGroups = {
            databases: {
                services: ['neo4j', 'strfry'],
                scripts: {
                    on: '/usr/local/lib/node_modules/hasenpfeffr/src/manage/databases/turnOn.sh',
                    off: '/usr/local/lib/node_modules/hasenpfeffr/src/manage/databases/turnOff.sh'
                }
            },
            streaming: {
                services: ['addToQueue', 'processQueue', 'strfry-router'],
                scripts: {
                    on: '/usr/local/lib/node_modules/hasenpfeffr/src/manage/streamingServices/turnOn.sh',
                    off: '/usr/local/lib/node_modules/hasenpfeffr/src/manage/streamingServices/turnOff.sh'
                }
            },
            scores: {
                services: ['processAllTasks.timer'],
                scripts: {
                    on: '/usr/local/lib/node_modules/hasenpfeffr/src/manage/routineTasks/turnOn.sh',
                    off: '/usr/local/lib/node_modules/hasenpfeffr/src/manage/routineTasks/turnOff.sh'
                }
            },
            content: {
                // Special handling for the content filter which uses the strfry plugin API
                specialHandling: true
            }
        };

        // Check status of a service group
        function checkServiceGroupStatus(groupName) {
            const group = serviceGroups[groupName];
            if (!group) return;

            console.log(`Checking status for ${groupName} services:`, group.services);
            
            const toggleButton = document.getElementById(`${groupName}Toggle`);
            if (toggleButton) {
                toggleButton.disabled = true;
            }

            const serviceStatusPromises = group.services.map(service => {
                console.log(`Fetching status for service: ${service}`);
                return fetch(`/control/api/service-status?service=${service}`)
                    .then(response => {
                        console.log(`Response for ${service}:`, response);
                        if (!response.ok) {
                            throw new Error(`Server returned ${response.status} for ${service}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log(`Service ${service} status data:`, data);
                        return {
                            service: service,
                            active: data.services && data.services[service] === 'active'
                        };
                    })
                    .catch(error => {
                        console.error(`Error checking ${service} status:`, error);
                        return {
                            service: service,
                            active: false,
                            error: error.message
                        };
                    });
            });

            Promise.all(serviceStatusPromises)
                .then(statusResults => {
                    console.log(`All ${groupName} status results:`, statusResults);
                    updateServiceGroupUI(groupName, statusResults);
                })
                .catch(error => {
                    console.error(`Error in Promise.all for ${groupName}:`, error);
                    updateServiceGroupUI(groupName, []);
                });
        }

        // Update UI for service group based on status
        function updateServiceGroupUI(groupName, statusResults) {
            console.log(`Updating UI for ${groupName} with:`, statusResults);
            
            const toggleButton = document.getElementById(`${groupName}Toggle`);
            
            if (!toggleButton) {
                console.error(`Missing toggle button for ${groupName}`);
                return;
            }
            
            // Re-enable the toggle
            toggleButton.disabled = false;
            
            if (!statusResults || statusResults.length === 0) {
                // Error or unknown state
                toggleButton.checked = false;
                console.log(`${groupName} status: Unknown (no results)`);
                return;
            }
            
            // Count active services
            const activeCount = statusResults.filter(result => result.active).length;
            console.log(`${groupName} has ${activeCount} active out of ${statusResults.length} total services`);
            
            if (activeCount === 0) {
                // All services are off
                toggleButton.checked = false;
                console.log(`${groupName} status: All Off`);
            } else if (activeCount === statusResults.length) {
                // All services are on
                toggleButton.checked = true;
                console.log(`${groupName} status: All On`);
            } else {
                // Some services are on, some are off
                toggleButton.checked = false;
                console.log(`${groupName} status: Partial (${activeCount}/${statusResults.length} on)`);
            }
        }

        // Toggle service group
        function toggleService(groupName, checked) {
            const group = serviceGroups[groupName];
            if (!group) return;
            
            const toggleButton = document.getElementById(`${groupName}Toggle`);
            
            // Determine action based on checked state
            const action = checked ? 'on' : 'off';
            
            // Disable button during operation
            toggleButton.disabled = true;
            
            console.log(`Toggling ${groupName} ${action}`);
            
            // Call the appropriate script
            fetch(`/control/api/run-script`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    script: group.scripts[action]
                })
            })
            .then(response => response.json())
            .then(data => {
                // Re-enable button
                toggleButton.disabled = false;
                
                if (data.success) {
                    console.log(`Successfully toggled ${groupName} ${action}`);
                    // Wait a moment for services to fully start/stop
                    setTimeout(() => {
                        checkServiceGroupStatus(groupName);
                    }, 2000);
                } else {
                    console.error(`Error ${action === 'on' ? 'starting' : 'stopping'} ${groupName}:`, data.error);
                    alert(`Failed to ${action === 'on' ? 'start' : 'stop'} ${groupName} services. Check the console for details.`);
                    // Set toggle back to previous state
                    toggleButton.checked = !checked;
                    checkServiceGroupStatus(groupName);
                }
            })
            .catch(error => {
                console.error(`Error ${action === 'on' ? 'starting' : 'stopping'} ${groupName}:`, error);
                alert(`Failed to ${action === 'on' ? 'start' : 'stop'} ${groupName} services. Check the console for details.`);
                toggleButton.disabled = false;
                // Set toggle back to previous state
                toggleButton.checked = !checked;
                checkServiceGroupStatus(groupName);
            });
        }

        // Check services status on page load
        function checkServicesStatus() {
            // For now, we'll just check if the strfry service is running
            fetch('/control/api/service-status?service=strfry')
                .then(response => response.json())
                .then(data => {
                    updateStatusUI(data.running ? 'on' : 'off');
                })
                .catch(error => {
                    console.error('Error checking services status:', error);
                    updateStatusUI('unknown');
                });
        }

        function updateStatusUI(status) {
            const statusText = document.getElementById('statusText');
            
            if (status === 'on') {
                statusText.textContent = 'Running';
                document.getElementById('turnOnButton').disabled = true;
                document.getElementById('turnOffButton').disabled = false;
            } else if (status === 'off') {
                statusText.textContent = 'Stopped';
                document.getElementById('turnOnButton').disabled = false;
                document.getElementById('turnOffButton').disabled = true;
            } else {
                statusText.textContent = 'Unknown';
                document.getElementById('turnOnButton').disabled = false;
                document.getElementById('turnOffButton').disabled = false;
            }
        }

        function controlHasenpfeffr(action) {
            // Show loading state
            const statusText = document.getElementById('statusText');
            statusText.textContent = action === 'on' ? 'Starting...' : 'Stopping...';
            
            // Disable both buttons during operation
            document.getElementById('turnOnButton').disabled = true;
            document.getElementById('turnOffButton').disabled = true;
            
            // Show status details
            const statusDetails = document.getElementById('statusDetails');
            statusDetails.style.display = 'block';
            statusDetails.innerHTML = `<p>Executing ${action === 'on' ? 'startup' : 'shutdown'} script...</p>`;
            
            // Call the API - use the /control/api path to ensure proper routing
            fetch('/control/api/hasenpfeffr-control', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // Include credentials to ensure cookies are sent
                    'credentials': 'same-origin'
                },
                body: JSON.stringify({ action }),
            })
            .then(response => {
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                }
                // If not JSON, it might be a redirect to login page or other HTML
                throw new Error('Received non-JSON response. You may need to log in first.');
            })
            .then(data => {
                if (data.success) {
                    updateStatusUI(action);
                    statusDetails.innerHTML += `<p>${data.message}</p>`;
                    if (data.output) {
                        statusDetails.innerHTML += `<pre>${data.output}</pre>`;
                    }
                } else {
                    updateStatusUI('unknown');
                    statusDetails.innerHTML += `<p>Error: ${data.error}</p>`;
                }
            })
            .catch(error => {
                console.error(`Error turning Hasenpfeffr ${action}:`, error);
                
                // If it seems like an authentication issue, suggest logging in
                if (error.message.includes('non-JSON') || error.message.includes('Unexpected token')) {
                    statusDetails.innerHTML += `<p>This may be an authentication issue. Please ensure you're logged in to the control panel.</p>`;
                }
                
                // Re-enable buttons
                document.getElementById('turnOnButton').disabled = false;
                document.getElementById('turnOffButton').disabled = false;
            });
        }

        function refreshCalculationTimes() {
            loadCalculationTimes();
        }
        
        function loadCalculationTimes() {
            // Show loading state for all calculation items
            const calculationItems = ['hops', 'pageRank', 'grapeRank', 'whitelist', 'blacklist', 'nip85', 'syncWoT', 'syncPersonal', 'syncProfiles', 'batchTransfer', 'reconciliation'];
            
            calculationItems.forEach(item => {
                const element = document.getElementById(`${item}-last-calculation-time`);
                if (element) {
                    element.innerHTML = '<span class="loading"></span> Loading...';
                }
                const durationElement = document.getElementById(`${item}-last-calculation-duration`);
                if (durationElement) {
                    durationElement.innerHTML = '';
                }
            });
            
            fetch('/control/api/calculation-status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update each calculation item with its status
                        console.log('Calculation status data:', data);
                        calculationItems.forEach(item => {
                            const element = document.getElementById(`${item}-last-calculation-time`);
                            const durationElement = document.getElementById(`${item}-last-calculation-duration`);
                            
                            // Get the parent calculation-item element
                            const calculationItem = element ? element.closest('.calculation-item') : null;
                            
                            if (element && calculationItem && data.status[item]) {
                                const status = data.status[item].status;
                                let statusClass = '';
                                let statusText = status;
                                
                                // Determine status class
                                switch (status) {
                                    case 'Never':
                                        statusClass = 'status-never';
                                        break;
                                    case 'In Progress':
                                        statusClass = 'status-in-progress';
                                        break;
                                    case 'Completed':
                                        statusClass = 'status-completed';
                                        break;
                                    case 'Error':
                                        statusClass = 'status-error';
                                        break;
                                    default:
                                        statusClass = 'status-never';
                                        statusText = 'Never';
                                }
                                
                                // Clear any existing status classes from the calculation item
                                calculationItem.classList.remove('status-never', 'status-in-progress', 'status-completed', 'status-error');
                                
                                // Add the new status class to the calculation item
                                calculationItem.classList.add(statusClass);
                                
                                // Update the time element with status indicator and formatted time
                                element.innerHTML = `<span class="status-indicator ${statusClass}"></span>${data.status[item].formattedTime}`;
                                
                                // Find the title element (h4) to add status label
                                const titleElement = calculationItem.querySelector('h4');
                                if (titleElement) {
                                    // Remove any existing status label
                                    const existingLabel = titleElement.querySelector('.status-label');
                                    if (existingLabel) {
                                        existingLabel.remove();
                                    }
                                    
                                    // Add status label
                                    const statusLabel = document.createElement('span');
                                    statusLabel.className = `status-label ${statusClass}`;
                                    statusLabel.textContent = statusText;
                                    titleElement.appendChild(statusLabel);
                                }
                                
                                // Update duration if available
                                if (data.status[item].duration) {
                                    durationElement.innerHTML = `Duration: ${data.status[item].duration}`;
                                }
                            }
                        });
                    } else {
                        console.error('Error loading calculation times:', data.error);
                        calculationItems.forEach(item => {
                            const element = document.getElementById(`${item}-last-calculation-time`);
                            if (element) {
                                element.innerHTML = '<span class="status-indicator status-error"></span>Error loading';
                            }
                            const durationElement = document.getElementById(`${item}-last-calculation-duration`);
                            if (durationElement) {
                                durationElement.innerHTML = '';
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading calculation times:', error);
                    calculationItems.forEach(item => {
                        const element = document.getElementById(`${item}-last-calculation-time`);
                        if (element) {
                            element.innerHTML = '<span class="status-indicator status-error"></span>Error loading';
                        }
                        const durationElement = document.getElementById(`${item}-last-calculation-duration`);
                        if (durationElement) {
                            durationElement.innerHTML = '';
                        }
                    });
                });
        }

        function loadServicesStatus() {
            const refreshServicesBtn = document.getElementById('refreshServicesBtn');
            const servicesStatus = document.getElementById('servicesStatus');
            
            // Disable the button and show loading status
            refreshServicesBtn.disabled = true;
            servicesStatus.style.display = 'block';
            servicesStatus.className = 'status info';
            servicesStatus.textContent = 'Loading service statuses...';
            
            fetch('/control/api/systemd-services')
                .then(response => response.json())
                .then(data => {
                    // Re-enable the button and hide status
                    refreshServicesBtn.disabled = false;
                    servicesStatus.style.display = 'none';
                    
                    // Clear the table
                    const servicesTableBody = document.getElementById('servicesTableBody');
                    servicesTableBody.innerHTML = '';
                    
                    // Service descriptions
                    const serviceDescriptions = {
                        'neo4j': 'Graph database for storing Nostr relationships',
                        'strfry': 'Nostr relay for receiving and serving events',
                        // 'hasenpfeffr-control-panel': 'Web interface for system management',
                        'strfry-router': 'Live stream events from the nostr network, including: baselineWoT (kinds 3, 1984, and 10000), profile info (kind 0), and all personal events',
                        'addToQueue': 'Add to queue whenever strfry receives new follows, mutes, or reports',
                        'processQueue': 'Process queue to update Neo4j with new data',
                        'processAllTasks.timer': 'Calculate all WoT scores; update and export them',
                        'reconcile.timer': 'Scheduled task to reconcile graph data'
                    };
                    
                    // List of services to exclude
                    const excludedServices = [
                        'hasenpfeffr-control-panel',
                        'calculateHops.timer',
                        'calculatePersonalizedPageRank.timer',
                        'calculatePersonalizedGrapeRank.timer',
                        'reconcile.timer'
                    ];
                    
                    // Separate services into different categories
                    const coreServices = [];
                    const streamingServices = [];
                    const timerServices = [];
                    
                    Object.entries(data.services).forEach(([service, status]) => {
                        // Skip excluded services
                        if (excludedServices.includes(service)) {
                            return;
                        }
                        
                        if (service.endsWith('.timer')) {
                            timerServices.push([service, status]);
                        } else if (service === 'neo4j' || service === 'strfry') {
                            coreServices.push([service, status]);
                        } else if (service === 'strfry-router' || service === 'addToQueue' || service === 'processQueue') {
                            streamingServices.push([service, status]);
                        } else {
                            // Any other services go to core by default
                            coreServices.push([service, status]);
                        }
                    });
                    
                    // Function to create a service row
                    function createServiceRow(service, status, isTimer = false) {
                        const row = document.createElement('tr');
                        
                        // Service name cell
                        const nameCell = document.createElement('td');
                        nameCell.style.padding = '8px';
                        nameCell.style.borderBottom = '1px solid #ddd';
                        
                        const nameSpan = document.createElement('span');
                        nameSpan.textContent = service;
                        nameSpan.style.fontWeight = 'bold';
                        nameCell.appendChild(nameSpan);
                        
                        // Add description if available
                        if (serviceDescriptions[service]) {
                            const descSpan = document.createElement('div');
                            descSpan.textContent = serviceDescriptions[service];
                            descSpan.style.fontSize = '0.8em';
                            descSpan.style.color = '#666';
                            nameCell.appendChild(descSpan);
                        }
                        
                        row.appendChild(nameCell);
                        
                        // Status cell
                        const statusCell = document.createElement('td');
                        statusCell.style.padding = '8px';
                        statusCell.style.borderBottom = '1px solid #ddd';
                        statusCell.style.textAlign = 'center';
                        
                        const statusIndicator = document.createElement('span');
                        statusIndicator.textContent = status;
                        statusIndicator.style.padding = '4px 8px';
                        statusIndicator.style.borderRadius = '4px';
                        statusIndicator.style.fontWeight = 'bold';
                        
                        if (status === 'active') {
                            statusIndicator.style.backgroundColor = '#2ecc71';
                            statusIndicator.style.color = 'white';
                        } else {
                            statusIndicator.style.backgroundColor = '#e74c3c';
                            statusIndicator.style.color = 'white';
                        }
                        
                        statusCell.appendChild(statusIndicator);
                        row.appendChild(statusCell);
                        
                        // Actions cell
                        const actionsCell = document.createElement('td');
                        actionsCell.style.padding = '8px';
                        actionsCell.style.borderBottom = '1px solid #ddd';
                        actionsCell.style.textAlign = 'right';
                        
                        // Start button
                        const startBtn = document.createElement('button');
                        startBtn.className = 'button';
                        startBtn.style.backgroundColor = '#2ecc71';
                        startBtn.style.marginRight = '5px';
                        startBtn.style.padding = '5px 10px';
                        startBtn.textContent = isTimer ? 'Enable' : 'Start';
                        startBtn.onclick = () => controlService(service, 'start');
                        
                        // Stop button
                        const stopBtn = document.createElement('button');
                        stopBtn.className = 'button';
                        stopBtn.style.backgroundColor = '#e74c3c';
                        stopBtn.style.marginRight = '5px';
                        stopBtn.style.padding = '5px 10px';
                        stopBtn.textContent = isTimer ? 'Disable' : 'Stop';
                        stopBtn.onclick = () => controlService(service, 'stop');
                        
                        actionsCell.appendChild(startBtn);
                        actionsCell.appendChild(stopBtn);
                        row.appendChild(actionsCell);
                        
                        return row;
                    }
                    
                    // Function to add a section header
                    function addSectionHeader(title) {
                        const headerRow = document.createElement('tr');
                        const headerCell = document.createElement('td');
                        headerCell.colSpan = 3;
                        headerCell.style.backgroundColor = '#f2f2f2';
                        headerCell.style.padding = '8px';
                        headerCell.style.fontWeight = 'bold';
                        headerCell.textContent = title;
                        headerRow.appendChild(headerCell);
                        servicesTableBody.appendChild(headerRow);
                    }
                    
                    // Add core services
                    if (coreServices.length > 0) {
                        addSectionHeader('Core Services');
                        
                        // Add each core service
                        coreServices.forEach(([service, status]) => {
                            servicesTableBody.appendChild(createServiceRow(service, status));
                        });
                    }
                    
                    // Add streaming services
                    if (streamingServices.length > 0) {
                        addSectionHeader('Streaming Data');
                        
                        // Add each streaming service
                        streamingServices.forEach(([service, status]) => {
                            servicesTableBody.appendChild(createServiceRow(service, status));
                        });
                    }
                    
                    // Add timer services
                    if (timerServices.length > 0) {
                        addSectionHeader('Scheduled Tasks');
                        
                        // Add each timer service
                        timerServices.forEach(([service, status]) => {
                            servicesTableBody.appendChild(createServiceRow(service, status, true));
                        });
                    }
                })
                .catch(error => {
                    // Re-enable the button and show error message
                    refreshServicesBtn.disabled = false;
                    servicesStatus.className = 'status error';
                    servicesStatus.textContent = 'Error loading services: ' + error.message;
                    console.error('Error loading services:', error);
                });
        }
        
        function controlService(service, action) {
            const servicesStatus = document.getElementById('servicesStatus');
            servicesStatus.style.display = 'block';
            servicesStatus.className = 'status info';
            servicesStatus.textContent = `${action.charAt(0).toUpperCase() + action.slice(1)}ing ${service} service...`;
            
            fetch(`/control/api/systemd-services?service=${service}&action=${action}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        servicesStatus.className = 'status success';
                        servicesStatus.textContent = data.message || `Service ${service} ${action} successful`;
                    } else {
                        servicesStatus.className = 'status error';
                        servicesStatus.textContent = data.message || `Failed to ${action} ${service}`;
                    }
                    
                    // Reload service statuses after a short delay
                    setTimeout(loadServicesStatus, 1000);
                })
                .catch(error => {
                    servicesStatus.className = 'status error';
                    servicesStatus.textContent = 'Error controlling service: ' + error.message;
                });
        }

        function initializeActionButtons() {
            // Define the configuration for each action button
            const actionConfig = {
                'syncWoT': {
                    endpoint: '/control/api/negentropy-sync-wot',
                    // params: { relay: 'wss://relay.hasenpfeffr.com', filter: '{"kinds":[3,1984,10000]}' },
                    method: 'POST',
                    buttonText: 'Sync WoT'
                },
                'syncProfiles': {
                    endpoint: '/control/api/negentropy-sync-profiles',
                    // params: { relay: 'wss://profiles.nostr1.com', filter: '{"kinds":[0]}' },
                    method: 'POST',
                    buttonText: 'Sync Profiles'
                },
                'syncPersonal': {
                    endpoint: '/control/api/negentropy-sync-personal',
                    // params: { relay: 'wss://relay.primal.net', filter: '{"authors":["HASENPFEFFR_OWNER_PUBKEY"]}' },
                    method: 'POST',
                    buttonText: 'Sync Personal'
                },
                'batchTransfer': {
                    endpoint: '/control/api/batch-transfer',
                    method: 'POST',
                    buttonText: 'Batch Transfer'
                },
                'reconciliation': {
                    endpoint: '/control/api/reconciliation',
                    method: 'POST',
                    buttonText: 'Reconciliation'
                },
                'hops': {
                    endpoint: '/control/api/calculate-hops',
                    method: 'POST',
                    buttonText: 'Calculate Hops'
                },
                'pageRank': {
                    endpoint: '/control/api/generate-pagerank',
                    method: 'POST',
                    buttonText: 'Calculate PageRank'
                },
                'grapeRank': {
                    endpoint: '/control/api/generate-graperank',
                    method: 'POST',
                    buttonText: 'Calculate GrapeRank'
                },
                'blacklist': {
                    endpoint: '/control/api/generate-blacklist',
                    method: 'POST',
                    buttonText: 'Generate Blacklist'
                },
                'whitelist': {
                    endpoint: '/control/api/export-whitelist',
                    method: 'POST',
                    buttonText: 'Export Whitelist'
                },
                'nip85': {
                    endpoint: '/control/api/generate-nip85',
                    method: 'POST',
                    buttonText: 'Export NIP-85'
                }
            };

            // Find all calculation items and set up their action buttons
            document.querySelectorAll('.calculation-item').forEach(item => {
                const itemId = item.querySelector('[id$="-last-calculation-time"]')?.id?.replace('-last-calculation-time', '');
                if (!itemId || !actionConfig[itemId]) return;
                
                const config = actionConfig[itemId];
                const actionBtn = item.querySelector('.action-btn');
                const progressContainer = item.querySelector('.progress-container');
                const progressBar = item.querySelector('.progress-bar');
                const progressText = item.querySelector('.progress-text');
                
                // Set the button text
                actionBtn.textContent = config.buttonText;
                
                // Add click event listener
                actionBtn.addEventListener('click', function() {
                    // Disable the button
                    actionBtn.disabled = true;
                    
                    // Show progress container
                    progressContainer.style.display = 'block';
                    progressBar.style.width = '5%';
                    progressText.textContent = 'Starting...';
                    
                    // Prepare the request
                    const fetchOptions = {
                        method: config.method,
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    };
                    
                    // Add body if needed
                    if (config.params) {
                        fetchOptions.body = JSON.stringify(config.params);
                    }
                    
                    // Start the request
                    fetch(config.endpoint, fetchOptions)
                        .then(response => {
                            // Set progress to 50% when the server starts processing
                            progressBar.style.width = '50%';
                            progressText.textContent = 'Processing...';
                            
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                // Set progress to 100% when completed
                                progressBar.style.width = '100%';
                                progressText.textContent = 'Completed';
                                
                                // Refresh calculation times after a delay
                                setTimeout(() => {
                                    loadCalculationTimes();
                                    
                                    // Hide progress after showing completion
                                    setTimeout(() => {
                                        progressContainer.style.display = 'none';
                                        actionBtn.disabled = false;
                                    }, 2000);
                                }, 1000);
                            } else {
                                // Show error
                                progressBar.style.backgroundColor = '#e74c3c';
                                progressText.textContent = 'Error: ' + (data.error || 'Unknown error');
                                
                                // Enable button after delay
                                setTimeout(() => {
                                    actionBtn.disabled = false;
                                }, 3000);
                            }
                        })
                        .catch(error => {
                            console.error(`Error running ${itemId} action:`, error);
                            
                            // Show error
                            progressBar.style.backgroundColor = '#e74c3c';
                            progressText.textContent = 'Error: ' + error.message;
                            
                            // Enable button after delay
                            setTimeout(() => {
                                actionBtn.disabled = false;
                            }, 3000);
                        });
                });
            });
        }

        // Function to check and set the status of all switches initially
        function checkAllServices() {
            checkServiceStatus('databases', 'databasesToggle');
            checkServiceStatus('streaming', 'streamingToggle');
            checkServiceStatus('scores', 'scoresToggle');
            checkFilteredContentStatus();
        }
        
        // Run initial status check
        checkAllServices();

        // Function to check status of a specific service group and update toggle
        function checkServiceStatus(groupName, toggleId) {
            // Get service group configuration
            const group = serviceGroups[groupName];
            if (!group || !group.services) return;

            // Call API to get service status
            fetch('/control/api/service-status')
                .then(response => response.json())
                .then(data => {
                    const toggle = document.getElementById(toggleId);
                    const statusEl = document.getElementById(groupName + 'Status');
                    
                    if (!toggle || !statusEl) return;
                    
                    // Check if all services in the group are active
                    const allActive = group.services.every(service => 
                        data.services && data.services[service] === 'active'
                    );
                    
                    // Update UI
                    toggle.checked = allActive;
                    if (allActive) {
                        statusEl.textContent = 'Active';
                        statusEl.className = 'mini-status active';
                    } else {
                        statusEl.textContent = 'Inactive';
                        statusEl.className = 'mini-status inactive';
                    }
                })
                .catch(error => {
                    console.error(`Error checking ${groupName} status:`, error);
                    const statusEl = document.getElementById(groupName + 'Status');
                    if (statusEl) {
                        statusEl.textContent = 'Status check failed';
                        statusEl.className = 'mini-status error';
                    }
                });
        }

        // Functions for content filter toggle
        function checkFilteredContentStatus() {
            fetch('/control/api/get-strfry-plugin')
                .then(response => response.json())
                .then(data => {
                    const toggle = document.getElementById('contentFilterToggle');
                    const statusEl = document.getElementById('contentFilterStatus');
                    
                    if (data.status === 'enabled') {
                        toggle.checked = true;
                        statusEl.textContent = 'Content filtering active';
                        statusEl.className = 'mini-status active';
                    } else {
                        toggle.checked = false;
                        statusEl.textContent = 'Content filtering inactive';
                        statusEl.className = 'mini-status inactive';
                    }
                })
                .catch(error => {
                    console.error('Error checking content filter status:', error);
                    document.getElementById('contentFilterStatus').textContent = 'Status check failed';
                    document.getElementById('contentFilterStatus').className = 'mini-status error';
                });
        }
        
        function toggleFilteredContent(enable) {
            const toggle = document.getElementById('contentFilterToggle');
            const statusEl = document.getElementById('contentFilterStatus');
            
            // Disable toggle while operation is in progress
            toggle.disabled = true;
            statusEl.textContent = enable ? 'Enabling content filtering...' : 'Disabling content filtering...';
            statusEl.className = 'mini-status pending';
            
            // Call API to enable/disable the plugin
            const action = enable ? 'enable' : 'disable';
            fetch('/control/api/toggle-strfry-plugin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ action: action })
            })
                .then(response => response.json())
                .then(data => {
                    toggle.disabled = false;
                    
                    if ((enable && data.status === 'enabled') || (!enable && data.status === 'disabled')) {
                        statusEl.textContent = enable ? 'Content filtering active' : 'Content filtering inactive';
                        statusEl.className = enable ? 'mini-status active' : 'mini-status inactive';
                    } else {
                        // Handle error
                        toggle.checked = !enable; // Revert toggle position
                        statusEl.textContent = 'Operation failed: ' + (data.error || 'Unknown error');
                        statusEl.className = 'mini-status error';
                    }
                })
                .catch(error => {
                    console.error('Error toggling content filter:', error);
                    toggle.disabled = false;
                    toggle.checked = !enable; // Revert toggle position
                    statusEl.textContent = 'Operation failed: ' + error.message;
                    statusEl.className = 'mini-status error';
                });
        }
        
        document.getElementById('refreshServicesBtn').addEventListener('click', function() {
            loadServicesStatus();
        });
    </script>
</body>
</html>
