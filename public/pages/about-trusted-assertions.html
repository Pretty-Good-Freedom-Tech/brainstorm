<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brainstorm</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="shortcut icon" href="/img/brainstorm010.svg">
    <script src="./components/header/header.js"></script>
    <script src="./components/footer/footer.js"></script>
    <style>
        .nip85-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 24px;
            margin: 24px 0;
        }
        
        .nip85-info h2 {
            color: #2c3e50;
            margin-bottom: 16px;
        }
        
        .nip85-info h3 {
            color: #34495e;
            margin: 20px 0 12px 0;
        }
        
        .nip85-info ul {
            padding-left: 20px;
        }
        
        .nip85-info li {
            margin: 12px 0;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .nip85-info li:last-child {
            border-bottom: none;
        }
        
        .authors-showcase {
            background: #ffffff;
            border: 2px solid #3498db;
            border-radius: 12px;
            padding: 24px;
            margin: 32px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .authors-showcase h2 {
            color: #2980b9;
            margin-bottom: 16px;
            text-align: center;
        }
        
        .loading-state {
            text-align: center;
            padding: 40px;
        }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stats-summary {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 24px;
            text-align: center;
            font-weight: 500;
            color: #0c5460;
        }
        
        .authors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }
        
        .author-card {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .author-card:hover {
            border-color: #3498db;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.15);
            transform: translateY(-2px);
        }
        
        .author-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .author-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            margin-right: 12px;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #6c757d;
        }
        
        .author-info {
            flex: 1;
        }
        
        .author-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
            font-size: 16px;
        }
        
        .author-pubkey {
            font-family: monospace;
            font-size: 12px;
            color: #6c757d;
            word-break: break-all;
        }
        
        .author-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e9ecef;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-weight: 600;
            color: #2980b9;
            display: block;
            font-size: 18px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 4px;
        }
        
        .error-state {
            text-align: center;
            padding: 40px;
            color: #721c24;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
        }
        
        .developer-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 24px;
            margin: 32px 0;
        }
        
        .developer-info h2 {
            color: #2c3e50;
            margin-bottom: 16px;
        }
        
        .integration-steps {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .step {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 20px;
        }
        
        .step h3 {
            color: #2980b9;
            margin-bottom: 12px;
        }
        
        .step p {
            color: #5a6c7d;
            margin: 0;
        }
        
        @media (max-width: 768px) {
            .authors-grid {
                grid-template-columns: 1fr;
            }
            
            .integration-steps {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Include the header component -->
    <div id="headerContainer"></div>

    <!-- Main content wrapper -->
    <div class="page-content">
        <div class="container">            
            <div class="nip85-info">
                <h2 style="text-align: center">What are Trusted Assertions?</h2>
                <p><a href="https://github.com/vitorpamplona/nips/blob/user-summaries/85.md" target="_blank">NIP-85: Trusted Assertions</a> is a <a href="https://github.com/nostr-protocol/nips/pull/1534" target="_blank">proposed</a> Nostr Improvement Proposal that defines a standard
                    for publishing personalized trust scores in a way that is easily discoverable by clients and other users on the Nostr network.
                    Each "trusted assertion" is a kind 3038x event that contains a list of trust scores for a specific user.
                    Score types can be standardized (User Rank, Follower Count, etc) or custom.
                </p>
                
                <h3>Key Benefits for Developers:</h3>

                <ul>
                    <li><strong>Separation of clients and trust</strong> Calculation of sophisticated personalized trust metrics by third party providers like Brainstorm makes your life easier.</li>
                    <li><strong>Standardized Trust Data</strong> Access consistent trust scores and score formats across nostr</li>
                    <li><strong>Enhanced User Experience</strong> Provide users with personalized content filtering and recommendations</li>
                    <li><strong>Spam Prevention</strong> Leverage community trust scores to reduce spam and low-quality content</li>
                    <li><strong>Decentralized Reputation</strong> Build reputation systems without centralized authorities</li>
                </ul>
            </div>
            
            <!-- NIP-85 Authors Showcase -->
            <div class="authors-showcase">
                <h2>üåü NIP-85 Adopters</h2>
                <p>See who's already using NIP-85 to publish personalized trust scores on the Nostr network:</p>
                
                <div id="authorsLoading" class="loading-state">
                    <div class="loader"></div>
                    <p>Loading NIP-85 authors...</p>
                </div>
                
                <div id="authorsContent" style="display: none;">
                    <div id="authorsStats" class="stats-summary"></div>
                    <div id="authorsList" class="authors-grid"></div>
                </div>
                
                <div id="authorsError" class="error-state" style="display: none;">
                    <h3>‚ùå Error Loading Authors</h3>
                    <p id="authorsErrorMessage">Unable to load NIP-85 authors at this time.</p>
                    <button id="retryAuthorsBtn" class="btn btn-secondary">üîÑ Retry</button>
                </div>
            </div>
            
            <div class="developer-info">
                <h2>üöÄ For Developers: Get Started with NIP-85</h2>
                <p>Ready to integrate NIP-85 trust scores into your Nostr application? Here's how to get started.</p>

                <p>Let's assume you have a user: observer_pubkey, and you want to fetch personalized trust scores of one or more observee_pubkeys.</p>
                
                <div class="integration-steps">
                    <div class="step">
                        <h3>1. Look for the end-user Kind 10040 Event</h3>
                        <p>Adopters of NIP-85 will have a kind 10040 event. An example event is below.</p>
                        <p>Filter:</p>
                        <pre>{"kinds":[10040], "authors":[user_pubkey]}</pre>
                        <p>There are three salient pieces of information stored in tags:</p>
                        <ul>
                            <li>A list of trust metrics. Some will be standardized, like rank or followers, while others may be customized.</li>
                            <li>For each metric, the pubkey of the relay that publishes the metric; 30382_publisher_pubkey. In theory this could be the user pubkey, but in practice this will often not be the case. When a user signs up to Brainstorm, a new customer relay nsec is issued which will publish kind 30382 events periodically on behalf of the customer.</li>
                            <li>For each metric, a relay where the kind 30382 notes can be found; 30382_relay_url. This will be a huge number of notes, so we don't necessarily want all of them to be spread across all the relays of nostr. For Brainstorm, this will be the relay of the brainstorm relay instance, e.g. <code>wss://straycat.brainstorm.social/relay</code>.</li>
                        </ul>
                        <p>For users who have not yet signed up to Brainstorm or adopted NIP-85 using some other provider, personalized scores will not be available. The easist fallback solution would be to use an existing NIP-85 enabled npub as your app's "global trust scores". Alternatively, you could search the user's follows list for a NIP-85 adopter, and use those scores.</p>
                    </div>
                    <div class="step">
                        <h3>2. Fetch Trust Scores</h3>
                        <p>Connect to the referenced relay to fetch Kind 30382 events authored by the referenced pubkey, and extract the personalized trust score(s) of interest.</p>
                        <p>The filter should look something like this:</p>
                        <pre>{"kinds":[30382], "authors":[30382_publisher_pubkey], "#d":[rated_pubkeys]}</pre>
                    </div>
                    <div class="step">
                        <h3>3. Apply Trust Metrics</h3>
                        <p>Use the trust scores to filter, rank, or recommend content in your application.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Include the footer component -->
    <div id="footerContainer"></div>
    
    <script>
        // State management
        const authorsState = {
            loading: document.getElementById('authorsLoading'),
            content: document.getElementById('authorsContent'),
            error: document.getElementById('authorsError'),
            stats: document.getElementById('authorsStats'),
            list: document.getElementById('authorsList'),
            errorMessage: document.getElementById('authorsErrorMessage'),
            retryBtn: document.getElementById('retryAuthorsBtn')
        };
        
        // Load NIP-85 authors on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadNip85Authors();
            
            // Setup retry button
            authorsState.retryBtn.addEventListener('click', function() {
                loadNip85Authors();
            });
        });
        
        async function loadNip85Authors() {
            try {
                // Show loading state
                showAuthorsState('loading');
                
                console.log('[about-nip85] Loading NIP-85 authors...');
                
                // Fetch all Kind 10040 authors
                const authorsResponse = await fetch('/api/get-all-10040-authors');
                const authorsData = await authorsResponse.json();
                
                if (!authorsData.success) {
                    throw new Error(authorsData.message || 'Failed to load authors');
                }
                
                console.log('[about-nip85] Authors loaded:', authorsData.data);
                
                // Display stats
                displayAuthorsStats(authorsData.data);
                
                // Load profile and NIP-85 data for each author
                await loadAuthorsProfiles(authorsData.data.authors);
                
                // Show content
                showAuthorsState('content');
                
            } catch (error) {
                console.error('[about-nip85] Error loading authors:', error);
                authorsState.errorMessage.textContent = error.message;
                showAuthorsState('error');
            }
        }
        
        function showAuthorsState(state) {
            // Hide all states
            authorsState.loading.style.display = 'none';
            authorsState.content.style.display = 'none';
            authorsState.error.style.display = 'none';
            
            // Show requested state
            if (state === 'loading') {
                authorsState.loading.style.display = 'block';
            } else if (state === 'content') {
                authorsState.content.style.display = 'block';
            } else if (state === 'error') {
                authorsState.error.style.display = 'block';
            }
        }
        
        function displayAuthorsStats(data) {
            const statsHtml = `
                <strong>üìä ${data.count} NIP-85 Users</strong> are using NIP-85 for personalized web of trust
                (${data.stats.validEventsProcessed.toLocaleString()} kind 10040 events)
            `;
            authorsState.stats.innerHTML = statsHtml;
        }
        
        async function loadAuthorsProfiles(authors) {
            console.log('[about-nip85] Loading profiles for', authors.length, 'authors');
            
            const authorCards = [];
            
            // Process authors in batches to avoid overwhelming the server
            const batchSize = 5;
            for (let i = 0; i < authors.length; i += batchSize) {
                const batch = authors.slice(i, i + batchSize);
                const batchPromises = batch.map(pubkey => loadAuthorData(pubkey));
                const batchResults = await Promise.allSettled(batchPromises);
                
                batchResults.forEach((result, index) => {
                    if (result.status === 'fulfilled') {
                        authorCards.push(result.value);
                    } else {
                        console.error('[about-nip85] Failed to load author:', batch[index], result.reason);
                        // Create fallback card for failed loads
                        authorCards.push(createFallbackAuthorCard(batch[index]));
                    }
                });
                
                // Small delay between batches
                if (i + batchSize < authors.length) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
            
            // Display all author cards
            authorsState.list.innerHTML = authorCards.join('');
            
            // Add click handlers for profile links
            setupAuthorCardHandlers();
        }
        
        async function loadAuthorData(pubkey) {
            try {
                // Load profile, NIP-85 status, and npub in parallel
                const [profileResponse, nip85Response, npubResponse] = await Promise.all([
                    fetch(`/api/get-kind0?pubkey=${pubkey}`),
                    fetch(`/api/get-nip85-status?pubkey=${pubkey}`),
                    fetch(`/api/get-npub-from-pubkey?pubkey=${pubkey}`)
                ]);
                
                const profileData = await profileResponse.json();
                const nip85Data = await nip85Response.json();
                const npubData = await npubResponse.json();
                
                return createAuthorCard(pubkey, profileData, nip85Data, npubData);
                
            } catch (error) {
                console.error('[about-nip85] Error loading data for author:', pubkey, error);
                throw error;
            }
        }
        
        function createAuthorCard(pubkey, profileData, nip85Data, npubData) {
            // Extract profile info
            console.log(`profileData: ${JSON.stringify(profileData)}`);
            let profileKind0Event = {}
            if (profileData.success && profileData.data && profileData.data.content) {
                profileKind0Event = JSON.parse(profileData.data.content);
            }
            const displayName = profileKind0Event.name || profileKind0Event.display_name || 'Anonymous';
            const avatar = profileKind0Event.picture || '';
            
            // Extract npub or fallback to truncated pubkey
            const displayPubkey = npubData && npubData.success && npubData.npub 
                ? npubData.npub 
                : `${pubkey.substring(0, 8)}...${pubkey.substring(56)}`;
            
            // Extract NIP-85 info
            const kind30382Count = nip85Data.success && nip85Data.data && nip85Data.data.kind30382 
                ? nip85Data.data.kind30382.count || 0 
                : 0;
            
            const hasKind10040 = nip85Data.success && nip85Data.data && nip85Data.data.kind10040 
                ? nip85Data.data.kind10040.exists 
                : false;
            
            return `
                <div class="author-card" data-pubkey="${pubkey}">
                    <div class="author-header">
                        <div class="author-avatar">
                            ${avatar ? `<img src="${avatar}" alt="${displayName}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : 'üë§'}
                        </div>
                        <div class="author-info">
                            <div class="author-name">${escapeHtml(displayName)}</div>
                            <div class="author-pubkey">${displayPubkey}</div>
                        </div>
                    </div>
                    <div class="author-stats">
                        <div class="stat-item">
                            <span class="stat-value">${hasKind10040 ? '‚úÖ' : '‚ùå'}</span>
                            <div class="stat-label">Kind 10040</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${kind30382Count.toLocaleString()}</span>
                            <div class="stat-label">Trusted Assertions</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function createFallbackAuthorCard(pubkey) {
            const truncatedPubkey = `${pubkey.substring(0, 8)}...${pubkey.substring(56)}`;
            
            return `
                <div class="author-card" data-pubkey="${pubkey}">
                    <div class="author-header">
                        <div class="author-avatar">üë§</div>
                        <div class="author-info">
                            <div class="author-name">Loading failed</div>
                            <div class="author-pubkey">${truncatedPubkey}</div>
                        </div>
                    </div>
                    <div class="author-stats">
                        <div class="stat-item">
                            <span class="stat-value">‚ùì</span>
                            <div class="stat-label">Kind 10040</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">-</span>
                            <div class="stat-label">Trust Scores</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function setupAuthorCardHandlers() {
            const authorCards = document.querySelectorAll('.author-card');
            authorCards.forEach(card => {
                card.addEventListener('click', function() {
                    const pubkey = this.dataset.pubkey;
                    if (pubkey) {
                        window.open(`./profile.html?pubkey=${pubkey}`, '_blank');
                    }
                });
            });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>