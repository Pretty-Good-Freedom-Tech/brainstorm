<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brainstorm</title>
    <link rel="stylesheet" href="/control/css/profiles.css">
    <script src="./components/header/header.js"></script>
    <link rel="shortcut icon" href="/control/img/brainstorm010.svg">
    <style>
        /* Column visibility panel styles */
        .column-settings-panel {
            position: absolute;
            right: 20px;
            top: 180px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 100;
            display: none;
            min-width: 200px;
        }
        
        .column-settings-panel h3 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        
        .column-toggle {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .column-toggle label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .column-toggle input {
            margin-right: 8px;
        }
        
        /* Hidden column class */
        .hidden-column {
            display: none;
        }
        
        /* Toggle button styles */
        #columnSettingsBtn {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        #columnSettingsBtn svg {
            width: 16px;
            height: 16px;
        }
    </style>
</head>
<body>
    <!-- Include the header component -->
    <div id="headerContainer"></div>

    <div class="container">
        <div class="header-profiles">
            <h1>Nostr User Profiles</h1>
            <div>
                <button id="refreshBtn">Refresh Data</button>
                <button id="exportCsvBtn" class="secondary">Export CSV</button>
                <button id="columnSettingsBtn" class="secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 5v14M5 12h14"></path>
                    </svg>
                    Columns
                </button>
            </div>
        </div>
        
        <!-- Column settings panel -->
        <div id="columnSettingsPanel" class="column-settings-panel">
            <h3>Column Visibility</h3>
            <div id="columnToggles">
                <!-- Checkboxes will be added here dynamically -->
            </div>
        </div>
        
        <div id="statusMessage" style="display: none;"></div>
        
        <!-- Profile count information -->
        <div class="profile-counts">
            Showing <span id="filteredCount">0</span> filtered profiles out of <span id="totalCount">0</span> total
        </div>
        
        <!-- Limit selection and action buttons -->
        <div class="actions-container">
            <div class="filter-actions">
                <div class="filter-group">
                    <label for="limitSelect">Results Per Page</label>
                    <select id="limitSelect">
                        <option value="50">50</option>
                        <option value="100" selected>100</option>
                        <option value="250">250</option>
                        <option value="500">500</option>
                    </select>
                </div>
                <div>
                    <button id="applyFiltersBtn">Apply Filters</button>
                    <button id="resetFiltersBtn" class="secondary">Reset</button>
                </div>
            </div>
        </div>
        
        <div id="tableContainer">
            <div id="loadingIndicator" class="loading"></div>
            <table id="profilesTable" style="display: none;">
                <thead>
                    <tr class="header-row">
                        <th class="profile-pic-col" data-sort="profile-pic-col">Pic</th>
                        <th data-sort="pubkey">Pubkey</th>
                        <th data-sort="verifiedFollowerCount" class="sort-desc">üçá-Verified Followers</th>
                        <th data-sort="nip56TotalScore" class="sort-desc">üçá-Verified Reports</th>
                        <th data-sort="hops" class="sort-desc">Hops</th>
                        <th data-sort="personalizedPageRank" class="sort-desc">PageRank</th>
                        <th data-sort="influence" class="sort-desc">Influence</th>
                        <th data-sort="average" class="sort-desc">Average</th>
                        <th data-sort="confidence" class="sort-desc">Confidence</th>
                        <th data-sort="input" class="sort-desc">Input</th>
                    </tr>
                    <tr class="filter-row">
                        <th></th>
                        <th>
                            <input type="text" id="filterPubkey" placeholder="Pubkey contains..." class="table-filter">
                        </th>
                        <th>
                            <div class="filter-inputs">
                                <input type="number" id="filterMinVerifiedFollowers" placeholder="Min" min="0" class="table-filter small-input">
                                <input type="number" id="filterMaxVerifiedFollowers" placeholder="Max" min="0" class="table-filter small-input">
                            </div>
                        </th>
                        <th>
                            <div class="filter-inputs">
                                <input type="number" id="filterMinNip56TotalScore" placeholder="Min" min="0" class="table-filter small-input">
                                <input type="number" id="filterMaxNip56TotalScore" placeholder="Max" min="0" class="table-filter small-input">
                            </div>
                        </th>
                        <th>
                            <div class="filter-inputs">
                                <input type="number" id="filterMinHops" placeholder="Min" min="0" max="20" class="table-filter small-input">
                                <input type="number" id="filterMaxHops" placeholder="Max" min="1" max="20" class="table-filter small-input">
                            </div>
                        </th>
                        <th>
                            <div class="filter-inputs">
                                <input type="number" id="filterMinRank" placeholder="Min" min="0" step="0.000001" class="table-filter small-input">
                                <input type="number" id="filterMaxRank" placeholder="Max" min="0" step="0.000001" class="table-filter small-input">
                            </div>
                        </th>
                        <th>
                            <div class="filter-inputs">
                                <input type="number" id="filterMinInfluence" placeholder="Min" min="0" step="0.000001" class="table-filter small-input">
                                <input type="number" id="filterMaxInfluence" placeholder="Max" min="0" step="0.000001" class="table-filter small-input">
                            </div>
                        </th>
                        <th>
                            <div class="filter-inputs">
                                <input type="number" id="filterMinAverage" placeholder="Min" min="-1" max="1" step="0.01" class="table-filter small-input">
                                <input type="number" id="filterMaxAverage" placeholder="Max" min="-1" max="1" step="0.01" class="table-filter small-input">
                            </div>
                        </th>
                        <th>
                            <div class="filter-inputs">
                                <input type="number" id="filterMinConfidence" placeholder="Min" min="0" max="1" step="0.01" class="table-filter small-input">
                                <input type="number" id="filterMaxConfidence" placeholder="Max" min="0" max="1" step="0.01" class="table-filter small-input">
                            </div>
                        </th>
                        <th>
                            <div class="filter-inputs">
                                <input type="number" id="filterMinInput" placeholder="Min" min="0" step="0.01" class="table-filter small-input">
                                <input type="number" id="filterMaxInput" placeholder="Max" min="0" step="0.01" class="table-filter small-input">
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody id="profilesTableBody">
                    <!-- Table data will be inserted here -->
                </tbody>
            </table>
        </div>
        
        <div id="paginationContainer" class="pagination" style="display: none;">
            <!-- Pagination controls will be inserted here -->
        </div>
    </div>
    
    <script>
        // Column definitions with display names and default visibility
        const columns = [
            { id: 'profile-pic-col', name: 'Profile Picture', defaultVisible: true, alwaysVisible: true },
            { id: 'pubkey', name: 'Pubkey', defaultVisible: true, alwaysVisible: true },
            { id: 'verifiedFollowerCount', name: 'üçá-Verified Followers', defaultVisible: true },
            { id: 'nip56TotalScore', name: 'üçá-Verified Reports', defaultVisible: true },
            { id: 'hops', name: 'Hops', defaultVisible: true },
            { id: 'personalizedPageRank', name: 'PageRank', defaultVisible: true },
            { id: 'influence', name: 'Influence', defaultVisible: true },
            { id: 'average', name: 'Average', defaultVisible: true },
            { id: 'confidence', name: 'Confidence', defaultVisible: true },
            { id: 'input', name: 'Input', defaultVisible: true }
        ];

        // Load column visibility settings from localStorage
        function loadColumnVisibility() {
            const savedSettings = localStorage.getItem('profilesColumnVisibility');
            if (savedSettings) {
                try {
                    return JSON.parse(savedSettings);
                } catch (e) {
                    console.error('Error parsing saved column visibility', e);
                }
            }
            
            // Default settings if none saved
            const defaults = {};
            columns.forEach(col => {
                defaults[col.id] = col.defaultVisible;
            });
            return defaults;
        }

        // Global state management
        let state = {
            profiles: [],
            filteredProfiles: [],
            pagination: {
                page: 1,
                limit: 100,
                total: 0,
                pages: 0
            },
            filters: {
                pubkey: '',
                minHops: '',
                maxHops: '',
                minRank: '',
                maxRank: '',
                minInfluence: '',
                maxInfluence: '',
                minAverage: '',
                maxAverage: '',
                minConfidence: '',
                maxConfidence: '',
                minInput: '',
                maxInput: '',
                minVerifiedFollowers: '',
                maxVerifiedFollowers: '',
                minNip56TotalScore: '',
                maxNip56TotalScore: ''
            },
            sort: {
                column: 'influence',
                order: 'desc'
            },
            totalCount: 0,
            profileCache: {}, // Cache for profile data to avoid duplicate API calls
            columnVisibility: loadColumnVisibility()
        };
        
        // Global DOM element references
        let tableBody, profilesTable, loadingIndicator, paginationContainer, statusMessage;
        let filterPubkey, filterMinHops, filterMaxHops, filterMinRank, filterMaxRank;
        let filterMinInfluence, filterMaxInfluence, filterMinAverage, filterMaxAverage;
        let filterMinConfidence, filterMaxConfidence, filterMinInput, filterMaxInput;
        let filterMinVerifiedFollowers, filterMaxVerifiedFollowers;
        let filterMinNip56TotalScore, filterMaxNip56TotalScore;
        let limitSelect, applyFiltersBtn, resetFiltersBtn, refreshBtn, exportCsvBtn;
        let columnSettingsBtn, columnSettingsPanel, columnToggles;
            
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize DOM element references
            tableBody = document.getElementById('profilesTableBody');
            profilesTable = document.getElementById('profilesTable');
            loadingIndicator = document.getElementById('loadingIndicator');
            paginationContainer = document.getElementById('paginationContainer');
            statusMessage = document.getElementById('statusMessage');
            
            // Filter elements
            filterPubkey = document.getElementById('filterPubkey');
            filterMinHops = document.getElementById('filterMinHops');
            filterMaxHops = document.getElementById('filterMaxHops');
            filterMinRank = document.getElementById('filterMinRank');
            filterMaxRank = document.getElementById('filterMaxRank');
            filterMinInfluence = document.getElementById('filterMinInfluence');
            filterMaxInfluence = document.getElementById('filterMaxInfluence');
            filterMinAverage = document.getElementById('filterMinAverage');
            filterMaxAverage = document.getElementById('filterMaxAverage');
            filterMinConfidence = document.getElementById('filterMinConfidence');
            filterMaxConfidence = document.getElementById('filterMaxConfidence');
            filterMinInput = document.getElementById('filterMinInput');
            filterMaxInput = document.getElementById('filterMaxInput');
            filterMinVerifiedFollowers = document.getElementById('filterMinVerifiedFollowers');
            filterMaxVerifiedFollowers = document.getElementById('filterMaxVerifiedFollowers');
            filterMinNip56TotalScore = document.getElementById('filterMinNip56TotalScore');
            filterMaxNip56TotalScore = document.getElementById('filterMaxNip56TotalScore');
            limitSelect = document.getElementById('limitSelect');
            applyFiltersBtn = document.getElementById('applyFiltersBtn');
            resetFiltersBtn = document.getElementById('resetFiltersBtn');
            refreshBtn = document.getElementById('refreshBtn');
            exportCsvBtn = document.getElementById('exportCsvBtn');
            columnSettingsBtn = document.getElementById('columnSettingsBtn');
            columnSettingsPanel = document.getElementById('columnSettingsPanel');
            columnToggles = document.getElementById('columnToggles');
            
            // Initialize the page
            // Set up event listeners
            setupEventListeners();
            
            // Initialize filter fields with default values
            filterMaxHops.value = state.filters.maxHops;
            filterMinInfluence.value = state.filters.minInfluence;
            
            // Load initial data
            fetchProfiles();
            
            function fetchProfiles() {
                // Show loading indicator
                loadingIndicator.style.display = 'block';
                profilesTable.style.display = 'none';
                
                // Build query parameters
                const params = new URLSearchParams({
                    page: state.pagination.page,
                    limit: state.pagination.limit,
                    sortBy: state.sort.column,
                    sortOrder: state.sort.order
                });
                
                // Add filters if they exist
                if (state.filters.pubkey) params.append('filterPubkey', state.filters.pubkey);
                if (state.filters.minHops) params.append('filterMinHops', state.filters.minHops);
                if (state.filters.maxHops) params.append('filterMaxHops', state.filters.maxHops);
                if (state.filters.minRank) params.append('filterMinRank', state.filters.minRank);
                if (state.filters.maxRank) params.append('filterMaxRank', state.filters.maxRank);
                if (state.filters.minInfluence) params.append('filterMinInfluence', state.filters.minInfluence);
                if (state.filters.maxInfluence) params.append('filterMaxInfluence', state.filters.maxInfluence);
                if (state.filters.minAverage) params.append('filterMinAverage', state.filters.minAverage);
                if (state.filters.maxAverage) params.append('filterMaxAverage', state.filters.maxAverage);
                if (state.filters.minConfidence) params.append('filterMinConfidence', state.filters.minConfidence);
                if (state.filters.maxConfidence) params.append('filterMaxConfidence', state.filters.maxConfidence);
                if (state.filters.minInput) params.append('filterMinInput', state.filters.minInput);
                if (state.filters.maxInput) params.append('filterMaxInput', state.filters.maxInput);
                if (state.filters.minVerifiedFollowers) params.append('filterMinVerifiedFollowers', state.filters.minVerifiedFollowers);
                if (state.filters.maxVerifiedFollowers) params.append('filterMaxVerifiedFollowers', state.filters.maxVerifiedFollowers);
                if (state.filters.minNip56TotalScore) params.append('filterMinNip56TotalScore', state.filters.minNip56TotalScore);
                if (state.filters.maxNip56TotalScore) params.append('filterMaxNip56TotalScore', state.filters.maxNip56TotalScore);
                
                // Fetch data from API
                fetch(`/control/api/get-profiles?${params.toString()}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update state
                            state.profiles = data.data.users;
                            state.filteredProfiles = state.profiles; // This is just the current page
                            
                            // Store pagination information
                            state.pagination.total = data.data.pagination.total;
                            state.pagination.page = data.data.pagination.page;
                            state.pagination.pages = data.data.pagination.pages;
                            state.totalCount = data.data.totalProfiles || data.data.pagination.total;
                            
                            // Render table with the new data
                            renderTable();
                            
                            // Render pagination controls
                            renderPagination();
                            
                            // Update profile counts
                            updateProfileCounts();
                            
                            // Hide loading indicator
                            loadingIndicator.style.display = 'none';
                            profilesTable.style.display = 'table';
                            
                            // Show success message
                            showStatusMessage(`Loaded ${state.profiles.length} of ${state.pagination.total} profiles`, 'success');
                        } else {
                            // Show error message
                            showStatusMessage(`Error: ${data.message}`, 'error');
                            loadingIndicator.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching profiles:', error);
                        showStatusMessage(`Error fetching profiles: ${error.message}`, 'error');
                        loadingIndicator.style.display = 'none';
                    });
            }
            
            function setupEventListeners() {
                // Table header sorting
                const headers = document.querySelectorAll('th[data-sort]');
                headers.forEach(header => {
                    header.addEventListener('click', () => {
                        const column = header.getAttribute('data-sort');
                        let order = 'desc';
                        
                        // Toggle sort order if clicking the same column
                        if (state.sort.column === column) {
                            order = state.sort.order === 'desc' ? 'asc' : 'desc';
                        }
                        
                        // Update sorting state
                        state.sort.column = column;
                        state.sort.order = order;
                        
                        // Update UI
                        updateSortIndicators(column, order);
                        
                        // Re-sort profiles and render table
                        sortProfiles();
                        renderTable();
                    });
                });
                
                // Filter buttons
                applyFiltersBtn.addEventListener('click', () => {
                    state.filters.pubkey = filterPubkey.value.trim();
                    state.filters.minHops = filterMinHops.value.trim();
                    state.filters.maxHops = filterMaxHops.value.trim();
                    state.filters.minRank = filterMinRank.value.trim();
                    state.filters.maxRank = filterMaxRank.value.trim();
                    state.filters.minInfluence = filterMinInfluence.value.trim();
                    state.filters.maxInfluence = filterMaxInfluence.value.trim();
                    state.filters.minAverage = filterMinAverage.value.trim();
                    state.filters.maxAverage = filterMaxAverage.value.trim();
                    state.filters.minConfidence = filterMinConfidence.value.trim();
                    state.filters.maxConfidence = filterMaxConfidence.value.trim();
                    state.filters.minInput = filterMinInput.value.trim();
                    state.filters.maxInput = filterMaxInput.value.trim();
                    state.filters.minVerifiedFollowers = filterMinVerifiedFollowers.value.trim();
                    state.filters.maxVerifiedFollowers = filterMaxVerifiedFollowers.value.trim();
                    state.filters.minNip56TotalScore = filterMinNip56TotalScore.value.trim();
                    state.filters.maxNip56TotalScore = filterMaxNip56TotalScore.value.trim();
                    state.pagination.limit = parseInt(limitSelect.value);
                    state.pagination.page = 1; // Reset to first page
                    fetchProfiles();
                });
                
                resetFiltersBtn.addEventListener('click', resetFilters);
                
                refreshBtn.addEventListener('click', () => {
                    fetchProfiles();
                });
                
                exportCsvBtn.addEventListener('click', exportToCsv);
                
                columnSettingsBtn.addEventListener('click', toggleColumnSettingsPanel);
                
                document.addEventListener('click', (e) => {
                    if (!columnSettingsPanel.contains(e.target) && e.target !== columnSettingsBtn) {
                        columnSettingsPanel.style.display = 'none';
                    }
                });
                
                initColumnToggles();
                
                filterPubkey.addEventListener('input', () => {
                    state.filters.pubkey = filterPubkey.value;
                    applyFilters();
                });
                
                filterMinHops.addEventListener('change', () => {
                    state.filters.minHops = filterMinHops.value;
                    applyFilters();
                });
                
                filterMaxHops.addEventListener('change', () => {
                    state.filters.maxHops = filterMaxHops.value;
                    applyFilters();
                });
                
                filterMinRank.addEventListener('change', () => {
                    state.filters.minRank = filterMinRank.value;
                    applyFilters();
                });
                
                filterMaxRank.addEventListener('change', () => {
                    state.filters.maxRank = filterMaxRank.value;
                    applyFilters();
                });
                
                filterMinInfluence.addEventListener('change', () => {
                    state.filters.minInfluence = filterMinInfluence.value;
                    applyFilters();
                });
                
                filterMaxInfluence.addEventListener('change', () => {
                    state.filters.maxInfluence = filterMaxInfluence.value;
                    applyFilters();
                });
                
                filterMinAverage.addEventListener('change', () => {
                    state.filters.minAverage = filterMinAverage.value;
                    applyFilters();
                });
                
                filterMaxAverage.addEventListener('change', () => {
                    state.filters.maxAverage = filterMaxAverage.value;
                    applyFilters();
                });
                
                filterMinConfidence.addEventListener('change', () => {
                    state.filters.minConfidence = filterMinConfidence.value;
                    applyFilters();
                });
                
                filterMaxConfidence.addEventListener('change', () => {
                    state.filters.maxConfidence = filterMaxConfidence.value;
                    applyFilters();
                });
                
                filterMinInput.addEventListener('change', () => {
                    state.filters.minInput = filterMinInput.value;
                    applyFilters();
                });
                
                filterMaxInput.addEventListener('change', () => {
                    state.filters.maxInput = filterMaxInput.value;
                    applyFilters();
                });
                
                filterMinVerifiedFollowers.addEventListener('change', () => {
                    state.filters.minVerifiedFollowers = filterMinVerifiedFollowers.value;
                    applyFilters();
                });
                
                filterMaxVerifiedFollowers.addEventListener('change', () => {
                    state.filters.maxVerifiedFollowers = filterMaxVerifiedFollowers.value;
                    applyFilters();
                });
                
                filterMinNip56TotalScore.addEventListener('change', () => {
                    state.filters.minNip56TotalScore = filterMinNip56TotalScore.value;
                    applyFilters();
                });
                
                filterMaxNip56TotalScore.addEventListener('change', () => {
                    state.filters.maxNip56TotalScore = filterMaxNip56TotalScore.value;
                    applyFilters();
                });
            }
            
            function renderTable() {
                // Clear the table body
                tableBody.innerHTML = '';
                
                // Apply column visibility
                applyColumnVisibility();
                
                // Render profiles
                state.profiles.forEach(profile => {
                    const row = document.createElement('tr');
                    
                    // Profile picture cell
                    const profilePicCell = document.createElement('td');
                    profilePicCell.className = 'profile-pic-cell';
                    profilePicCell.dataset.column = 'profile-pic-col';
                    profilePicCell.dataset.pubkey = profile.pubkey;
                    
                    // Create link element that will contain the profile picture
                    const profileLink = document.createElement('a');
                    profileLink.href = `/profile.html?pubkey=${encodeURIComponent(profile.pubkey)}`;
                    profileLink.target = '_blank';
                    profileLink.className = 'profile-pic-link';
                    profilePicCell.appendChild(profileLink);
                    
                    // Create a placeholder (default profile pic or initial)
                    const placeholder = document.createElement('div');
                    placeholder.className = 'default-profile-pic';
                    placeholder.textContent = profile.pubkey.substring(0, 2).toUpperCase();
                    profileLink.appendChild(placeholder);
                    
                    // Lazy load the actual profile picture
                    loadProfilePicture(profile.pubkey, profilePicCell, profileLink);
                    
                    row.appendChild(profilePicCell);
                    
                    // Pubkey cell with truncation and hyperlink
                    const pubkeyCell = document.createElement('td');
                    pubkeyCell.className = 'pubkey-cell';
                    pubkeyCell.dataset.column = 'pubkey';
                    const pubkeyLink = document.createElement('a');
                    pubkeyLink.href = `https://njump.me/${profile.pubkey}`;
                    pubkeyLink.target = '_blank';
                    pubkeyLink.className = 'pubkey-link';
                    pubkeyLink.textContent = profile.pubkey.substring(0, 12) + '...';
                    pubkeyLink.title = profile.pubkey;
                    pubkeyCell.appendChild(pubkeyLink);
                    row.appendChild(pubkeyCell);
                    
                    // Numeric data cells
                    // Verify the property path is correct based on your API response
                    // Handle different possible data structures 
                    const verifiedFollowers = 
                        typeof profile.verified_follower_count !== 'undefined' ? profile.verified_follower_count : 
                        (typeof profile.verifiedFollowerCount !== 'undefined' ? profile.verifiedFollowerCount : 0);
                    
                    const nip56Score = 
                        typeof profile.nip56_total_score !== 'undefined' ? profile.nip56_total_score : 
                        (typeof profile.nip56TotalScore !== 'undefined' ? profile.nip56TotalScore : 0);
                    
                    const hops = 
                        typeof profile.hops !== 'undefined' ? profile.hops : 
                        (profile.hop_distance !== undefined ? profile.hop_distance : 999);
                    
                    const pageRank = 
                        typeof profile.personalized_page_rank !== 'undefined' ? profile.personalized_page_rank : 
                        (typeof profile.personalizedPageRank !== 'undefined' ? profile.personalizedPageRank : 0);
                    
                    const influence = 
                        typeof profile.influence !== 'undefined' ? profile.influence : 0;
                    
                    const average = 
                        typeof profile.average !== 'undefined' ? profile.average : 0;
                    
                    const confidence = 
                        typeof profile.confidence !== 'undefined' ? profile.confidence : 0;
                    
                    const input = 
                        typeof profile.input !== 'undefined' ? profile.input : 0;
                    
                    // Add cells with proper fallbacks
                    addNumericCell(row, verifiedFollowers, 0, 'verifiedFollowerCount');
                    addNumericCell(row, nip56Score, 0, 'nip56TotalScore');
                    addNumericCell(row, hops, 0, 'hops');
                    addNumericCell(row, pageRank, 6, 'personalizedPageRank');
                    addNumericCell(row, influence, 6, 'influence');
                    addNumericCell(row, average, 2, 'average');
                    addNumericCell(row, confidence, 2, 'confidence');
                    addNumericCell(row, input, 2, 'input');
                    
                    tableBody.appendChild(row);
                });
                
                if (state.profiles.length === 0) {
                    const row = document.createElement('tr');
                    const cell = document.createElement('td');
                    cell.colSpan = 10;
                    cell.textContent = 'No profiles found matching the current filters';
                    cell.style.textAlign = 'center';
                    cell.style.padding = '20px';
                    row.appendChild(cell);
                    tableBody.appendChild(row);
                }
                
                // Update sorting indicators in the table header
                updateSortIndicators(state.sort.column, state.sort.order);
            }
            
            /**
             * Load profile picture for a pubkey
             * @param {string} pubkey - User's public key
             * @param {HTMLElement} cell - The cell to update with the profile picture
             * @param {HTMLElement} link - The link element containing the profile picture
             */
            function loadProfilePicture(pubkey, cell, link) {
                // Check if we already have this profile in the cache
                if (state.profileCache[pubkey]) {
                    updateProfilePictureWithData(link, state.profileCache[pubkey]);
                    return;
                }
                
                // Fetch profile data
                fetch(`/control/api/get-kind0?pubkey=${pubkey}`)
                    .then(response => response.json())
                    .then(data => {
                        let profileData = null;
                        
                        // Process the profile data if available
                        if (data && data.success && data.data && data.data.content) {
                            try {
                                profileData = JSON.parse(data.data.content);
                                
                                // Cache the profile data
                                state.profileCache[pubkey] = profileData;
                                
                                // Update the picture with the profile data
                                updateProfilePictureWithData(link, profileData);
                            } catch (error) {
                                console.error('Error parsing profile data:', error);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching profile data:', error);
                    });
            }
            
            /**
             * Update a profile picture with profile data
             * @param {HTMLElement} link - The link element containing the profile picture
             * @param {Object} profileData - The profile data object
             */
            function updateProfilePictureWithData(link, profileData) {
                // Don't clear the link entirely - just replace its contents if needed
                
                if (profileData && profileData.picture) {
                    // Remove existing placeholder
                    link.innerHTML = '';
                    
                    // Create image element for the profile picture
                    const img = document.createElement('img');
                    img.src = profileData.picture;
                    img.alt = profileData.name || 'Profile Picture';
                    img.onerror = function() {
                        // If image fails to load, use the placeholder
                        this.style.display = 'none';
                        const placeholder = document.createElement('div');
                        placeholder.className = 'default-profile-pic';
                        placeholder.textContent = profileData.name ? profileData.name.substring(0, 2).toUpperCase() : '??';
                        link.appendChild(placeholder);
                    };
                    link.appendChild(img);
                } else if (profileData && profileData.name) {
                    // If we have a name but no picture, update the placeholder to use the name
                    link.innerHTML = '';
                    const placeholder = document.createElement('div');
                    placeholder.className = 'default-profile-pic';
                    placeholder.textContent = profileData.name.substring(0, 2).toUpperCase();
                    link.appendChild(placeholder);
                }
                
                // Add title/tooltip with user's name if available
                if (profileData && (profileData.display_name || profileData.name)) {
                    link.title = profileData.display_name || profileData.name;
                }
            }
            
            function addNumericCell(row, value, decimals = 0, columnId) {
                const cell = document.createElement('td');
                cell.className = 'numeric-cell';
                cell.dataset.column = columnId;
                
                if (value !== null && value !== undefined) {
                    const formattedValue = typeof value === 'number' 
                        ? value.toFixed(decimals)
                        : value;
                    cell.textContent = formattedValue;
                } else {
                    cell.textContent = '-';
                }
                
                row.appendChild(cell);
            }
            
            function renderPagination() {
                paginationContainer.innerHTML = '';
                
                const totalPages = state.pagination.pages || Math.ceil(state.pagination.total / state.pagination.limit);
                
                if (totalPages <= 1) {
                    return;
                }
                
                // Create pagination container
                const pagination = document.createElement('div');
                pagination.className = 'pagination';
                
                // "Previous" button
                const prevBtn = document.createElement('button');
                prevBtn.innerHTML = '&laquo; Previous';
                prevBtn.className = state.pagination.page === 1 ? 'disabled' : '';
                prevBtn.disabled = state.pagination.page === 1;
                prevBtn.addEventListener('click', () => {
                    if (state.pagination.page > 1) {
                        state.pagination.page--;
                        fetchProfiles();
                    }
                });
                pagination.appendChild(prevBtn);
                
                // Page buttons
                const maxButtons = 5; // Maximum number of page buttons to show
                const startPage = Math.max(1, state.pagination.page - Math.floor(maxButtons / 2));
                const endPage = Math.min(totalPages, startPage + maxButtons - 1);
                
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.textContent = i;
                    pageBtn.className = i === state.pagination.page ? 'active' : '';
                    pageBtn.addEventListener('click', () => {
                        state.pagination.page = i;
                        fetchProfiles();
                    });
                    pagination.appendChild(pageBtn);
                }
                
                // "Next" button
                const nextBtn = document.createElement('button');
                nextBtn.innerHTML = 'Next &raquo;';
                nextBtn.className = state.pagination.page === totalPages ? 'disabled' : '';
                nextBtn.disabled = state.pagination.page === totalPages;
                nextBtn.addEventListener('click', () => {
                    if (state.pagination.page < totalPages) {
                        state.pagination.page++;
                        fetchProfiles();
                    }
                });
                pagination.appendChild(nextBtn);
                
                paginationContainer.appendChild(pagination);
            }
            
            function updateSortIndicators(column, order) {
                // Remove existing sort indicators
                const headers = document.querySelectorAll('th');
                headers.forEach(header => {
                    header.classList.remove('sort-asc', 'sort-desc');
                });
                
                // Add indicator to current sort column
                const currentHeader = document.querySelector(`th[data-sort="${column}"]`);
                if (currentHeader) {
                    currentHeader.classList.add(order === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            }
            
            function showStatusMessage(message, type) {
                statusMessage.textContent = message;
                statusMessage.className = `status ${type}`;
                statusMessage.style.display = 'block';
                
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 5000);
            }
            
            // Update the profile count displays
            function updateProfileCounts() {
                document.getElementById('filteredCount').textContent = state.pagination.total.toLocaleString();
                document.getElementById('totalCount').textContent = state.totalCount.toLocaleString();
            }
            
            function exportToCsv() {
                // Only export visible columns
                const visibleColumns = columns.filter(col => state.columnVisibility[col.id] !== false);
                
                // Create CSV header
                let csvContent = visibleColumns.map(col => `"${col.name}"`).join(',') + '\n';
                
                // Add data rows
                state.filteredProfiles.forEach(profile => {
                    const row = [];
                    
                    visibleColumns.forEach(column => {
                        switch(column.id) {
                            case 'profile-pic-col':
                                row.push(''); // Skip profile picture in CSV
                                break;
                            case 'pubkey':
                                row.push(`"${profile.pubkey}"`);
                                break;
                            case 'verifiedFollowerCount':
                                row.push(profile.verifiedFollowerCount || 0);
                                break;
                            case 'nip56TotalScore':
                                row.push(profile.nip56TotalScore || 0);
                                break;
                            case 'hops':
                                row.push(profile.hops || 0);
                                break;
                            case 'personalizedPageRank':
                                row.push(profile.personalizedPageRank?.toFixed(6) || 0);
                                break;
                            case 'influence':
                                row.push(profile.influence?.toFixed(6) || 0);
                                break;
                            case 'average':
                                row.push(profile.average?.toFixed(2) || 0);
                                break;
                            case 'confidence':
                                row.push(profile.confidence?.toFixed(2) || 0);
                                break;
                            case 'input':
                                row.push(profile.input?.toFixed(2) || 0);
                                break;
                            default:
                                row.push('');
                        }
                    });
                    
                    csvContent += row.join(',') + '\n';
                });
                
                // Create and trigger download
                const encodedUri = encodeURI('data:text/csv;charset=utf-8,' + csvContent);
                const link = document.createElement('a');
                link.setAttribute('href', encodedUri);
                link.setAttribute('download', `brainstorm-profiles-${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showStatusMessage('CSV export completed', 'success');
            }

            // Save column visibility settings to localStorage
            function saveColumnVisibility() {
                localStorage.setItem('profilesColumnVisibility', JSON.stringify(state.columnVisibility));
            }
            
            // Initialize column toggle checkboxes
            function initColumnToggles() {
                // Clear existing toggles
                columnToggles.innerHTML = '';
                
                // Create toggle for each column
                columns.forEach(column => {
                    const toggleDiv = document.createElement('div');
                    toggleDiv.className = 'column-toggle';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `toggle-${column.id}`;
                    checkbox.checked = state.columnVisibility[column.id] !== false;
                    checkbox.disabled = column.alwaysVisible === true;
                    
                    checkbox.addEventListener('change', () => {
                        state.columnVisibility[column.id] = checkbox.checked;
                        saveColumnVisibility();
                        applyColumnVisibility();
                    });
                    
                    const label = document.createElement('label');
                    label.htmlFor = `toggle-${column.id}`;
                    label.textContent = column.name;
                    
                    toggleDiv.appendChild(checkbox);
                    toggleDiv.appendChild(label);
                    columnToggles.appendChild(toggleDiv);
                });
            }
            
            // Apply column visibility settings to the table
            function applyColumnVisibility() {
                // Apply to header cells
                const headerCells = document.querySelectorAll('#profilesTable th');
                headerCells.forEach(cell => {
                    const columnId = cell.getAttribute('data-sort') || cell.className;
                    
                    if (columnId && state.columnVisibility[columnId] === false) {
                        cell.classList.add('hidden-column');
                    } else {
                        cell.classList.remove('hidden-column');
                    }
                });
                
                // Apply to filter row cells
                const filterCells = document.querySelectorAll('.filter-row th');
                filterCells.forEach((cell, index) => {
                    const headerCell = headerCells[index];
                    if (headerCell && headerCell.classList.contains('hidden-column')) {
                        cell.classList.add('hidden-column');
                    } else {
                        cell.classList.remove('hidden-column');
                    }
                });
                
                // Apply to data cells
                const dataCells = document.querySelectorAll('#profilesTable tbody td');
                dataCells.forEach(cell => {
                    const columnId = cell.dataset.column;
                    if (columnId && state.columnVisibility[columnId] === false) {
                        cell.classList.add('hidden-column');
                    } else {
                        cell.classList.remove('hidden-column');
                    }
                });
            }
            
            // Toggle column settings panel visibility
            function toggleColumnSettingsPanel() {
                if (columnSettingsPanel.style.display === 'block') {
                    columnSettingsPanel.style.display = 'none';
                } else {
                    columnSettingsPanel.style.display = 'block';
                }
            }
            
            // Apply filters to the profiles
            function applyFilters() {
                state.filteredProfiles = state.profiles.filter(profile => {
                    // Filter by pubkey (partial match)
                    if (state.filters.pubkey && !profile.pubkey.toLowerCase().includes(state.filters.pubkey.toLowerCase())) {
                        return false;
                    }
                    
                    // Numeric filters
                    if (state.filters.minHops && (!profile.hops || profile.hops < parseInt(state.filters.minHops))) return false;
                    if (state.filters.maxHops && (profile.hops > parseInt(state.filters.maxHops))) return false;
                    
                    if (state.filters.minRank && (!profile.personalizedPageRank || profile.personalizedPageRank < parseFloat(state.filters.minRank))) return false;
                    if (state.filters.maxRank && (profile.personalizedPageRank > parseFloat(state.filters.maxRank))) return false;
                    
                    if (state.filters.minInfluence && (!profile.influence || profile.influence < parseFloat(state.filters.minInfluence))) return false;
                    if (state.filters.maxInfluence && (profile.influence > parseFloat(state.filters.maxInfluence))) return false;
                    
                    if (state.filters.minAverage && (!profile.average || profile.average < parseFloat(state.filters.minAverage))) return false;
                    if (state.filters.maxAverage && (profile.average > parseFloat(state.filters.maxAverage))) return false;
                    
                    if (state.filters.minConfidence && (!profile.confidence || profile.confidence < parseFloat(state.filters.minConfidence))) return false;
                    if (state.filters.maxConfidence && (profile.confidence > parseFloat(state.filters.maxConfidence))) return false;
                    
                    if (state.filters.minInput && (!profile.input || profile.input < parseFloat(state.filters.minInput))) return false;
                    if (state.filters.maxInput && (profile.input > parseFloat(state.filters.maxInput))) return false;
                    
                    if (state.filters.minVerifiedFollowers && (!profile.verifiedFollowerCount || profile.verifiedFollowerCount < parseInt(state.filters.minVerifiedFollowers))) return false;
                    if (state.filters.maxVerifiedFollowers && (profile.verifiedFollowerCount > parseInt(state.filters.maxVerifiedFollowers))) return false;
                    
                    // NIP-56 Total Score filter
                    if (state.filters.minNip56TotalScore && (!profile.nip56TotalScore || profile.nip56TotalScore < parseFloat(state.filters.minNip56TotalScore))) return false;
                    if (state.filters.maxNip56TotalScore && (profile.nip56TotalScore > parseFloat(state.filters.maxNip56TotalScore))) return false;
                    
                    return true;
                });
                
                // Apply sorting to the filtered profiles
                sortProfiles();
                
                // Apply pagination
                applyPagination();
                
                // Update the table with the filtered, sorted, and paginated profiles
                renderTable();
                
                // Update profile counts
                updateProfileCounts();
            }
            
            // Sort the profiles by the selected column
            function sortProfiles() {
                // Sort by the selected column
                state.filteredProfiles.sort((a, b) => {
                    let aValue, bValue;
                    
                    // Handle specific column sorting
                    switch (state.sort.column) {
                        case 'pubkey':
                            aValue = a.pubkey;
                            bValue = b.pubkey;
                            break;
                        case 'verifiedFollowerCount':
                            aValue = a.verifiedFollowerCount || 0;
                            bValue = b.verifiedFollowerCount || 0;
                            break;
                        case 'nip56TotalScore':
                            aValue = a.nip56TotalScore || 0;
                            bValue = b.nip56TotalScore || 0;
                            break;
                        case 'hops':
                            aValue = a.hops || 0;
                            bValue = b.hops || 0;
                            break;
                        case 'personalizedPageRank':
                            aValue = a.personalizedPageRank || 0;
                            bValue = b.personalizedPageRank || 0;
                            break;
                        case 'influence':
                            aValue = a.influence || 0;
                            bValue = b.influence || 0;
                            break;
                        case 'average':
                            aValue = a.average || 0;
                            bValue = b.average || 0;
                            break;
                        case 'confidence':
                            aValue = a.confidence || 0;
                            bValue = b.confidence || 0;
                            break;
                        case 'input':
                            aValue = a.input || 0;
                            bValue = b.input || 0;
                            break;
                        default:
                            aValue = a[state.sort.column] || 0;
                            bValue = b[state.sort.column] || 0;
                    }
                    
                    // String comparison for pubkey
                    if (typeof aValue === 'string' && typeof bValue === 'string') {
                        const result = aValue.localeCompare(bValue);
                        return state.sort.order === 'asc' ? result : -result;
                    }
                    
                    // Numeric comparison for other fields
                    const result = aValue - bValue;
                    return state.sort.order === 'asc' ? result : -result;
                });
            }

            // Apply pagination to the filtered and sorted profiles
            function applyPagination() {
                const { page, limit } = state.pagination;
                const startIndex = (page - 1) * limit;
                const endIndex = startIndex + limit;
                
                state.profiles = state.filteredProfiles.slice(startIndex, endIndex);
            }
            
            function resetFilters() {
                // Clear all input values
                filterPubkey.value = '';
                filterMinHops.value = '';
                filterMaxHops.value = '';
                filterMinRank.value = '';
                filterMaxRank.value = '';
                filterMinInfluence.value = '';
                filterMaxInfluence.value = '';
                filterMinAverage.value = '';
                filterMaxAverage.value = '';
                filterMinConfidence.value = '';
                filterMaxConfidence.value = '';
                filterMinInput.value = '';
                filterMaxInput.value = '';
                filterMinVerifiedFollowers.value = '';
                filterMaxVerifiedFollowers.value = '';
                filterMinNip56TotalScore.value = '';
                filterMaxNip56TotalScore.value = '';
                
                // Reset state filters
                state.filters = {
                    pubkey: '',
                    minHops: '',
                    maxHops: '',
                    minRank: '',
                    maxRank: '',
                    minInfluence: '',
                    maxInfluence: '',
                    minAverage: '',
                    maxAverage: '',
                    minConfidence: '',
                    maxConfidence: '',
                    minInput: '',
                    maxInput: '',
                    minVerifiedFollowers: '',
                    maxVerifiedFollowers: '',
                    minNip56TotalScore: '',
                    maxNip56TotalScore: ''
                };
                
                // Reset to first page
                state.pagination.page = 1;
                
                // Apply filters (this will render the table)
                applyFilters();
            }
        });
    </script>
</body>
</html>
