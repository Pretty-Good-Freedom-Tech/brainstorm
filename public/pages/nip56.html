<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIP-56 Reports Summary</title>
    <link rel="stylesheet" href="/control/css/profiles.css">
    <script src="./components/header/header.js"></script>
    <link rel="shortcut icon" href="/control/img/brainstorm010.svg">
    <style>
        .report-type-selector {
            margin: 20px 0 30px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .report-type-selector label {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="headerContainer"></div>
    <div class="container">
        <div class="header-profiles">
            <h1>NIP-56 Reports Summary</h1>
            <div class="report-type-selector">
                <label for="reportTypeSelect">Report Type:</label>
                <select id="reportTypeSelect"></select>
                <button id="refreshBtn">Refresh</button>
            </div>
        </div>
        <div id="tableContainer">
            <div id="loadingIndicator" class="loading"></div>
            <table id="nip56ProfilesTable" style="display: none;">
                <thead>
                    <tr class="header-row">
                        <th class="profile-pic-col">Pic</th>
                        <th>Pubkey</th>
                        <th>üçá-Report Score</th>
                        <th>üçá-Verified Report Count</th>
                        <th>Total Report Count</th>
                        <th>Influence</th>
                        <th>üçá-Verified Followers</th>
                    </tr>
                    <tr class="filter-row">
                        <th></th>
                        <th><input type="text" id="filterPubkey" placeholder="Pubkey contains..." class="table-filter"></th>
                        <th><input type="number" id="filterMinGrapeRank" placeholder="Min" class="table-filter small-input"> <input type="number" id="filterMaxGrapeRank" placeholder="Max" class="table-filter small-input"></th>
                        <th><input type="number" id="filterMinVerifiedCount" placeholder="Min" class="table-filter small-input"> <input type="number" id="filterMaxVerifiedCount" placeholder="Max" class="table-filter small-input"></th>
                        <th><input type="number" id="filterMinTotalCount" placeholder="Min" class="table-filter small-input"> <input type="number" id="filterMaxTotalCount" placeholder="Max" class="table-filter small-input"></th>
                        <th><input type="number" id="filterMinInfluence" placeholder="Min" class="table-filter small-input"> <input type="number" id="filterMaxInfluence" placeholder="Max" class="table-filter small-input"></th>
                        <th><input type="number" id="filterMinVerifiedFollowers" placeholder="Min" class="table-filter small-input"> <input type="number" id="filterMaxVerifiedFollowers" placeholder="Max" class="table-filter small-input"></th>
                    </tr>
                </thead>
                <tbody id="nip56ProfilesTableBody"></tbody>
            </table>
        </div>
        <div id="paginationContainer" class="pagination" style="display: none;"></div>
    </div>
    <script>
    // --- Report Types ---
    const reportTypes = [
        'nudity',
        'malware',
        'profanity',
        'illegal',
        'spam',
        'impersonation',
        'other'
    ];
    // --- DOM Elements ---
    const reportTypeSelect = document.getElementById('reportTypeSelect');
    const refreshBtn = document.getElementById('refreshBtn');
    const tableBody = document.getElementById('nip56ProfilesTableBody');
    const profilesTable = document.getElementById('nip56ProfilesTable');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const paginationContainer = document.getElementById('paginationContainer');
    // --- State ---
    let state = {
        profiles: [],
        pagination: {
            total: 0,
            page: 1,
            limit: 100,
            pages: 1
        },
        reportType: reportTypes[0],
        sortBy: 'grapeRankScore',
        sortOrder: 'desc',
        filters: {
            pubkey: '',
            minGrapeRank: '',
            maxGrapeRank: '',
            minVerifiedCount: '',
            maxVerifiedCount: '',
            minTotalCount: '',
            maxTotalCount: '',
            minInfluence: '',
            maxInfluence: '',
            minVerifiedFollowers: '',
            maxVerifiedFollowers: ''
        }
    };
    // --- Populate Report Type Selector ---
    function populateReportTypeSelector() {
        reportTypes.forEach(type => {
            const opt = document.createElement('option');
            opt.value = type;
            opt.textContent = type.charAt(0).toUpperCase() + type.slice(1);
            reportTypeSelect.appendChild(opt);
        });
        reportTypeSelect.value = state.reportType;
    }
    // --- Fetch Profiles ---
    function fetchProfiles() {
        loadingIndicator.style.display = 'flex';
        profilesTable.style.display = 'none';
        paginationContainer.style.display = 'none';
        tableBody.innerHTML = '';
        const params = new URLSearchParams({
            page: state.pagination.page,
            limit: state.pagination.limit,
            reportType: state.reportType,
            sortBy: state.sortBy,
            sortOrder: state.sortOrder
        });
        fetch(`/api/get-nip56-profiles?${params}`)
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    state.profiles = data.data.profiles;
                    state.pagination.total = data.data.total;
                    state.pagination.pages = Math.ceil(data.data.total / state.pagination.limit);
                    renderTable();
                    renderPagination();
                    profilesTable.style.display = '';
                    paginationContainer.style.display = '';
                } else {
                    tableBody.innerHTML = `<tr><td colspan="7">${data.message || 'Failed to load data'}</td></tr>`;
                }
            })
            .catch(e => {
                tableBody.innerHTML = `<tr><td colspan="7">Error: ${e.message}</td></tr>`;
            })
            .finally(() => {
                loadingIndicator.style.display = 'none';
            });
    }
    // --- Render Table ---
    function renderTable() {
        tableBody.innerHTML = '';
        let filtered = filterProfiles(state.profiles);
        if (filtered.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7">No profiles found for this report type.</td></tr>';
            return;
        }
        filtered.forEach(profile => {
            const row = document.createElement('tr');
            // Profile pic
            const picCell = document.createElement('td');
            picCell.className = 'profile-pic-cell';
            const picLink = document.createElement('a');
            picLink.href = `profile.html?pubkey=${profile.pubkey}`;
            picLink.target = '_blank';
            const img = document.createElement('img');
            img.src = `/img/default-avatar.png`;
            img.alt = 'Profile Picture';
            img.className = 'profile-pic';
            loadProfilePicture(profile.pubkey, img);
            picLink.appendChild(img);
            picCell.appendChild(picLink);
            row.appendChild(picCell);
            // Pubkey (link to njump.me, shortened)
            const pubkeyCell = document.createElement('td');
            const pubkeyLink = document.createElement('a');
            pubkeyLink.href = `https://njump.me/p/${profile.pubkey}`;
            pubkeyLink.target = '_blank';
            pubkeyLink.className = 'pubkey-link';
            pubkeyLink.textContent = profile.pubkey.substring(0, 12) + '...';
            pubkeyLink.title = profile.pubkey;
            pubkeyCell.appendChild(pubkeyLink);
            row.appendChild(pubkeyCell);
            // GrapeRank Score
            addNumericCell(row, profile.grapeRankScore, 3);
            // Verified Report Count
            addNumericCell(row, profile.totalVerifiedCount);
            // Report Count
            addNumericCell(row, profile.totalCount);
            // Influence
            addNumericCell(row, profile.influence, 4);
            // Verified Follower Count
            addNumericCell(row, profile.verifiedFollowerCount);
            tableBody.appendChild(row);
        });
    }
    // --- Add Numeric Cell ---
    function addNumericCell(row, value, decimals = 0) {
        const td = document.createElement('td');
        if (typeof value === 'number' && !isNaN(value)) {
            td.textContent = decimals > 0 ? value.toFixed(decimals) : value;
        } else {
            td.textContent = '‚Äî';
        }
        row.appendChild(td);
    }
    // --- Profile Picture Cache (shared with profiles.html pattern) ---
    const profileCache = {};

    // --- Load Profile Picture (fetches kind0 profile, uses cache, fallback to default avatar) ---
    function loadProfilePicture(pubkey, imgElement) {
        // If already loaded, use cached data
        if (profileCache[pubkey]) {
            updateProfilePictureWithData(imgElement, profileCache[pubkey]);
            return;
        }
        // Fetch kind0 profile
        fetch(`/control/api/get-kind0?pubkey=${pubkey}`)
            .then(response => response.json())
            .then(data => {
                let profileData = null;
                if (data.success && data.data && data.data.content) {
                    try {
                        profileData = JSON.parse(data.data.content);
                    } catch (e) {
                        // Ignore parse errors
                    }
                }
                profileCache[pubkey] = profileData || {};
                updateProfilePictureWithData(imgElement, profileCache[pubkey]);
            })
            .catch(() => {
                // On error, just use default
                updateProfilePictureWithData(imgElement, {});
            });
    }

    // --- Update Profile Picture With Data (fail gracefully like profiles.html) ---
    function updateProfilePictureWithData(imgElement, profileData) {
        // Remove any previous sibling placeholder
        if (imgElement.nextSibling && imgElement.nextSibling.classList && imgElement.nextSibling.classList.contains('default-profile-pic')) {
            imgElement.parentNode.removeChild(imgElement.nextSibling);
        }
        if (profileData && profileData.picture) {
            imgElement.src = profileData.picture;
            imgElement.style.display = '';
            imgElement.onerror = function() {
                // Hide broken image, show placeholder with name/??
                imgElement.style.display = 'none';
                let placeholder = document.createElement('div');
                placeholder.className = 'default-profile-pic';
                if (profileData.name) {
                    placeholder.textContent = profileData.name.substring(0, 2).toUpperCase();
                } else {
                    placeholder.textContent = '??';
                }
                imgElement.parentNode.appendChild(placeholder);
            };
        } else if (profileData && profileData.name) {
            imgElement.style.display = 'none';
            let placeholder = document.createElement('div');
            placeholder.className = 'default-profile-pic';
            placeholder.textContent = profileData.name.substring(0, 2).toUpperCase();
            imgElement.parentNode.appendChild(placeholder);
        } else {
            imgElement.src = '/img/default-avatar.png';
            imgElement.style.display = '';
            imgElement.onerror = function() {
                imgElement.style.display = 'none';
                let placeholder = document.createElement('div');
                placeholder.className = 'default-profile-pic';
                placeholder.textContent = '??';
                imgElement.parentNode.appendChild(placeholder);
            };
        }
        // Tooltip with name if available
        if (profileData && (profileData.display_name || profileData.name)) {
            imgElement.title = profileData.display_name || profileData.name;
        }
    }
    // --- Pagination ---
    function renderPagination() {
        paginationContainer.innerHTML = '';
        if (state.pagination.pages <= 1) return;
        for (let i = 1; i <= state.pagination.pages; i++) {
            const btn = document.createElement('button');
            btn.textContent = i;
            btn.className = (i === state.pagination.page) ? 'active' : '';
            btn.onclick = () => {
                state.pagination.page = i;
                fetchProfiles();
            };
            paginationContainer.appendChild(btn);
        }
    }
    // --- Event Listeners ---
    reportTypeSelect.addEventListener('change', () => {
        state.reportType = reportTypeSelect.value;
        state.pagination.page = 1;
        fetchProfiles();
    });
    refreshBtn.addEventListener('click', () => {
        fetchProfiles();
    });
    // --- Setup filter input events ---
    function setupFilterInputs() {
        document.getElementById('filterPubkey').addEventListener('input', e => {
            state.filters.pubkey = e.target.value;
            renderTable();
        });
        document.getElementById('filterMinGrapeRank').addEventListener('input', e => { state.filters.minGrapeRank = e.target.value; renderTable(); });
        document.getElementById('filterMaxGrapeRank').addEventListener('input', e => { state.filters.maxGrapeRank = e.target.value; renderTable(); });
        document.getElementById('filterMinVerifiedCount').addEventListener('input', e => { state.filters.minVerifiedCount = e.target.value; renderTable(); });
        document.getElementById('filterMaxVerifiedCount').addEventListener('input', e => { state.filters.maxVerifiedCount = e.target.value; renderTable(); });
        document.getElementById('filterMinTotalCount').addEventListener('input', e => { state.filters.minTotalCount = e.target.value; renderTable(); });
        document.getElementById('filterMaxTotalCount').addEventListener('input', e => { state.filters.maxTotalCount = e.target.value; renderTable(); });
        document.getElementById('filterMinInfluence').addEventListener('input', e => { state.filters.minInfluence = e.target.value; renderTable(); });
        document.getElementById('filterMaxInfluence').addEventListener('input', e => { state.filters.maxInfluence = e.target.value; renderTable(); });
        document.getElementById('filterMinVerifiedFollowers').addEventListener('input', e => { state.filters.minVerifiedFollowers = e.target.value; renderTable(); });
        document.getElementById('filterMaxVerifiedFollowers').addEventListener('input', e => { state.filters.maxVerifiedFollowers = e.target.value; renderTable(); });
    }

    // --- Sorting: header click events ---
    function setupSorting() {
        const headerRow = document.querySelector('#nip56ProfilesTable .header-row');
        const sortMap = [
            null, // Pic
            'pubkey',
            'grapeRankScore',
            'totalVerifiedCount',
            'totalCount',
            'influence',
            'verifiedFollowerCount'
        ];
        headerRow.querySelectorAll('th').forEach((th, idx) => {
            if (sortMap[idx]) {
                th.style.cursor = 'pointer';
                th.addEventListener('click', () => {
                    if (state.sortBy === sortMap[idx]) {
                        state.sortOrder = state.sortOrder === 'asc' ? 'desc' : 'asc';
                    } else {
                        state.sortBy = sortMap[idx];
                        state.sortOrder = 'desc';
                    }
                    fetchProfiles();
                });
            }
        });
    }

    // --- Table Filtering Logic ---
    function filterProfiles(profiles) {
        return profiles.filter(profile => {
            if (state.filters.pubkey && !profile.pubkey.includes(state.filters.pubkey)) return false;
            if (state.filters.minGrapeRank && Number(profile.grapeRankScore) < Number(state.filters.minGrapeRank)) return false;
            if (state.filters.maxGrapeRank && Number(profile.grapeRankScore) > Number(state.filters.maxGrapeRank)) return false;
            if (state.filters.minVerifiedCount && Number(profile.totalVerifiedCount) < Number(state.filters.minVerifiedCount)) return false;
            if (state.filters.maxVerifiedCount && Number(profile.totalVerifiedCount) > Number(state.filters.maxVerifiedCount)) return false;
            if (state.filters.minTotalCount && Number(profile.totalCount) < Number(state.filters.minTotalCount)) return false;
            if (state.filters.maxTotalCount && Number(profile.totalCount) > Number(state.filters.maxTotalCount)) return false;
            if (state.filters.minInfluence && Number(profile.influence) < Number(state.filters.minInfluence)) return false;
            if (state.filters.maxInfluence && Number(profile.influence) > Number(state.filters.maxInfluence)) return false;
            if (state.filters.minVerifiedFollowers && Number(profile.verifiedFollowerCount) < Number(state.filters.minVerifiedFollowers)) return false;
            if (state.filters.maxVerifiedFollowers && Number(profile.verifiedFollowerCount) > Number(state.filters.maxVerifiedFollowers)) return false;
            return true;
        });
    }

    // --- Init: setup filter and sort events ---
    document.addEventListener('DOMContentLoaded', function() {
        populateReportTypeSelector();
        setupFilterInputs();
        setupSorting();
        fetchProfiles();
    });
    </script>
</body>
</html>
