<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Details - Brainstorm</title>
    <script src="./components/header/header.js"></script>
    <script src="./components/footer/footer.js"></script>
    <link rel="shortcut icon" href="/control/img/brainstorm010.svg">
    <link rel="stylesheet" href="/css/common.css">
    <style>
        .task-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .task-header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
        }

        .task-title {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .task-subtitle {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .task-overview {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .overview-item {
            text-align: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .overview-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 0.25rem;
        }

        .overview-label {
            color: #666;
            font-size: 0.9rem;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .status-indicator.running {
            background: #fff3cd;
            color: #856404;
        }

        .status-indicator.success {
            background: #d4edda;
            color: #155724;
        }

        .status-indicator.failed {
            background: #f8d7da;
            color: #721c24;
        }

        .status-indicator.never-run {
            background: #f5f5f5;
            color: #757575;
        }

        .section {
            background: white;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .section-content {
            padding: 1.5rem;
        }

        .toggle-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }

        .toggle-btn:hover {
            background: #0056b3;
        }

        .toggle-btn.active {
            background: #28a745;
        }

        .execution-sessions {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .session-row {
            border: 1px solid #e9ecef;
            border-radius: 6px;
            transition: box-shadow 0.2s;
        }

        .session-row:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .session-compact {
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
        }

        .session-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .session-status.running {
            background: #ffc107;
            animation: pulse 2s infinite;
        }

        .session-status.success {
            background: #28a745;
        }

        .session-status.failed {
            background: #dc3545;
        }

        .session-status.unknown {
            background: #6c757d;
        }

        .session-info {
            flex: 1;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 1rem;
            align-items: center;
        }

        .session-time {
            font-weight: 500;
            color: #333;
        }

        .session-duration {
            color: #666;
            font-size: 0.9rem;
        }

        .session-phases {
            color: #666;
            font-size: 0.9rem;
        }

        .session-pid {
            font-family: monospace;
            color: #666;
            font-size: 0.9rem;
        }

        .session-expand-btn {
            background: none;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
            color: #6c757d;
            transition: all 0.2s;
        }

        .session-expand-btn:hover {
            background: #f8f9fa;
            border-color: #adb5bd;
        }

        .session-expand-btn.expanded {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .session-expanded {
            padding: 1.5rem;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
            display: none;
        }

        .session-expanded.visible {
            display: block;
        }

        .session-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 1.5rem;
        }

        .detail-group {
            background: white;
            padding: 1rem;
            border-radius: 4px;
            border-left: 3px solid #007bff;
        }

        .detail-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .detail-label {
            color: #666;
        }

        .detail-value {
            color: #333;
            font-weight: 500;
        }

        .phases-list {
            margin-top: 1rem;
        }

        .phase-item {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #28a745;
        }

        .phase-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .phase-name {
            font-weight: 500;
            color: #333;
        }

        .phase-time {
            font-size: 0.8rem;
            color: #666;
        }

        .phase-description {
            color: #666;
            font-size: 0.9rem;
        }

        .events-timeline {
            margin-top: 1.5rem;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }

        .timeline-title {
            font-weight: 600;
            color: #333;
            font-size: 1.1rem;
        }

        .timeline-count {
            color: #666;
            font-size: 0.9rem;
        }

        .event-card {
            border: 1px solid #e9ecef;
            border-radius: 6px;
            margin-bottom: 0.75rem;
            transition: box-shadow 0.2s;
        }

        .event-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .event-compact {
            padding: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
        }

        .event-type-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .event-type-indicator.TASK_START {
            background: #28a745;
        }

        .event-type-indicator.TASK_END {
            background: #007bff;
        }

        .event-type-indicator.TASK_ERROR {
            background: #dc3545;
        }

        .event-type-indicator.PROGRESS {
            background: #ffc107;
        }

        .event-type-indicator.CHILD_TASK_ERROR {
            background: #fd7e14;
        }

        .event-type-indicator.default {
            background: #6c757d;
        }

        .event-summary {
            flex: 1;
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            gap: 1rem;
            align-items: center;
        }

        .event-type {
            font-weight: 500;
            color: #333;
            font-size: 0.9rem;
        }

        .event-description {
            color: #666;
            font-size: 0.85rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .event-time {
            color: #666;
            font-size: 0.8rem;
            font-family: monospace;
        }

        .event-expand-btn {
            background: none;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.7rem;
            color: #6c757d;
            transition: all 0.2s;
        }

        .event-expand-btn:hover {
            background: #f8f9fa;
            border-color: #adb5bd;
        }

        .event-expand-btn.expanded {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .event-expanded {
            padding: 1rem;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
            display: none;
        }

        .event-expanded.visible {
            display: block;
        }

        .event-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .event-detail-group {
            background: white;
            padding: 0.75rem;
            border-radius: 4px;
            border-left: 3px solid #007bff;
        }

        .event-detail-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .event-detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
            font-size: 0.8rem;
        }

        .event-detail-label {
            color: #666;
        }

        .event-detail-value {
            color: #333;
            font-weight: 500;
            font-family: monospace;
        }

        .event-metadata {
            background: white;
            padding: 0.75rem;
            border-radius: 4px;
            border-left: 3px solid #28a745;
            margin-bottom: 1rem;
        }

        .metadata-content {
            font-family: monospace;
            font-size: 0.8rem;
            color: #333;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .raw-data-toggle {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-bottom: 1rem;
        }

        .raw-data-toggle:hover {
            background: #5a6268;
        }

        .raw-data-toggle.active {
            background: #dc3545;
        }

        .raw-data {
            background: #2d3748;
            color: #e2e8f0;
            padding: 0.75rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            display: none;
        }

        .raw-data.visible {
            display: block;
        }

        .raw-data-header {
            color: #a0aec0;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #4a5568;
            font-size: 0.7rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #007bff;
            text-decoration: none;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .task-container {
                padding: 1rem;
            }

            .session-info {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .session-details {
                grid-template-columns: 1fr;
            }

            .overview-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Include the header component -->
    <div id="headerContainer"></div>

    <div class="page-content task-container">
        <a href="/task-explorer.html" class="back-link">
            ← Back to Task Explorer
        </a>

        <div id="loading" class="loading">
            Loading task details...
        </div>

        <div id="error-container" style="display: none;"></div>

        <div id="task-content" style="display: none;">
            <!-- Task Header -->
            <div class="task-header">
                <div class="task-title" id="task-title">Task Name</div>
                <div class="task-subtitle" id="task-subtitle">Loading task information...</div>
            </div>

            <!-- Task Overview -->
            <div class="task-overview">
                <div class="overview-grid">
                    <div class="overview-item">
                        <div class="overview-value" id="total-runs">-</div>
                        <div class="overview-label">Total Runs</div>
                    </div>
                    <div class="overview-item">
                        <div class="overview-value" id="success-rate">-</div>
                        <div class="overview-label">Success Rate</div>
                    </div>
                    <div class="overview-item">
                        <div class="overview-value" id="avg-duration">-</div>
                        <div class="overview-label">Avg Duration (All)</div>
                    </div>
                    <div class="overview-item">
                        <div class="overview-value" id="avg-success-duration">-</div>
                        <div class="overview-label">Avg Success Duration</div>
                    </div>
                    <div class="overview-item">
                        <div class="overview-value" id="avg-failure-duration">-</div>
                        <div class="overview-label">Avg Failure Duration</div>
                    </div>
                    <div class="overview-item">
                        <div class="overview-value" id="current-status">-</div>
                        <div class="overview-label">Current Status</div>
                    </div>
                </div>

                <div id="task-description" style="color: #666; font-size: 0.95rem; text-align: center;">
                    Loading task description...
                </div>
            </div>

            <!-- Execution Sessions -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Execution History</h2>
                    <span id="sessions-count" style="color: #666; font-size: 0.9rem;">0 sessions</span>
                </div>
                <div class="section-content">
                    <div id="execution-sessions" class="execution-sessions">
                        <!-- Sessions will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Raw Events Data -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Raw Events Data</h2>
                    <button id="raw-events-toggle" class="toggle-btn">Show Raw Events</button>
                </div>
                <div class="section-content">
                    <div id="raw-events-info" style="color: #666; margin-bottom: 1rem;">
                        Click "Show Raw Events" to view all events.jsonl data for this task (equivalent to: cat events.jsonl | grep taskName)
                    </div>
                    <div id="raw-events-container" style="display: none;">
                        <div class="raw-events-header" id="raw-events-header">
                            Loading raw events data...
                        </div>
                        <div class="raw-events" id="raw-events-content">
                            <!-- Raw events will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer container -->
    <div id="footerContainer"></div>

    <script>
        // Task Details JavaScript
        let taskData = null;
        let taskName = null;

        // Get task name from URL parameters
        function getTaskNameFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('taskName');
        }

        // Load task data
        async function loadTaskData() {
            try {
                taskName = getTaskNameFromURL();
                
                if (!taskName) {
                    throw new Error('No taskName parameter provided in URL');
                }

                const response = await fetch(`/api/task-explorer/single-task/data?taskName=${encodeURIComponent(taskName)}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                taskData = await response.json();
                
                renderTaskData();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error-container').style.display = 'none';
                document.getElementById('task-content').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading task data:', error);
                displayError(`Failed to load task data: ${error.message}`);
            }
        }

        // Render task data
        function renderTaskData() {
            if (!taskData) return;

            const { task, executionSessions, rawEvents, statistics } = taskData;

            // Update header
            document.getElementById('task-title').textContent = task.name;
            document.getElementById('task-subtitle').textContent = task.description || 'No description available';

            // Update overview
            const execution = task.execution;
            document.getElementById('total-runs').textContent = execution?.totalRuns || 0;
            document.getElementById('success-rate').textContent = execution?.successRate ? `${execution.successRate}%` : '0%';
            document.getElementById('avg-duration').textContent = execution?.averageDurationFormatted || 'N/A';
            document.getElementById('avg-success-duration').textContent = execution?.averageSuccessDurationFormatted || 'N/A';
            document.getElementById('avg-failure-duration').textContent = execution?.averageFailureDurationFormatted || 'N/A';
            
            // Current status
            const statusElement = document.getElementById('current-status');
            if (execution?.isRunning) {
                statusElement.innerHTML = '<span class="status-indicator running">🔄 Running</span>';
            } else if (execution?.lastStatus === 'success') {
                statusElement.innerHTML = '<span class="status-indicator success">✅ Success</span>';
            } else if (execution?.lastStatus === 'failed') {
                // Show different status for caught vs uncaught errors
                if (execution?.errorType === 'caught') {
                    statusElement.innerHTML = '<span class="status-indicator failed">❌ Failed (Caught)</span>';
                } else if (execution?.errorType === 'uncaught') {
                    statusElement.innerHTML = '<span class="status-indicator failed">💥 Failed (Silent)</span>';
                } else {
                    statusElement.innerHTML = '<span class="status-indicator failed">❌ Failed</span>';
                }
            } else {
                statusElement.innerHTML = '<span class="status-indicator never-run">⚫ Never Run</span>';
            }

            // Update description
            document.getElementById('task-description').textContent = task.description || 'No description available';

            // Update sessions count
            document.getElementById('sessions-count').textContent = `${executionSessions.length} session${executionSessions.length !== 1 ? 's' : ''}`;

            // Render execution sessions
            renderExecutionSessions(executionSessions);

            // Setup raw events toggle
            setupRawEventsToggle(rawEvents);
        }

        // Render execution sessions
        function renderExecutionSessions(sessions) {
            const container = document.getElementById('execution-sessions');
            container.innerHTML = '';

            if (sessions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No execution sessions found for this task.</p>';
                return;
            }

            sessions.forEach((session, index) => {
                const sessionElement = createSessionElement(session, index);
                container.appendChild(sessionElement);
            });
        }

        // Create session element
        function createSessionElement(session, index) {
            const sessionDiv = document.createElement('div');
            sessionDiv.className = 'session-row';

            const startTime = session.startTime ? new Date(session.startTime).toLocaleString() : 'Unknown';
            const duration = session.duration ? formatDuration(session.duration) : 'Unknown';
            const phaseCount = session.phases.length;

            sessionDiv.innerHTML = `
                <div class="session-compact" onclick="toggleSessionExpanded(${index})">
                    <div class="session-status ${session.status}"></div>
                    <div class="session-info">
                        <div class="session-time">${startTime}</div>
                        <div class="session-duration">${duration}</div>
                        <div class="session-phases">${phaseCount} phase${phaseCount !== 1 ? 's' : ''}</div>
                        <div class="session-pid">PID: ${session.pid}</div>
                        <button class="session-expand-btn" onclick="event.stopPropagation(); toggleSessionExpanded(${index})">
                            ⓘ
                        </button>
                    </div>
                </div>
                <div class="session-expanded" id="session-expanded-${index}">
                    ${createSessionExpandedContent(session)}
                </div>
            `;

            return sessionDiv;
        }

        // Create expanded session content
        function createSessionExpandedContent(session) {
            let html = `
                <div class="session-details">
                    <div class="detail-group">
                        <div class="detail-title">Session Information</div>
                        <div class="detail-item">
                            <span class="detail-label">Session ID:</span>
                            <span class="detail-value">${session.sessionId}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Process ID:</span>
                            <span class="detail-value">${session.pid}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Status:</span>
                            <span class="detail-value">${session.status}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Start Time:</span>
                            <span class="detail-value">${session.startTime ? new Date(session.startTime).toLocaleString() : 'Unknown'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">End Time:</span>
                            <span class="detail-value">${session.endTime ? new Date(session.endTime).toLocaleString() : 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Duration:</span>
                            <span class="detail-value">${session.duration ? formatDuration(session.duration) : 'N/A'}</span>
                        </div>
                    </div>
                    <div class="detail-group">
                        <div class="detail-title">Event Summary</div>
                        <div class="detail-item">
                            <span class="detail-label">Total Events:</span>
                            <span class="detail-value">${session.events.length}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Progress Events:</span>
                            <span class="detail-value">${session.phases.length}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Errors:</span>
                            <span class="detail-value">${session.errors.length}</span>
                        </div>
                    </div>
                </div>
            `;

            // Add phases if available
            if (session.phases.length > 0) {
                html += `
                    <div class="phases-list">
                        <div class="detail-title" style="margin-bottom: 1rem;">Execution Phases</div>
                        ${session.phases.map(phase => `
                            <div class="phase-item">
                                <div class="phase-header">
                                    <span class="phase-name">${phase.phase} - ${phase.step}</span>
                                    <span class="phase-time">${new Date(phase.timestamp).toLocaleTimeString()}</span>
                                </div>
                                <div class="phase-description">${phase.description}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Add chronological events timeline
            html += createEventsTimeline(session);

            return html;
        }

        // Toggle session expanded view
        function toggleSessionExpanded(index) {
            const expandedElement = document.getElementById(`session-expanded-${index}`);
            const expandBtn = document.querySelector(`#execution-sessions .session-row:nth-child(${index + 1}) .session-expand-btn`);
            
            if (expandedElement.classList.contains('visible')) {
                expandedElement.classList.remove('visible');
                expandBtn.classList.remove('expanded');
                expandBtn.textContent = 'ⓘ';
            } else {
                expandedElement.classList.add('visible');
                expandBtn.classList.add('expanded');
                expandBtn.textContent = '✕';
            }
        }

        // Create events timeline for session
        function createEventsTimeline(session) {
            // Sort events by timestamp (chronological order)
            const sortedEvents = [...session.events].sort((a, b) => {
                const timeA = new Date(a.timestamp).getTime();
                const timeB = new Date(b.timestamp).getTime();
                return timeA - timeB; // Chronological order
            });

            let html = `
                <div class="events-timeline">
                    <div class="timeline-header">
                        <div class="timeline-title">Event Timeline</div>
                        <div class="timeline-count">${sortedEvents.length} event${sortedEvents.length !== 1 ? 's' : ''} (chronological order)</div>
                    </div>
                    <div class="events-list">
            `;

            sortedEvents.forEach((event, index) => {
                const eventId = `${session.sessionId}-event-${index}`;
                html += createEventCard(event, eventId, index);
            });

            html += `
                    </div>
                </div>
            `;

            return html;
        }

        // Create individual event card
        function createEventCard(event, eventId, index) {
            const eventTime = new Date(event.timestamp);
            const timeString = eventTime.toLocaleTimeString();
            const eventDescription = getEventDescription(event);
            
            return `
                <div class="event-card">
                    <div class="event-compact" onclick="toggleEventExpanded('${eventId}')">
                        <div class="event-type-indicator ${event.eventType}"></div>
                        <div class="event-summary">
                            <div class="event-type">${event.eventType}</div>
                            <div class="event-description">${eventDescription}</div>
                            <div class="event-time">${timeString}</div>
                            <button class="event-expand-btn" onclick="event.stopPropagation(); toggleEventExpanded('${eventId}')">
                                ⓘ
                            </button>
                        </div>
                    </div>
                    <div class="event-expanded" id="event-expanded-${eventId}">
                        ${createEventExpandedContent(event, eventId)}
                    </div>
                </div>
            `;
        }

        // Get event description
        function getEventDescription(event) {
            if (event.metadata) {
                try {
                    const metadata = typeof event.metadata === 'string' ? JSON.parse(event.metadata) : event.metadata;
                    
                    // Handle child task events with child_task metadata
                    if (event.eventType.startsWith('CHILD_TASK') && metadata.child_task) {
                        const childTaskName = metadata.child_task;
                        switch (event.eventType) {
                            case 'CHILD_TASK_START':
                                return `Starting child task: ${childTaskName}`;
                            case 'CHILD_TASK_END':
                                return `Child task completed: ${childTaskName}`;
                            case 'CHILD_TASK_ERROR':
                                return `Child task failed: ${childTaskName}`;
                            default:
                                return `Child task event: ${childTaskName}`;
                        }
                    }
                    
                    if (metadata.phase && metadata.step) {
                        return `${metadata.phase} - ${metadata.step}`;
                    }
                    if (metadata.description) {
                        return metadata.description;
                    }
                    if (metadata.error_message) {
                        return metadata.error_message;
                    }
                } catch (e) {
                    // If metadata parsing fails, continue to fallback
                }
            }
            
            // Fallback descriptions based on event type
            switch (event.eventType) {
                case 'TASK_START':
                    return 'Task execution started';
                case 'TASK_END':
                    return 'Task execution completed';
                case 'TASK_ERROR':
                    return 'Task execution failed';
                case 'PROGRESS':
                    return 'Progress update';
                case 'CHILD_TASK_START':
                    return 'Child task started';
                case 'CHILD_TASK_END':
                    return 'Child task completed';
                case 'CHILD_TASK_ERROR':
                    return 'Child task error reported';
                default:
                    return 'Event occurred';
            }
        }

        // Create expanded event content
        function createEventExpandedContent(event, eventId) {
            const eventTime = new Date(event.timestamp);
            
            let html = `
                <div class="event-details">
                    <div class="event-detail-group">
                        <div class="event-detail-title">Event Information</div>
                        <div class="event-detail-item">
                            <span class="event-detail-label">Type:</span>
                            <span class="event-detail-value">${event.eventType}</span>
                        </div>
                        <div class="event-detail-item">
                            <span class="event-detail-label">Timestamp:</span>
                            <span class="event-detail-value">${eventTime.toLocaleString()}</span>
                        </div>
                        <div class="event-detail-item">
                            <span class="event-detail-label">Task Name:</span>
                            <span class="event-detail-value">${event.taskName}</span>
                        </div>
                        <div class="event-detail-item">
                            <span class="event-detail-label">PID:</span>
                            <span class="event-detail-value">${event.pid}</span>
                        </div>
                    </div>
                    <div class="event-detail-group">
                        <div class="event-detail-title">Technical Details</div>
                        <div class="event-detail-item">
                            <span class="event-detail-label">Session ID:</span>
                            <span class="event-detail-value">${event.sessionId || 'N/A'}</span>
                        </div>
                        <div class="event-detail-item">
                            <span class="event-detail-label">Source:</span>
                            <span class="event-detail-value">${event.source || 'structured_logging'}</span>
                        </div>
                    </div>
                </div>
            `;

            // Add metadata if available
            if (event.metadata) {
                let metadataDisplay = '';
                try {
                    const metadata = typeof event.metadata === 'string' ? JSON.parse(event.metadata) : event.metadata;
                    metadataDisplay = JSON.stringify(metadata, null, 2);
                } catch (e) {
                    metadataDisplay = event.metadata.toString();
                }
                
                html += `
                    <div class="event-metadata">
                        <div class="event-detail-title">Event Metadata</div>
                        <div class="metadata-content">${metadataDisplay}</div>
                    </div>
                `;
            }

            // Add raw data toggle
            html += `
                <button class="raw-data-toggle" onclick="toggleEventRawData('${eventId}')">
                    Show Raw Event Data
                </button>
                <div class="raw-data" id="raw-data-${eventId}">
                    <div class="raw-data-header">
                        Raw JSON Event Data
                    </div>
                    ${JSON.stringify(event, null, 2)}
                </div>
            `;

            return html;
        }

        // Toggle event expanded view
        function toggleEventExpanded(eventId) {
            const expandedElement = document.getElementById(`event-expanded-${eventId}`);
            const expandBtn = document.querySelector(`[onclick*="toggleEventExpanded('${eventId}')"] .event-expand-btn`);
            
            if (expandedElement.classList.contains('visible')) {
                expandedElement.classList.remove('visible');
                if (expandBtn) {
                    expandBtn.classList.remove('expanded');
                    expandBtn.textContent = 'ⓘ';
                }
            } else {
                expandedElement.classList.add('visible');
                if (expandBtn) {
                    expandBtn.classList.add('expanded');
                    expandBtn.textContent = '✕';
                }
            }
        }

        // Toggle event raw data
        function toggleEventRawData(eventId) {
            const rawDataElement = document.getElementById(`raw-data-${eventId}`);
            const toggleBtn = rawDataElement.previousElementSibling;
            
            if (rawDataElement.classList.contains('visible')) {
                rawDataElement.classList.remove('visible');
                toggleBtn.classList.remove('active');
                toggleBtn.textContent = 'Show Raw Event Data';
            } else {
                rawDataElement.classList.add('visible');
                toggleBtn.classList.add('active');
                toggleBtn.textContent = 'Hide Raw Event Data';
            }
        }

        // Setup raw events toggle
        function setupRawEventsToggle(rawEvents) {
            const toggleBtn = document.getElementById('raw-events-toggle');
            const container = document.getElementById('raw-events-container');
            const content = document.getElementById('raw-events-content');
            const header = document.getElementById('raw-events-header');

            toggleBtn.addEventListener('click', () => {
                if (container.style.display === 'none') {
                    // Show raw events
                    if (rawEvents.available) {
                        header.textContent = `Raw Events Data (${rawEvents.taskLines} events found, equivalent to: cat events.jsonl | grep "${taskName}")`;
                        content.textContent = rawEvents.events.map(event => event.raw).join('\n');
                        content.classList.add('visible');
                    } else {
                        header.textContent = 'Raw Events Data Unavailable';
                        content.textContent = `Reason: ${rawEvents.reason}`;
                        content.classList.add('visible');
                    }
                    
                    container.style.display = 'block';
                    toggleBtn.textContent = 'Hide Raw Events';
                    toggleBtn.classList.add('active');
                } else {
                    // Hide raw events
                    container.style.display = 'none';
                    toggleBtn.textContent = 'Show Raw Events';
                    toggleBtn.classList.remove('active');
                    content.classList.remove('visible');
                }
            });
        }

        // Format duration
        function formatDuration(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);

            if (hours > 0) {
                return `${hours}h ${minutes % 60}m ${seconds % 60}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds % 60}s`;
            } else {
                return `${seconds}s`;
            }
        }

        // Display error message
        function displayError(message) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = `<div class="error">${message}</div>`;
            errorContainer.style.display = 'block';
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('task-content').style.display = 'none';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Load header
            try {
                const headerResponse = await fetch('/components/header/header.html');
                if (headerResponse.ok) {
                    const headerHTML = await headerResponse.text();
                    document.getElementById('header-placeholder').innerHTML = headerHTML;
                    
                    // Load header script
                    const script = document.createElement('script');
                    script.src = '/components/header/header.js';
                    document.head.appendChild(script);
                }
            } catch (error) {
                console.error('Error loading header:', error);
            }

            // Load task data
            await loadTaskData();
        });
    </script>
</body>
</html>
